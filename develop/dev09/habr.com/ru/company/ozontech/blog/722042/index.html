<!DOCTYPE html>
<html lang="ru" class="no-js">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta content='width=1024' name='viewport'>
<title>Через реки, через лес прямо к PowerDNS / Блог компании Ozon Tech / Хабр</title>

  <meta name="description" content="Всем привет! Меня зовут Максим, я руководитель одной из групп эксплуатации инфраструктурных сервисов в Ozon. Наша команда занимается поддержкой и развитием нескольких базовых сервисов компании, одним..." />

  <meta name="keywords" content="ozon tech, dns, edns, powerdns, bgp, postgresql, maintenance, recursor, multi-dc, high availability" />

  <meta property="fb:app_id" content="444736788986613" />
<meta property="og:type" content="article" />
<meta property="fb:pages" content="472597926099084"/>
<meta property="og:url" content="https://habr.com/ru/company/ozontech/blog/722042/" />
<meta property="og:title" content="Через реки, через лес прямо к PowerDNS" />

    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/db3/6a7/d41/db36a7d411dacb3119f87a9d8e8480e5.jpg?v=1" />
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="630"/>
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/db3/6a7/d41/db36a7d411dacb3119f87a9d8e8480e5.jpg?v=1" />
    <meta name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/db3/6a7/d41/db36a7d411dacb3119f87a9d8e8480e5.jpg?v=1">
    <meta property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/db3/6a7/d41/db36a7d411dacb3119f87a9d8e8480e5.jpg?v=1">
      <meta property="vk:image"  content="https://habrastorage.org/getpro/habr/upload_files/db3/6a7/d41/db36a7d411dacb3119f87a9d8e8480e5.jpg&v=1" />
    <meta property="og:image" content="https://habr.com/share/publication/722042/a7f8bd65fada64457c74f70bdffa6a14/" />
    <link rel="image_src" href="https://habr.com/share/publication/722042/a7f8bd65fada64457c74f70bdffa6a14/" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/b94/aaf/432/b94aaf43270c9bbc03ba58d78b15eece.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/b94/aaf/432/b94aaf43270c9bbc03ba58d78b15eece.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/f4f/034/201/f4f034201f50923009cb9a5b0af026ba.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/f4f/034/201/f4f034201f50923009cb9a5b0af026ba.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/230/e5d/3d5/230e5d3d5e72bc2ca6fa3702a3edad01.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/230/e5d/3d5/230e5d3d5e72bc2ca6fa3702a3edad01.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/9ad/528/99e/9ad52899e9b439b9a9f20ead003f61fe.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/9ad/528/99e/9ad52899e9b439b9a9f20ead003f61fe.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/790/399/c16/790399c165b0f898fda2492f6fe765d0.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/790/399/c16/790399c165b0f898fda2492f6fe765d0.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/d35/956/5ce/d359565ced982a509e62b8834ffd9b68.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/d35/956/5ce/d359565ced982a509e62b8834ffd9b68.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/344/bb2/197/344bb2197e8900dbc801a15196966f56.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/344/bb2/197/344bb2197e8900dbc801a15196966f56.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/86d/f8b/bd1/86df8bbd19bc418b6f6a7598d5f6fc09.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/86d/f8b/bd1/86df8bbd19bc418b6f6a7598d5f6fc09.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/2a3/2d6/bbe/2a32d6bbe2ef8f2a16c136ed3e94a85f.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/2a3/2d6/bbe/2a32d6bbe2ef8f2a16c136ed3e94a85f.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/244/b00/23f/244b0023f47a2d5adef9a09e379853aa.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/244/b00/23f/244b0023f47a2d5adef9a09e379853aa.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/129/4e0/790/1294e07903a542c3805ba21c832b7016.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/129/4e0/790/1294e07903a542c3805ba21c832b7016.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/32d/8cf/3a7/32d8cf3a7ad918167662be9f2c1c0ea1.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/32d/8cf/3a7/32d8cf3a7ad918167662be9f2c1c0ea1.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/432/9ba/694/4329ba694de70f74d081387d69565eaa.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/432/9ba/694/4329ba694de70f74d081387d69565eaa.png" />
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/9d9/5b2/8dc/9d95b28dccff5ff8e1f9f3713bb9b1ec.png" />
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/9d9/5b2/8dc/9d95b28dccff5ff8e1f9f3713bb9b1ec.png" />

<meta property="aiturec:title" content="Через реки, через лес прямо к PowerDNS">
<meta property="aiturec:description" content="Всем привет! Меня зовут Максим, я руководитель одной из групп эксплуатации инфраструктурных сервисов в Ozon. Наша команда занимается поддержкой и развитием неско...">
<meta property="aiturec:item_id" content="722042">
<meta property="aiturec:datetime" content="2023-03-15T13:36:21+03:00">

<meta property="og:description" content="Всем привет! Меня зовут Максим, я руководитель одной из групп эксплуатации инфраструктурных сервисов в Ozon. Наша команда занимается поддержкой и развитием неско..." />
<meta name="twitter:description" content="Всем привет! Меня зовут Максим, я руководитель одной из групп эксплуатации инфраструктурных сервисов в Ozon. Наша команда занимается поддержкой и развитием неско...">
<meta name="twitter:title" content="Через реки, через лес прямо к PowerDNS" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@habr_com" />

  <meta property="al:android:url" content="habrahabr://post/722042" />
<meta property="al:android:app_name" content="Habrahabr" />
<meta property="al:android:package" content="ru.habrahabr" />
<meta property="al:windows_phone:url" content="habrahabr://post/722042" />
<meta property="al:windows_phone:app_name" content="Habrahabr" />
<meta property="al:windows_phone:app_id" content="460a6bd6-8955-470f-935e-9ea1726a6060" />

  <link rel="canonical" href="https://habr.com/ru/company/ozontech/blog/722042/"/>
  <link rel="alternate" media="only screen and (max-width: 640px)" href="https://m.habr.com/ru/company/ozontech/blog/722042/" >
<link rel="amphtml" href="https://m.habr.com/ru/amp/post/722042/">

  <script type="application/ld+json">
    {
    "@context": "http:\/\/schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https:\/\/habr.com\/ru\/company\/ozontech\/blog\/722042\/"
    },
    "headline": "Через реки, через лес прямо к PowerDNS",
    "datePublished": "2023-03-15T13:36:21+03:00",
    "dateModified": "2023-03-15T14:52:33+03:00",
    "author": {
        "@type": "Person",
        "name": "makurus"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Habr",
        "logo": {
            "@type": "ImageObject",
            "url": "https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"
        }
    },
    "description": "Всем привет! Меня зовут Максим, я руководитель одной из групп эксплуатации инфраструктурных сервисов в Ozon. Наша команда занимается поддержкой и развитием неско...",
    "url": "https:\/\/habr.com\/ru\/company\/ozontech\/blog\/722042\/#post-content-body",
    "about": [
        "c_ozontech",
        "h_sys_admin",
        "h_it-infrastructure",
        "h_dns",
        "h_distributed_systems"
    ],
    "image": [
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/b94\/aaf\/432\/b94aaf43270c9bbc03ba58d78b15eece.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f4f\/034\/201\/f4f034201f50923009cb9a5b0af026ba.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/230\/e5d\/3d5\/230e5d3d5e72bc2ca6fa3702a3edad01.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/9ad\/528\/99e\/9ad52899e9b439b9a9f20ead003f61fe.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/790\/399\/c16\/790399c165b0f898fda2492f6fe765d0.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/d35\/956\/5ce\/d359565ced982a509e62b8834ffd9b68.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/344\/bb2\/197\/344bb2197e8900dbc801a15196966f56.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/86d\/f8b\/bd1\/86df8bbd19bc418b6f6a7598d5f6fc09.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/2a3\/2d6\/bbe\/2a32d6bbe2ef8f2a16c136ed3e94a85f.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/244\/b00\/23f\/244b0023f47a2d5adef9a09e379853aa.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/129\/4e0\/790\/1294e07903a542c3805ba21c832b7016.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/32d\/8cf\/3a7\/32d8cf3a7ad918167662be9f2c1c0ea1.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/432\/9ba\/694\/4329ba694de70f74d081387d69565eaa.png",
        "https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/9d9\/5b2\/8dc\/9d95b28dccff5ff8e1f9f3713bb9b1ec.png"
    ]
}
  </script>


<meta name='yandex-verification' content='71593b225aeafc4e' />
<meta name='referrer' content='unsafe-url' />
<meta name="pocket-site-verification" content="ed24b2b9721edf0a282c5b4a3232c4" />
<meta name="biu" content="https://dr.habracdn.net/habr/oldassets/6411ba2a/images/">

<style type="text/css">
  @font-face{font-family:'Fira Sans';font-style:normal;font-weight:500;src:url(https://dr.habracdn.net/habr/oldassets/6411ba2a/fonts/FiraSans/firaSans-medium.eot);src:local("Fira Sans Medium"),local("FiraSans-Medium"),url(https://dr.habracdn.net/habr/oldassets/6411ba2a/fonts/FiraSans/firaSans-medium.eot?#iefix) format("embedded-opentype"),url(https://dr.habracdn.net/habr/oldassets/6411ba2a/fonts/FiraSans/firaSans-medium.woff2) format("woff2"),url(https://dr.habracdn.net/habr/oldassets/6411ba2a/fonts/FiraSans/firaSans-medium.woff) format("woff"),url(https://dr.habracdn.net/habr/oldassets/6411ba2a/fonts/FiraSans/firaSans-medium.ttf) format("truetype")}
</style>

<link href="https://dr.habracdn.net/habr/oldassets/6411ba2a/styles/main.bundle.css" rel="stylesheet" media="all" />





<meta name='yandex-verification' content='67d46b975fa41645' />

<link rel="apple-touch-icon" sizes="180x180" href="https://dr.habracdn.net/habr/oldassets/6411ba2a/images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://dr.habracdn.net/habr/oldassets/6411ba2a/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://dr.habracdn.net/habr/oldassets/6411ba2a/images/favicon-16x16.png">
<link rel="manifest" href="https://dr.habracdn.net/habr/oldassets/6411ba2a/site.webmanifest">
<link rel="mask-icon" href="https://dr.habracdn.net/habr/oldassets/6411ba2a/images/safari-pinned-tab.svg" color="#77a2b6">
<meta name="application-name" content="Хабр"/>
<meta name="msapplication-TileColor" content="#77a2b6">
<meta name="theme-color" content="#77a2b6">


  <link title="Комментарии к публикации «Через реки, через лес прямо к PowerDNS»" type="application/rss+xml" rel="alternate" href="https://habr.com/ru/rss/post/722042/"/>

<script>/* Font Face Observer v2.0.13 - © Bram Stein. License: BSD-3-Clause */(function(){'use strict';var f,g=[];function l(a){g.push(a);1==g.length&&f()}function m(){for(;g.length;)g[0](),g.shift()}f=function(){setTimeout(m)};function n(a){this.a=p;this.b=void 0;this.f=[];var b=this;try{a(function(a){q(b,a)},function(a){r(b,a)})}catch(c){r(b,c)}}var p=2;function t(a){return new n(function(b,c){c(a)})}function u(a){return new n(function(b){b(a)})}function q(a,b){if(a.a==p){if(b==a)throw new TypeError;var c=!1;try{var d=b&&b.then;if(null!=b&&"object"==typeof b&&"function"==typeof d){d.call(b,function(b){c||q(a,b);c=!0},function(b){c||r(a,b);c=!0});return}}catch(e){c||r(a,e);return}a.a=0;a.b=b;v(a)}}
function r(a,b){if(a.a==p){if(b==a)throw new TypeError;a.a=1;a.b=b;v(a)}}function v(a){l(function(){if(a.a!=p)for(;a.f.length;){var b=a.f.shift(),c=b[0],d=b[1],e=b[2],b=b[3];try{0==a.a?"function"==typeof c?e(c.call(void 0,a.b)):e(a.b):1==a.a&&("function"==typeof d?e(d.call(void 0,a.b)):b(a.b))}catch(h){b(h)}}})}n.prototype.g=function(a){return this.c(void 0,a)};n.prototype.c=function(a,b){var c=this;return new n(function(d,e){c.f.push([a,b,d,e]);v(c)})};
function w(a){return new n(function(b,c){function d(c){return function(d){h[c]=d;e+=1;e==a.length&&b(h)}}var e=0,h=[];0==a.length&&b(h);for(var k=0;k<a.length;k+=1)u(a[k]).c(d(k),c)})}function x(a){return new n(function(b,c){for(var d=0;d<a.length;d+=1)u(a[d]).c(b,c)})};window.Promise||(window.Promise=n,window.Promise.resolve=u,window.Promise.reject=t,window.Promise.race=x,window.Promise.all=w,window.Promise.prototype.then=n.prototype.c,window.Promise.prototype["catch"]=n.prototype.g);}());

(function(){function l(a,b){document.addEventListener?a.addEventListener("scroll",b,!1):a.attachEvent("scroll",b)}function m(a){document.body?a():document.addEventListener?document.addEventListener("DOMContentLoaded",function c(){document.removeEventListener("DOMContentLoaded",c);a()}):document.attachEvent("onreadystatechange",function k(){if("interactive"==document.readyState||"complete"==document.readyState)document.detachEvent("onreadystatechange",k),a()})};function r(a){this.a=document.createElement("div");this.a.setAttribute("aria-hidden","true");this.a.appendChild(document.createTextNode(a));this.b=document.createElement("span");this.c=document.createElement("span");this.h=document.createElement("span");this.f=document.createElement("span");this.g=-1;this.b.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;";this.c.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;";
this.f.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;";this.h.style.cssText="display:inline-block;width:200%;height:200%;font-size:16px;max-width:none;";this.b.appendChild(this.h);this.c.appendChild(this.f);this.a.appendChild(this.b);this.a.appendChild(this.c)}
function t(a,b){a.a.style.cssText="max-width:none;min-width:20px;min-height:20px;display:inline-block;overflow:hidden;position:absolute;width:auto;margin:0;padding:0;top:-999px;white-space:nowrap;font-synthesis:none;font:"+b+";"}function y(a){var b=a.a.offsetWidth,c=b+100;a.f.style.width=c+"px";a.c.scrollLeft=c;a.b.scrollLeft=a.b.scrollWidth+100;return a.g!==b?(a.g=b,!0):!1}function z(a,b){function c(){var a=k;y(a)&&a.a.parentNode&&b(a.g)}var k=a;l(a.b,c);l(a.c,c);y(a)};function A(a,b){var c=b||{};this.family=a;this.style=c.style||"normal";this.weight=c.weight||"normal";this.stretch=c.stretch||"normal"}var B=null,C=null,E=null,F=null;function G(){if(null===C)if(J()&&/Apple/.test(window.navigator.vendor)){var a=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))(?:\.([0-9]+))/.exec(window.navigator.userAgent);C=!!a&&603>parseInt(a[1],10)}else C=!1;return C}function J(){null===F&&(F=!!document.fonts);return F}
function K(){if(null===E){var a=document.createElement("div");try{a.style.font="condensed 100px sans-serif"}catch(b){}E=""!==a.style.font}return E}function L(a,b){return[a.style,a.weight,K()?a.stretch:"","100px",b].join(" ")}
A.prototype.load=function(a,b){var c=this,k=a||"BESbswy",q=0,D=b||3E3,H=(new Date).getTime();return new Promise(function(a,b){if(J()&&!G()){var M=new Promise(function(a,b){function e(){(new Date).getTime()-H>=D?b():document.fonts.load(L(c,'"'+c.family+'"'),k).then(function(c){1<=c.length?a():setTimeout(e,25)},function(){b()})}e()}),N=new Promise(function(a,c){q=setTimeout(c,D)});Promise.race([N,M]).then(function(){clearTimeout(q);a(c)},function(){b(c)})}else m(function(){function u(){var b;if(b=-1!=
f&&-1!=g||-1!=f&&-1!=h||-1!=g&&-1!=h)(b=f!=g&&f!=h&&g!=h)||(null===B&&(b=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent),B=!!b&&(536>parseInt(b[1],10)||536===parseInt(b[1],10)&&11>=parseInt(b[2],10))),b=B&&(f==v&&g==v&&h==v||f==w&&g==w&&h==w||f==x&&g==x&&h==x)),b=!b;b&&(d.parentNode&&d.parentNode.removeChild(d),clearTimeout(q),a(c))}function I(){if((new Date).getTime()-H>=D)d.parentNode&&d.parentNode.removeChild(d),b(c);else{var a=document.hidden;if(!0===a||void 0===a)f=e.a.offsetWidth,
g=n.a.offsetWidth,h=p.a.offsetWidth,u();q=setTimeout(I,50)}}var e=new r(k),n=new r(k),p=new r(k),f=-1,g=-1,h=-1,v=-1,w=-1,x=-1,d=document.createElement("div");d.dir="ltr";t(e,L(c,"sans-serif"));t(n,L(c,"serif"));t(p,L(c,"monospace"));d.appendChild(e.a);d.appendChild(n.a);d.appendChild(p.a);document.body.appendChild(d);v=e.a.offsetWidth;w=n.a.offsetWidth;x=p.a.offsetWidth;I();z(e,function(a){f=a;u()});t(e,L(c,'"'+c.family+'",sans-serif'));z(n,function(a){g=a;u()});t(n,L(c,'"'+c.family+'",serif'));
z(p,function(a){h=a;u()});t(p,L(c,'"'+c.family+'",monospace'))})})};"object"===typeof module?module.exports=A:(window.FontFaceObserver=A,window.FontFaceObserver.prototype.load=A.prototype.load);}());

(function( w ){
if( w.document.documentElement.className.indexOf( "fonts-loaded" ) > -1 ){ return; }

var html = document.documentElement;
var FS500 = new w.FontFaceObserver("Fira Sans", { weight: 500 });

FS500.load().then(function() {
html.classList.add('fonts-loaded');
sessionStorage.fontsLoaded = true;
console.log('FS500-loaded');
}).catch(function () {
sessionStorage.fontsLoaded = false;
console.log('FS500-unloaded');
});

if (sessionStorage.fontsLoaded) {
html.classList.add('fonts-loaded');
}
}(this));
</script>
<script src="https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/libs/jquery-1.8.3.min.js"></script>
<script src="https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/libs/chance.min.js"></script>
<script src="https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/libs/html2canvas.min.js"></script>
<script>
  window.create_callback_for_blocked = function(key) {
    return function() {
      googletag.cmd.push(function () {
        googletag.display(key);
      });
    }
  }

  window.habr_blockers_checker = new function() {
    var result;
    var callbacksQueue = [];
    var calledOnce = false;

    function fireCallbacks() {
      callbacksQueue.forEach(function(callback) {
        callback(result);
      });
      callbacksQueue = [];
    }

    this.detect = function(imgUrl, callback) {
      var checksRemain = 2;
      var detected = false;
      var error1 = false;
      var error2 = false;

      if (typeof callback !== 'function') {
        return;
      };

      callbacksQueue.push(callback);

      if (typeof result !== 'undefined') {
        fireCallbacks();
      };

      if (calledOnce) {
        return;
      }
      calledOnce = true;

      imgUrl += '?ch=*&rn=*';

      function beforeCheck(timeout) {
        if (checksRemain === 0 || timeout > 1E3) {
          result = checksRemain === 0 && detected;
          fireCallbacks();
        } else {
          setTimeout(function() {
            beforeCheck(timeout * 2)
          }, timeout * 2);
        }
      }

      function checkImages() {
        if (--checksRemain) {
          return;
        };
        detected = !error1 && error2;
      }

      var random = Math.random() * 11;

      var img1 = new Image;
      img1.onload = checkImages;
      img1.onerror = function() {
        error1 = true;
        checkImages()
      };
      img1.src = imgUrl.replace(/\*/, 1).replace(/\*/, random);

      var img2 = new Image;
      img2.onload = checkImages;
      img2.onerror = function() {
        error2 = true;
        checkImages()
      };
      img2.src = imgUrl.replace(/\*/, 2).replace(/\*/, random);

      beforeCheck(250, callback)
    };

    this.detectWrapper = function(callback) {
      return this.detect('/images/px.gif', callback);
    };
  };

  window.display_dfp_slot = function(key) {
    if (window.habr_blockers_checker) {
      window.habr_blockers_checker.detectWrapper(window.create_callback_for_blocked(key));
    } else {
      window.create_callback_for_blocked(key)();
    }
  };
</script>


<script src="https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/libs/raven.min.js"></script>
<script>Raven.config('https://9d127adffe724363a380a189afcdb015@sentry.srv.habr.com/11', {
  maxBreadcrumbs: 50,
  sampleRate: 0.5,
  whitelistUrls: [/https?:\/\/((www)\.)?(m\.)?habr\.com/],
}).install()</script>

<script src="https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/_parts/advertise.js"></script>
<script src="https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/_parts/adriver.js"></script>


  </head>

  <body class="nl">

    <div class="layout">
      <div class="layout__row layout__row_services">
        <div id="TMpanel">
  <div class="container">
    <div class="logo-wrapper">
      <a href="https://habr.com/ru/" class="logo" title="">
          <svg width="62" height="24" viewBox="0 0 62 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M16.875 19L11.075 10.225L16.825 1.4H12.6L8.75 7.4L4.94999 1.4H0.574994L6.32499 10.15L0.524994 19H4.79999L8.64999 12.975L12.525 19H16.875Z" />
    <path d="M24.2607 5.775C20.8857 5.775 18.9607 7.625 18.6107 9.85H22.0107C22.2107 9.175 22.8607 8.6 24.1107 8.6C25.3357 8.6 26.2357 9.225 26.2357 10.425V11.025H23.4107C20.1107 11.025 18.1107 12.55 18.1107 15.2C18.1107 17.8 20.1107 19.3 22.6107 19.3C24.2857 19.3 25.6357 18.65 26.4357 17.6V19H29.8107V10.55C29.8107 7.4 27.5857 5.775 24.2607 5.775ZM23.6107 16.475C22.4857 16.475 21.7607 15.925 21.7607 15.025C21.7607 14.1 22.5607 13.55 23.6857 13.55H26.2357V14.125C26.2357 15.625 25.0107 16.475 23.6107 16.475Z" />
    <path d="M39.925 6.3C38.125 6.3 36.65 6.95 35.7 8.275C35.95 5.85 36.925 4.65 39.375 4.275L44.3 3.55V0.375L39.025 1.25C33.925 2.1 32.35 5.5 32.35 11.175C32.35 16.275 34.825 19.3 39.2 19.3C43.125 19.3 45.55 16.3 45.55 12.7C45.55 8.825 43.3 6.3 39.925 6.3ZM39.025 16.25C37.125 16.25 36.075 14.725 36.075 12.675C36.075 10.7 37.175 9.275 39.05 9.275C40.875 9.275 41.9 10.75 41.9 12.7C41.9 14.65 40.9 16.25 39.025 16.25Z" />
    <path d="M55.2855 5.775C53.3855 5.775 52.1605 6.6 51.5105 7.575V6.075H48.0105V23.775H51.6605V17.75C52.3105 18.65 53.5355 19.3 55.1855 19.3C58.3605 19.3 60.8855 16.8 60.8855 12.55C60.8855 8.225 58.3605 5.775 55.2855 5.775ZM54.4105 16.15C52.7105 16.15 51.5855 14.775 51.5855 12.6V12.5C51.5855 10.325 52.7105 8.925 54.4105 8.925C56.1105 8.925 57.2105 10.35 57.2105 12.55C57.2105 14.75 56.1105 16.15 54.4105 16.15Z" />
</svg>

      </a>
      

        <span class="projects-dropdown" id="dropdown-control">
          <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M5.70711 5.70711C5.31658 6.09763 4.68342 6.09763 4.29289 5.70711L0.292892 1.70711C-0.097632 1.31658 -0.0976319 0.683417 0.292892 0.292893C0.683417 -0.0976308 1.31658 -0.0976308 1.70711 0.292893L5 3.58579L8.29289 0.292894C8.68342 -0.0976301 9.31658 -0.0976301 9.70711 0.292894C10.0976 0.683418 10.0976 1.31658 9.70711 1.70711L5.70711 5.70711Z" />
</svg>

        </span>
        <div class="dropdown hidden" id="dropdown">
          <div class="dropdown-heading">
            Все сервисы Хабра
          </div>
          <a class="service" href="/">
            <div class="service-title">
              <svg width="52" height="22" viewBox="0 0 52 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.86 17.0001L8.514 9.23405L13.816 1.51205H11.528L7.26 7.76005L2.97 1.51205H0.659997L5.984 9.19005L0.615997 17.0001H2.926L7.194 10.6861L11.528 17.0001H13.86Z" fill="#333333"/>
                <path d="M20.181 5.67005C17.651 5.67005 16.111 7.10005 15.759 8.81605H17.585C17.893 8.00205 18.685 7.34205 20.137 7.34205C21.567 7.34205 22.645 8.11205 22.645 9.65205V10.4001H19.697C16.991 10.4001 15.341 11.6981 15.341 13.8321C15.341 15.9441 17.013 17.2421 19.169 17.2421C20.577 17.2421 21.897 16.7141 22.733 15.6801V17.0001H24.515V9.65205C24.515 7.16605 22.777 5.67005 20.181 5.67005ZM19.411 15.5921C18.179 15.5921 17.255 14.9761 17.255 13.8101C17.255 12.6221 18.289 12.0061 19.807 12.0061H22.645V12.8201C22.645 14.5141 21.171 15.5921 19.411 15.5921Z" fill="#333333"/>
                <path d="M32.9685 5.91205C31.2965 5.91205 29.9545 6.55005 29.1185 7.78205C29.3825 5.27405 30.3945 3.88805 32.9025 3.42605L36.9505 2.67805V0.852051L32.5065 1.75405C28.7665 2.52405 27.2045 4.96605 27.2045 10.5101C27.2045 14.8001 29.4045 17.2421 32.7925 17.2421C36.0265 17.2421 38.0505 14.7121 38.0505 11.5441C38.0505 7.91405 35.8285 5.91205 32.9685 5.91205ZM32.7045 15.5261C30.6145 15.5261 29.2065 13.9641 29.2065 11.4561C29.2065 8.97005 30.7685 7.60605 32.7265 7.60605C34.7725 7.60605 36.1145 9.23405 36.1145 11.5441C36.1145 13.8541 34.7945 15.5261 32.7045 15.5261Z" fill="#333333"/>
                <path d="M46.1431 5.67005C44.2291 5.67005 43.0631 6.55005 42.5131 7.49605V5.91205H40.6871V21.2021H42.5791V15.6361C43.1071 16.4501 44.2951 17.2421 46.0771 17.2421C48.6291 17.2421 51.1371 15.3721 51.1371 11.4561C51.1371 7.56205 48.6511 5.67005 46.1431 5.67005ZM45.9011 15.5261C43.8551 15.5261 42.5131 13.9641 42.5131 11.5001V11.4121C42.5131 8.94805 43.8551 7.38605 45.9011 7.38605C47.8811 7.38605 49.2011 9.03605 49.2011 11.4561C49.2011 13.8761 47.8811 15.5261 45.9011 15.5261Z" fill="#333333"/>
              </svg>
            </div>
            <p class="service-description">
              Сообщество IT-специалистов
            </p>
          </a>
          <a class="service" href="https://qna.habr.com?utm_source=habr&utm_medium=habr_top_panel">
            <h4 class="service-title">
            <svg width="46" height="18" viewBox="0 0 46 18" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14.4 8.25602C14.4 3.65802 11.606 0.27002 7.27201 0.27002C2.93801 0.27002 0.144012 3.65802 0.144012 8.25602C0.144012 12.854 2.93801 16.242 7.27201 16.242C8.41601 16.242 9.45001 16.022 10.352 15.604L11.518 17.342H13.696L11.848 14.614C13.476 13.184 14.4 10.918 14.4 8.25602ZM7.27201 14.416C4.10401 14.416 2.14601 11.864 2.14601 8.25602C2.14601 4.64802 4.10401 2.09602 7.27201 2.09602C10.44 2.09602 12.398 4.64802 12.398 8.25602C12.398 10.236 11.826 11.908 10.77 12.986L9.64801 11.314H7.47001L9.29601 14.02C8.70201 14.284 8.02001 14.416 7.27201 14.416Z" fill="#333333"/>
              <path d="M30.965 16L27.973 12.766L30.921 9.11402H28.699L26.829 11.534L23.331 7.77202C25.377 6.80402 26.455 5.59402 26.455 3.85602C26.455 1.78802 24.871 0.27002 22.583 0.27002C20.207 0.27002 18.535 1.89802 18.535 3.87802C18.535 5.19802 19.305 6.12202 20.163 7.00202L20.427 7.26602C17.985 8.25602 16.753 9.73002 16.753 11.732C16.753 14.196 18.667 16.242 21.835 16.242C23.749 16.242 25.311 15.494 26.565 14.24L26.763 14.042L28.567 16H30.965ZM22.539 1.92002C23.705 1.92002 24.629 2.62402 24.629 3.83402C24.629 5.00002 23.793 5.90202 22.187 6.62802L21.571 6.01202C21.109 5.55002 20.405 4.82402 20.405 3.81202C20.405 2.66802 21.329 1.92002 22.539 1.92002ZM21.945 14.504C19.877 14.504 18.755 13.316 18.755 11.666C18.755 10.258 19.591 9.20202 21.593 8.43202L25.641 12.832L25.509 12.964C24.541 13.976 23.309 14.504 21.945 14.504Z" fill="#333333"/>
              <path d="M43.5619 16H45.6739L39.8219 0.512019H37.7979L31.9459 16H34.0579L35.5539 11.908H42.0439L43.5619 16ZM38.7879 2.97602L41.3839 10.104H36.2139L38.7879 2.97602Z" fill="#333333"/>
            </svg>
            </h4>
            <p class="service-description">
              Ответы на&nbsp;любые вопросы об&nbsp;IT
            </p>
          </a>
          <a class="service" href="https://career.habr.com?utm_source=habr&utm_medium=habr_top_panel">
            <div class="service-title">
            <svg width="84" height="21" viewBox="0 0 84 21" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12.442 16L4.96201 7.92596L12.31 0.511963H9.78001L2.894 7.41996V0.511963H0.936005V16H2.894V8.60796L9.84601 16H12.442Z" fill="#333333"/>
              <path d="M18.3646 4.66996C15.8346 4.66996 14.2946 6.09996 13.9426 7.81596H15.7686C16.0766 7.00196 16.8686 6.34196 18.3206 6.34196C19.7506 6.34196 20.8286 7.11196 20.8286 8.65196V9.39996H17.8806C15.1746 9.39996 13.5246 10.698 13.5246 12.832C13.5246 14.944 15.1966 16.242 17.3526 16.242C18.7606 16.242 20.0806 15.714 20.9166 14.68V16H22.6986V8.65196C22.6986 6.16596 20.9606 4.66996 18.3646 4.66996ZM17.5946 14.592C16.3626 14.592 15.4386 13.976 15.4386 12.81C15.4386 11.622 16.4726 11.006 17.9906 11.006H20.8286V11.82C20.8286 13.514 19.3546 14.592 17.5946 14.592Z" fill="#333333"/>
              <path d="M31.3501 4.66996C29.4361 4.66996 28.2701 5.54996 27.7201 6.49596V4.91196H25.8941V20.202H27.7861V14.636C28.3141 15.45 29.5021 16.242 31.2841 16.242C33.8361 16.242 36.3441 14.372 36.3441 10.456C36.3441 6.56196 33.8581 4.66996 31.3501 4.66996ZM31.1081 14.526C29.0621 14.526 27.7201 12.964 27.7201 10.5V10.412C27.7201 7.94796 29.0621 6.38596 31.1081 6.38596C33.0881 6.38596 34.4081 8.03596 34.4081 10.456C34.4081 12.876 33.0881 14.526 31.1081 14.526Z" fill="#333333"/>
              <path d="M43.3561 8.49796H40.8701V4.91196H38.9781V16H43.3341C45.7101 16 47.2501 14.372 47.2501 12.216C47.2501 10.06 45.7101 8.49796 43.3561 8.49796ZM43.1141 14.328H40.8701V10.17H43.1141C44.5661 10.17 45.3581 11.028 45.3581 12.216C45.3581 13.404 44.5661 14.328 43.1141 14.328Z" fill="#333333"/>
              <path d="M59.1788 11.028V10.06C59.1788 6.75996 57.2868 4.66996 54.3388 4.66996C51.3028 4.66996 49.1248 6.86996 49.1248 10.456C49.1248 14.02 51.2808 16.242 54.4928 16.242C57.3748 16.242 58.7608 14.438 59.0468 13.14H57.1328C56.9348 13.712 56.0548 14.548 54.5148 14.548C52.4688 14.548 51.1048 13.052 51.1048 11.072V11.028H59.1788ZM54.2948 6.36396C56.0768 6.36396 57.1768 7.50796 57.2648 9.42196H51.1268C51.2808 7.59596 52.4468 6.36396 54.2948 6.36396Z" fill="#333333"/>
              <path d="M67.272 4.66996C65.358 4.66996 64.192 5.54996 63.642 6.49596V4.91196H61.816V20.202H63.708V14.636C64.236 15.45 65.424 16.242 67.206 16.242C69.758 16.242 72.266 14.372 72.266 10.456C72.266 6.56196 69.78 4.66996 67.272 4.66996ZM67.03 14.526C64.984 14.526 63.642 12.964 63.642 10.5V10.412C63.642 7.94796 64.984 6.38596 67.03 6.38596C69.01 6.38596 70.33 8.03596 70.33 10.456C70.33 12.876 69.01 14.526 67.03 14.526Z" fill="#333333"/>
              <path d="M79.058 4.66996C76.528 4.66996 74.988 6.09996 74.636 7.81596H76.462C76.77 7.00196 77.562 6.34196 79.014 6.34196C80.444 6.34196 81.522 7.11196 81.522 8.65196V9.39996H78.574C75.868 9.39996 74.218 10.698 74.218 12.832C74.218 14.944 75.89 16.242 78.046 16.242C79.454 16.242 80.774 15.714 81.61 14.68V16H83.392V8.65196C83.392 6.16596 81.654 4.66996 79.058 4.66996ZM78.288 14.592C77.056 14.592 76.132 13.976 76.132 12.81C76.132 11.622 77.166 11.006 78.684 11.006H81.522V11.82C81.522 13.514 80.048 14.592 78.288 14.592Z" fill="#333333"/>
            </svg>
            </div>
            <p class="service-description">
              Профессиональное развитие в&nbsp;IT
            </p>
          </a>
          <a class="service" href="https://freelance.habr.com?utm_source=habr&utm_medium=habr_top_panel">
            <div class="service-title">
            <svg width="91" height="21" viewBox="0 0 91 21" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9.032 1.65602V0.0720215H7.118V1.65602C3.268 1.72202 0.0339966 4.01002 0.0339966 8.16802C0.0339966 12.304 3.268 14.592 7.118 14.658V16.242H9.032V14.658C12.882 14.592 16.116 12.304 16.116 8.16802C16.116 4.01002 12.882 1.72202 9.032 1.65602ZM7.118 12.898C4.082 12.832 2.014 11.05 2.014 8.16802C2.014 5.26402 4.082 3.48202 7.118 3.41602V12.898ZM9.032 12.898V3.41602C12.068 3.48202 14.136 5.26402 14.136 8.16802C14.136 11.05 12.068 12.832 9.032 12.898Z" fill="#333333"/>
              <path d="M24.2603 4.67002C22.3463 4.67002 21.1803 5.55002 20.6303 6.49602V4.91202H18.8043V20.202H20.6963V14.636C21.2243 15.45 22.4123 16.242 24.1943 16.242C26.7463 16.242 29.2543 14.372 29.2543 10.456C29.2543 6.56202 26.7683 4.67002 24.2603 4.67002ZM24.0183 14.526C21.9723 14.526 20.6303 12.964 20.6303 10.5V10.412C20.6303 7.94802 21.9723 6.38602 24.0183 6.38602C25.9983 6.38602 27.3183 8.03602 27.3183 10.456C27.3183 12.876 25.9983 14.526 24.0183 14.526Z" fill="#333333"/>
              <path d="M39.4123 4.91202L33.7583 13.074V4.91202H31.8883V16H33.7583L39.4123 7.83802V16H41.2823V4.91202H39.4123Z" fill="#333333"/>
              <path d="M46.0815 4.91202L45.5095 11.71C45.3555 13.624 44.9595 14.328 43.5735 14.328H43.2655V16.044H43.7935C46.0595 16.044 47.0935 14.856 47.3355 11.842L47.7755 6.60602H51.8455V16H53.7375V4.91202H46.0815Z" fill="#333333"/>
              <path d="M61.2045 4.67002C58.6745 4.67002 57.1345 6.10002 56.7825 7.81602H58.6085C58.9165 7.00202 59.7085 6.34202 61.1605 6.34202C62.5905 6.34202 63.6685 7.11202 63.6685 8.65202V9.40002H60.7205C58.0145 9.40002 56.3645 10.698 56.3645 12.832C56.3645 14.944 58.0365 16.242 60.1925 16.242C61.6005 16.242 62.9205 15.714 63.7565 14.68V16H65.5385V8.65202C65.5385 6.16602 63.8005 4.67002 61.2045 4.67002ZM60.4345 14.592C59.2025 14.592 58.2785 13.976 58.2785 12.81C58.2785 11.622 59.3125 11.006 60.8305 11.006H63.6685V11.82C63.6685 13.514 62.1945 14.592 60.4345 14.592Z" fill="#333333"/>
              <path d="M76.104 4.91202V9.37802H70.626V4.91202H68.734V16H70.626V11.094H76.104V16H77.996V4.91202H76.104Z" fill="#333333"/>
              <path d="M85.9003 14.526C83.8983 14.526 82.5783 12.876 82.5783 10.456C82.5783 8.05802 83.8543 6.38602 85.8783 6.38602C87.6383 6.38602 88.4523 7.53002 88.7383 8.45402H90.6303C90.3443 6.69402 88.8263 4.67002 85.8783 4.67002C82.6883 4.67002 80.6423 7.13402 80.6423 10.456C80.6423 13.844 82.7323 16.242 85.8783 16.242C88.6283 16.242 90.3883 14.394 90.6303 12.414H88.7383C88.4963 13.36 87.7483 14.526 85.9003 14.526Z" fill="#333333"/>
            </svg>
            </div>
            <p class="service-description">
              Удаленная работа для IT-специалистов
            </p>
          </a>
        </div>
    </div>
    <div class="bmenu">
      <a
        class="bmenu__conversion"
        href="https://habr.com/sandbox/start/"
        onclick="if (typeof ga === 'function') { ga('send', 'event', 'habr_top_panel', 'become_an_author'); }"
      >Как стать автором</a>

      <a
        id="feature-effect"
        class="bmenu__theme"
        style="display: none;"
        target="_blank"
      >
        <img alt="" width="20" style="position:relative; vertical-align: middle; top: -2px; margin-right: 4px;" />
        <span class="bmenu__text"></span>
      </a>
    </div>

      <div id="megapost-head-effect" class="bmenu_inner" style="display:flex!important;visibility:visible!important;">
  <span class="bmenu slink">
  </span>
</div>

  </div>
</div>

<script>
  var dropdown = document.querySelector('#dropdown');
  var dropdownControl = document.querySelector('#dropdown-control');
  var logoWrapper = document.querySelector('.logo-wrapper');

  document.addEventListener('click', function(e) {
      if (dropdown) {
        var isClickInside = logoWrapper.contains(e.target);
        var dropdownClosed = dropdown.classList.contains('hidden');
        if (!isClickInside && !dropdownClosed) {
          dropdown.classList.add('hidden');
          dropdownControl.classList.remove('reverted');
        }
      }
  });
  if (dropdownControl) {
    dropdownControl.onclick = function () {
      dropdown.classList.toggle('hidden');
      dropdownControl.classList.toggle('reverted');
    }
  }
</script>

      </div>

      <div class="layout__row layout__row_navbar">
        <div class="layout__cell">
          <div class="main-navbar">
  <div class="main-navbar__section main-navbar__section_left">
    <ul class="nav-links" id="navbar-links">
    <li class="nav-links__item">
      <a href="https://habr.com/ru/top/" class="nav-links__item-link ">Все потоки</a>
    </li>
    <li class="nav-links__item">
      <a href="https://habr.com/ru/flows/develop/" class="nav-links__item-link ">Разработка</a>
    </li>
    <li class="nav-links__item">
      <a href="https://habr.com/ru/flows/admin/" class="nav-links__item-link ">Администрирование</a>
    </li>
    <li class="nav-links__item">
      <a href="https://habr.com/ru/flows/design/" class="nav-links__item-link ">Дизайн</a>
    </li>
    <li class="nav-links__item">
      <a href="https://habr.com/ru/flows/management/" class="nav-links__item-link ">Менеджмент</a>
    </li>
    <li class="nav-links__item">
      <a href="https://habr.com/ru/flows/marketing/" class="nav-links__item-link ">Маркетинг</a>
    </li>
    <li class="nav-links__item">
      <a href="https://habr.com/ru/flows/popsci/" class="nav-links__item-link ">Научпоп</a>
    </li>
</ul>

    <form action="https://habr.com/ru/search/#h" method="get" class="search-form" id="search-form">
  <button type="button" class="btn btn_navbar_search icon-svg_search" id="search-form-btn" title="Поиск по сайту">
    <svg class="icon-svg" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M17 11C17 14.3137 14.3137 17 11 17C7.68629 17 5 14.3137 5 11C5 7.68629 7.68629 5 11 5C14.3137 5 17 7.68629 17 11ZM15.5838 17.5574C14.2857 18.4665 12.7051 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11C19 12.9998 18.2662 14.8282 17.0533 16.2307C17.0767 16.2502 17.0994 16.2709 17.1214 16.2929L20.4143 19.5858C20.8048 19.9763 20.8048 20.6095 20.4143 21C20.0238 21.3905 19.3906 21.3905 19.0001 21L15.7072 17.7071C15.6605 17.6604 15.6194 17.6102 15.5838 17.5574Z" />
</svg>

  </button>
  <label class="search-form__field-wrapper">
    <input type="text" name="q" class="search-form__field" id="search-form-field" placeholder="Поиск" tabindex="-1"/>
    <button type="button" class="btn btn_search-close" id="search-form-clear" title="Закрыть">
      <svg class="icon-svg icon-svg_navbar-close-search" width="31" height="32" viewBox="0 0 31 32" aria-hidden="true" version="1.1" role="img"><path d="M26.67 0L15.217 11.448 3.77 0 0 3.77l11.447 11.45L0 26.666l3.77 3.77L15.218 18.99l11.45 11.448 3.772-3.77-11.448-11.45L30.44 3.772z"/></svg>

    </button>
  </label>
</form>

  </div>

  <div class="main-navbar__section main-navbar__section_right">
      <button type="button" class="btn btn_medium btn_navbar_lang js-show_lang_settings">
        <svg class="icon-svg" width="18" height="18">
          <use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#globus-v2" />
        </svg>
      </button>
      <a href="https://habr.com/ru/auth/login/" id="login" class="btn btn_medium btn_navbar_login">Войти</a>
      <a href="https://habr.com/ru/auth/register/" class="btn btn_medium btn_navbar_registration">Регистрация</a>


  </div>
</div>

        </div>
      </div>

      <div class="layout__row layout__row_body">
        <div class="layout__cell layout__cell_body">
          
            
  
  
  
      <div class="page-header__banner">
      <a href="https://tech.ozon.ru/" target="_blank"><img src="//habrastorage.org/getpro/habr/branding/dc2/5b7/38f/dc25b738f6237ce587fc0485e20c87bb.jpg" alt="company_banner"/></a>
  </div>

  <div class="page-header_bordered page-header_tall">
    <div class="page-header page-header_full" id="company_5623">
  <div class="page-header_wrapper">
    <div class="media-obj media-obj_page-header">
        <a href="/company/ozontech/" class="media-obj__image page-header__image">
            <img src="//habrastorage.org/getpro/habr/company/4c8/542/883/4c8542883ef14a62b065425db4a6e6cf.jpg" width="48" height="48" class="company-info__image-pic"/>
        </a>

      <div class="media-obj__body media-obj__body_page-header">
        <div class="page-header__stats">
          <div class="page-header__stats-value">211,89</div>
          <div class="page-header__stats-label" title="Хабраиндекс - абстрактный показатель популярности компании на Хабре">Рейтинг</div>
        </div>
      </div>
    </div>

  </div>

  <div class="page-header__info">
      <a href="/company/ozontech/" class="page-header__info-title">Ozon Tech</a>
      <div class="page-header__info-desc">Стремимся делать лучший e-commerce в России</div>
  </div>
</div>

  </div>
  <div class="column-wrapper js-sticky-wrapper">
    <div class="content_left js-content_left">
      <div class="company_post">
        
    <article class="post post_full" id="post_722042" lang="ru">
  <div class="post__wrapper">
    <header class="post__meta">
        <a href="https://habr.com/ru/users/makurus/" class="post__user-info user-info" title="Автор публикации">
            <span class="default-image_mini default-image_pink">
              <svg class="icon-svg" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true" version="1.1" role="img"><path d="M21.5 24h-19c-1.379 0-2.5-1.122-2.5-2.5v-19c0-1.379 1.122-2.5 2.5-2.5h19c1.379 0 2.5 1.122 2.5 2.5v19c0 1.379-1.122 2.5-2.5 2.5zm-19-23c-.827 0-1.5.673-1.5 1.5v19c0 .827.673 1.5 1.5 1.5h19c.827 0 1.5-.673 1.5-1.5v-19c0-.827-.673-1.5-1.5-1.5h-19zM15.598 12.385zM19.438 15.417l-.002-.005v-.001c-.875-2.226-2.484-3.054-3.445-3.549l-.273-.143c.029-.497-.025-1.034-.167-1.599l-.128.032.123-.044c-.765-2.152-1.757-2.585-2.632-2.967l-.006-.003-.535-2.121c.357-.065.628-.375.628-.752.001-.423-.342-.765-.765-.765s-.766.342-.766.765c0 .358.248.657.581.74l-.825 1.654-.014-.003-.024-.003c-1.053-.033-1.842.369-2.5.947-.633-.322-1.515-.729-2.158-1.814.107-.12.174-.276.174-.45 0-.375-.303-.678-.678-.678s-.678.303-.678.678.303.678.678.678l.221-.04c.416.597 1.09 1.181 1.347 2.828l-.072.091.104.081-.112-.067c-1.157 1.914-.793 4.248.207 5.37-.998 2.546-1.035 4.681-.097 5.868l.002.002.003.003c.119.162.313.233.524.233.189 0 .39-.057.559-.154.312-.179.441-.459.326-.713l-.12.054.119-.056c-.581-1.243-.474-2.713.314-4.37.4.131.778.208 1.145.234l.139.73c.264 1.418.514 2.757 1.297 4.006.132.264.453.387.777.387.122 0 .245-.018.357-.051.385-.116.591-.399.537-.738l-.129.021.125-.042c-.204-.606-.431-1.146-.649-1.67-.373-.894-.725-1.742-.891-2.737.407-.042.797-.129 1.161-.261.825.692 1.661 1.492 2.743 3.406h.001c.072.14.224.215.41.215.105 0 .222-.024.339-.073.365-.155.652-.531.477-1.006v-.001c-.432-1.849-1.426-2.778-2.428-3.547.162-.175.311-.366.442-.576.75.399 1.878 1.005 3.127 2.766l.047.067.011-.008c.151.156.317.24.48.24.096 0 .191-.027.279-.084.306-.194.439-.662.29-1.005zm-8.878-2.493c-.947 0-1.713-.767-1.713-1.713s.767-1.713 1.713-1.713c.947 0 1.713.767 1.713 1.713s-.767 1.713-1.713 1.713zm6.587 4.648l-.084.021v-.001l.084-.02zm-2.007-5.312zm.022 1.006zM11.225 11.604c0 .385-.312.697-.697.697s-.697-.312-.697-.697c0-.385.312-.697.697-.697s.697.312.697.697z"/></svg>
            </span>
          <span class="user-info__nickname user-info__nickname_small">makurus</span>
        </a>
      <span class="post__time" data-time_published="2023-03-15T10:36Z">сегодня в 13:36</span>

      
    </header>

    <h1 class="post__title post__title_full">
      <span class="post__title-text">Через реки, через лес прямо к PowerDNS</span>
    </h1>


      <ul class="post__hubs post__hubs_full-post inline-list">
            <li class="inline-list__item inline-list__item_hub">
              <a href="https://habr.com/ru/company/ozontech/" class="inline-list__item-link hub-link " title="Вы не подписаны на этот хаб" onclick="if (typeof ga === 'function') { ga('send', 'event', 'hub', 'post page', 'Блог компании Ozon Tech'); }">Блог компании Ozon Tech</a>, 
            </li>
            <li class="inline-list__item inline-list__item_hub">
              <a href="https://habr.com/ru/hub/sys_admin/" class="inline-list__item-link hub-link " title="Вы не подписаны на этот хаб" onclick="if (typeof ga === 'function') { ga('send', 'event', 'hub', 'post page', 'Системное администрирование'); }">Системное администрирование</a>, 
            </li>
            <li class="inline-list__item inline-list__item_hub">
              <a href="https://habr.com/ru/hub/it-infrastructure/" class="inline-list__item-link hub-link " title="Вы не подписаны на этот хаб" onclick="if (typeof ga === 'function') { ga('send', 'event', 'hub', 'post page', 'IT-инфраструктура'); }">IT-инфраструктура</a>, 
            </li>
            <li class="inline-list__item inline-list__item_hub">
              <a href="https://habr.com/ru/hub/dns/" class="inline-list__item-link hub-link " title="Вы не подписаны на этот хаб" onclick="if (typeof ga === 'function') { ga('send', 'event', 'hub', 'post page', 'DNS'); }">DNS</a>, 
            </li>
            <li class="inline-list__item inline-list__item_hub">
              <a href="https://habr.com/ru/hub/distributed_systems/" class="inline-list__item-link hub-link " title="Вы не подписаны на этот хаб" onclick="if (typeof ga === 'function') { ga('send', 'event', 'hub', 'post page', 'Распределённые системы'); }">Распределённые системы</a>
            </li>
      </ul>

    <ul class="post__marks inline-list">
    <li class="inline-list__item inline-list__item_post-type">
      <span class="post__type-label" title="Туториал">Туториал</span>
    </li>
</ul>

    <div class="post__body post__body_full">
      <div class="post__text post__text_v2" id="post-content-body"><p>Всем привет! Меня зовут Максим, я руководитель одной из групп эксплуатации инфраструктурных сервисов в Ozon. Наша команда занимается поддержкой и развитием нескольких базовых сервисов компании, одним из которых, по историческим причинам, является сервис разрешения доменных имен (DNS).</p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/b94/aaf/432/b94aaf43270c9bbc03ba58d78b15eece.png" width="1920" height="1080"></figure><p>В Ozon много различных сервисов и систем. Они общаются друг с другом и внешним миром по доменным именам. DNS — центральное звено, без которого не обходится почти ни одна инфраструктура. Понятно, что когда DNS отдаёт некорректные данные, то это неприятно, когда таймаутит — плохо, когда прилёг — очень плохо, когда прилёг надолго — в принципе, можно расходиться. Значит, одна из основных задач команды инфраструктуры — обеспечить сервисам надёжное и, желательно, быстрое разрешение доменных имён. Об этом мы и поговорим. Также затронем вопросы управления ресурсными записями, жизнь в Multi DC-среде, обслуживание DNS, кеширование, журналирование запросов и возможные проблемы.</p><p>Статья может быть полезна коллегам, интересующимся эксплуатацией, архитектурой и высокой доступностью сервисов, да и просто может быть любопытна как история построения инфраструктурной единицы в крупной компании.</p><blockquote><p><em>Небольшое примечание: потребителями нашего инфраструктурного DNS будут внутренние клиенты компании (любой сервис во внутренней сети). Внешние зоны у нас, конечно же, есть, но, исторически, ими занимается команда NOC (сетевые инженеры), и передавать их в инфру пока не стремится. Поэтому мы ориентируемся только на внутренних клиентов. По этой же причине в статье не будем затрагивать DNSSEC и IPv6.</em></p></blockquote><details class="spoiler"><summary>Disclaimer</summary><div class="spoiler__content"><p><em>Любые совпадения имен машин и IP-адресов с реальными именами и ip случайны.</em></p></div></details><h2>Основная часть</h2><p>Так, а зачем нам вообще что-то менять, разве наш текущий инфраструктурный DNS ненадёжен? У меня вот есть три DNS-сервера в трёх ЦОДах, все они прописаны в resolv.conf каждого клиента, то есть если основной сервер прилёг, системный резолвер пойдёт во второй, а затем и в третий.</p><p>Дело в том, что в самом неудачном случае (когда остался доступен только третий ЦОД) и при дефолтных настройках резолвера (option timeout:5), последний nameserver ответит на запрос только по прошествии десяти секунд, что в микросервисной среде, когда один сервис взаимодействует с десятками других микросервисов и в коде нет кеширования DNS-запросов, просто недопустимо. Можно поиграть с уменьшенным таймаутом и другими опциями системного резолвера, но это не изменит картину принципиально. Тот же options rotate будет отправлять запросы на серверы из nameserver-списка по алгоритму round-robin (то есть по очереди), и 33 % запросов будут обработаны без таймаутов… ТОЛЬКО 33 %! Нам это не подходит.</p><blockquote><p><em>Зафиксируем первое требование: </em><strong><em>Не хотим полагаться на системный resolver.</em></strong>      </p></blockquote><p>Идём дальше. Думаю, многие слышали и, возможно, нередко используют “smart DNS resolver”. По сути, это легковесный DNS forwarder, который ставится на каждый хост. Его ключевой особенностью является функциональность отправки параллельных запросов сразу в несколько DNS-серверов и обработка ответа от самого быстрого из них. Достаточно интересно — получаем и отказоустойчивость, и максимальную скорость разрешения имён.</p><p><em>(Возможно, кому-то трафик x2,3,N может быть критичен, поэтому следует это учитывать в своей архитектуре.)</em></p><p>Для гомогенной среды (например, везде Linux) с единым центром управления (DNS контролирует одна команда инженеров) это вполне себе хорошее решение, и, что немаловажно, — простое.</p><p>Но, у нас не гомогенная среда (встречается Windows, немного, но есть), а также много инфраструктурных команд; придётся уговаривать каждую команду. К тому же при изменении адреса хотя бы одного DNS-сервера (например, при переезде машины в другой ЦОД), конфигурацию «smart DNS» нужно будет раскатить на тысячи машин… Тоже не подходит.</p><p>Вобщем, хочется более гибкого и универсального решения. Универсальное — это значит, что IP-адрес DNS-сервиса не должен меняться.</p><blockquote><p><em>Второе требование: </em><strong><em>DNS-сервис должен быть отказоустойчив на сетевом (IP не меняется) уровне (L3 OSI).</em></strong></p></blockquote><p>Получается, за одним IP-адресом нашего DNS-сервиса должно скрываться два и более реальных DNS-сервера. Давайте для краткости такой IP называть VIP-адресом (Virtual IP), реальный DNS-сервер — real (сервером), а пачку реальных DNS-серверов за VIP — пулом (pool)</p><p>Также в Ozon есть общее требование:</p><blockquote><p><strong><em>Сервис должен переживать полную недоступность одного ЦОД на любой период времени (мы называем это требование DC-1).</em></strong></p></blockquote><p>Что делать, если за VIP один из real-серверов «задумался» или «приказал долго жить»? По сути, мы попадём в ту же ситуацию, что и с системным resolver, когда некая доля DNS-запросов будет гарантировано не обслужена. Именно поэтому необходим механизм проверок (healthchecks) real-серверов с выкидыванием из пула «больных» и закидыванием обратно «здоровых».</p><blockquote><p><em>Следующее требование: </em><strong><em>Проверки (healthchecks) real-серверов со стороны VIP.</em></strong></p></blockquote><p>Мы будем успевать обрабатывать входящие запросы? Нагрузка на наш текущий DNS сервис весьма незначительна, всего 15-20 тыс. RPS, которую легко вывозит одна виртуалка, поэтому в эту сторону сильно не копаем. А с горизонтальным масштабированием и подавно вопрос «успевания» полностью закрыт. Оно у нас, скорее, для высокой доступности и возможности локализации трафика.</p><blockquote><p><em>Пятое требование: </em><strong><em>Уметь горизонтально масштабироваться</em></strong><em>.</em></p></blockquote><p>Раз уж у нас несколько ЦОД, стоит подумать и о сетевых задержках. Странно ходить в DNS из одного ЦОД в другой, когда под боком есть рабочий экземпляр DNS. Мы хотим, чтобы при наличии сервера в том же ЦОД сервисы ходили именно в него и получали ответ быстрее.</p><blockquote><p><em>Шестое требование: </em><strong><em>Уметь локализовывать трафик в пределах ЦОД</em></strong><em>.</em></p></blockquote><p>А что если мне захочется выполнить регламентное обслуживание сервера (обновить ОС, железо, другой деструктив)? Я могу остановить локальную DNS-службу, дождаться неудачных healthchecks, дождаться исключения сервера из пула и заняться обслуживанием. Но тогда все запросы после остановки локального DNS и вплоть до исключения сервера из пула завершатся ошибкой. Такое себе. Поэтому:</p><blockquote><p><em>Седьмое требование: </em><strong><em>Плавно выводить трафик с сервера, на котором проводим регламентные работы</em></strong><em>.</em></p></blockquote><p>DNS-сервер должен поддерживать динамическое обновление зон по протоколу DNS или API. Это нужно для различных систем наливки железных и виртуальных серверов (Foreman, MaaS, Terraform и т.д.).</p><blockquote><p><em>Восьмое требование: </em><strong><em>Поддержка динамически обновляемых зон</em></strong><em>.</em></p></blockquote><p>Далее, что насчёт IP-адреса клиента?</p><p>Очень желательно, я бы даже сказал, обязательно для поддержки и расследования инцидентов. А ещё это может пригодиться нам в будущем, например geo DNS прикрутить.</p><blockquote><p><em>Девятое требование: </em><strong><em>Должны видеть source IP источника запроса</em></strong><em>.</em></p></blockquote><p>Логирование DNS-запросов? Да, отдел информационной безопасности очень хочет. К тому же с логами debug куда проще и приятнее.</p><blockquote><p><em>Десятое требование: </em><strong><em>Уметь логировать DNS-запросы</em></strong><em>.</em></p></blockquote><p>В современном мире без мониторинга никуда, поэтому у DNS-сервиса должны иметься встроенные метрики. Прекрасно, если это будет формат Prometheus, потому что именно эту систему мониторинга мы используем в Ozon.</p><blockquote><p><em>Последнее требование: </em><strong><em>Наличие встроенных в DNS-сервис метрик</em></strong><em>.</em></p></blockquote><h3>Прикинем архитектуру</h3><p>По задумке путь прохождения клиентского DNS-запроса должен выглядеть так:</p><p><strong>Client (DNS-query) → LoadBalancer → Caching DNS → Authoritative DNS&nbsp;</strong></p><p>Конечно, все компоненты DNS (LoadBalancer, Caching DNS, Authoritative DNS) — должны быть зарезервированы, поэтому немного усложним схему дублирующими узлами.</p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/f4f/034/201/f4f034201f50923009cb9a5b0af026ba.png" width="1300" height="888"></figure><p>Машины LoadBalancer (LB) являются точками входа клиентского трафика. Напомню, что у них должен быть VIP — единый IP-адрес, на который LB будет откликаться. </p><h3>VIP (Virtual IP)</h3><p>На ум приходят две технологии: CARP/VRRP и динамическая маршрутизация (BGP). Давайте сравним:</p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/230/e5d/3d5/230e5d3d5e72bc2ca6fa3702a3edad01.png" width="1300" height="993"></figure><h3>LoadBalancer </h3><p>Если мы озаботились вопросом о healthchecks, то должен быть компонент в нашей инфраструктуре, который эти проверки запускает. Обычно таким компонентом является балансировщик (LoadBalancer, или LB). Из названия понятно, что его главная задача — балансировка, то есть распределение трафика между real-серверами. Кроме того, он, как правило, проверяет доступность этих real-серверов, и при необходимости убирает и добавляет их из пула (балансировки).&nbsp;</p><p>Тут мы выбирали из следующих вариантов:</p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/9ad/528/99e/9ad52899e9b439b9a9f20ead003f61fe.png" width="1705" height="1008"></figure><details class="spoiler"><summary>Немного про внутреннее устройство сети в Ozon:</summary><div class="spoiler__content"><p><em>Три ЦОД. В качестве физической сети, или underlay, выступает Layer 3 Network, в качестве overlay&nbsp; — BGP EVPN VXLAN. VLAN между ЦОД стараемся не тянуть, чтобы не увеличивать сложность обслуживания сети.</em></p></div></details><p>IPVS NAT mode обяжет нас возвращать ответ через тот же IPVS-шлюз, что уже непросто для real-сервера, если таких шлюзов больше одного. Усложняется debug.</p><p>IPVS DR mode завязан на L2-сегмент сети. И если не тянуть эти сегменты через VLAN, то «пошарить» real-серверы между ЦОД не получится.</p><p>IPVS IPIP — самый подходящий: благодаря GRE-туннелю трафик может быть проброшен в любую L3-сеть и отдан клиенту напрямую, минуя IPVS. Но, опять же, усложняется конфигурирование сети, debug и мониторинг.</p><p>Вывод: выбираем Userspace Layer7 LB как самый функциональный по возможностям и простой с точки зрения конфигурации сети.</p><h3>Про source IP клиента </h3><p>Обсудим способы, которыми можем выполнить требования записи IP-адреса каждого клиента в логи системы.</p><h4>EDNS Client Subnet (ECS)</h4><p>Принцип работы: модифицируем (если есть, и добавляем, если отсутствует) поле ECS в DNS-запросе, прописывая там source IP клиента. Поскольку записывается подсеть, для того, чтобы получить конкретный IP, нам нужна маска /32 (для IPv4). Добавлением поля ECS будет заниматься L7 LoadBalancer.</p><p>Недостаток в том, что это решение требует анализа и редактирования исходного запроса: балансировщик принимает DNS-запрос, разбирает его на Layer7 (OSI), принимает решение о модификации или добавлении поля ECS в запрос.&nbsp;</p><h4>X-Proxied-For (XPF)</h4><p>По сути, мета-RR (resource record), которая добавляется к запросу. Имеет <a href="https://datatracker.ietf.org/doc/draft-bellis-dnsop-xpf/"><u>экспериментальный статус, с истёкшим драфтом</u></a>.</p><p>Не рассматриваем это решение, потому что нам нужно надёжное и проверенное временем.&nbsp;</p><h4>Proxy Protocol (PROXYv2)</h4><p>Информация о начальных адресах и портах источника и получателя добавляется в header в начале UDP-датаграммы или TCP-соединения, аналогично тому, как это реализовано в nginx, <a href="https://www.haproxy.org/download/2.2/doc/proxy-protocol.txt"><u>Haproxy</u></a> и т.д.&nbsp;</p><p>Недостаток в том, что требуется поддержки в lb, resursor и auth.</p><p>Поддержка в PowerDNS: Dnsdist начиная с 1.5.0, recursor — с 4.4.0, auth — с 4.6.0.</p><p>В результате на момент выбора механизма передачи source IP клиента самым универсальным решением показался ECS. И так как проблем с производительностью на наших небольших объемах нет (15-20 тыс. RPS), мы остановились на нём.&nbsp;</p><p>Proxy protocol, честно говоря, пощупать тогда не удалось, не было нужных версий бинарей. Как бы там ни было, этот вариант выглядит вполне рабочим. Недавно руки дошли, протестировали, работает. Оставили его как вариант на будущее, если возможностей ECS перестанет хватать.</p><p>Подробнее про source ip от Dnsdist <a href="https://dnsdist.org/advanced/passing-source-address.html"><u>здесь</u></a> и <a href="https://ripe83.ripe.net/wp-content/uploads/presentations/10-DNS-proxyprotocol.pdf"><u>здесь</u></a>.&nbsp;</p><h3>Control Plane </h3><p>Для хранения RR раньше мы использовали PowerDNS + <a href="https://doc.powerdns.com/authoritative/backends/generic-postgresql.html">Generic PostgreSQL backend</a>.&nbsp;</p><p>Но после аварии (о которой я расскажу ниже) решили пересмотреть подход к хранению данных. Для динамически обновляемых зон (например, по протоколу <a href="https://datatracker.ietf.org/doc/html/rfc2136">DNS update</a>) можно оставить SQL-совместимый backend (тот же PostgreSQL), а для относительно редко меняющихся RR взять что-нибудь более статичное, например, <a href="https://doc.powerdns.com/authoritative/backends/bind.html">BIND zone backend</a>.&nbsp;</p><p>Для редактирования RR удобно пользоваться какой-нибудь готовой админкой, например, <a href="https://github.com/PowerDNS-Admin/PowerDNS-Admin"><u>PowerDNS-Admin</u></a>. Тяп-ляп и в production. К сожалению, использование таких инструментов несёт серьёзные риски, которые незаметны на первый взгляд. Мы начали с такого решения, что привело к плачевным последствиям: потере данных и простою на время восстановления. Подробнее об этом ниже.</p><p>Так или иначе, необходимо проработать более отказоустойчивое решение.&nbsp;</p><p>В нашей компании для доставки кода мы используем Gitlab. Почему бы не доставлять через него статику bind-zone? Подумаем.&nbsp;</p><h3>Обслуживание (Maintenance) </h3><p>При обслуживании любого компонента нашей архитектуры мы хотим плавно убирать с него нагрузку без влияния на клиентские запросы, и потом так же плавно возвращать. Другими словами, switchover.&nbsp;</p><p>Нам нужен признак, по наличию которого auth, recursor и сервис BGP-маршрутизации поймут, что им следует снять нагрузку. По опыту, самым простым признаком может быть наличие обычного файла: если он отсутствует — нормальный режим работы, присутствует — режим обслуживания (убираем нагрузку).</p><h3>Локализация трафика</h3><p>Тут всё просто. Anycast BGP перенаправляет клиента на ближайший LoadBalancer. который всегда находится в том же ЦОД, что и клиент (если анонс VIP поднят и нет специфичных настроек маршрутизации). Далее LoadBalancer отправляет DNS-запрос на локальный, заранее прописанный в конфиге Caching/Authoritative DNS, и только в случае его недоступности — на Caching/Authoritative DNS, находящийся в одном из соседних ЦОД.</p><h3>Подытожим нашу архитектуру&nbsp;</h3><p>Клиентский трафик заводится в три ЦОД через BGP anycast. Через <a href="https://en.wikipedia.org/wiki/Equal-cost_multi-path_routing">ECMP</a> попадает на несколько Layer7 LoadBalancer, далее перенаправляется на Caching DNS, и затем — на Authoritative DNS.&nbsp;</p><p>LoadBalancer живут на отдельных машинах (в нашем случае — виртуальных). Caching DNS и Authoritative DNS живут на одной виртуалке (VM).&nbsp;</p><p>С транспортным цехом (NOC, network operation center) договорились, что там, где будет настроена BGP-маршрутизация, будут жить только балансировщики.&nbsp;</p><p>Caching DNS и Authoritative DNS на одной машине — такая конструкция достаточно автономна, легко горизонтально масштабируется, нет лишних сетевых хопов.&nbsp;</p><p>Авторитативный DNS должен иметь два бэкенда: статичный, в котором нельзя удалить RR легким кликом мышки, и динамичный — для всякого рода DNS update (Foreman), редактирование через API (Terraform, MaaS).&nbsp;</p><p>Также должно быть управляющее ПО, через которое народ сможет вносить изменения (в RR) в бэкенды, описанные выше.&nbsp;</p><p>Нагрузка с машины LB снимается прекращением BGP-анонса VIP-адреса, с машины Caching/Authoritative DNS — неудачным healthcheck со стороны LB.&nbsp;</p><p>Failover: в случае проблем на одной из LB-машин BGP-анонс VIP-адреса прекращается, таблицы маршрутизации перестраиваются, клиенты идут на оставшиеся LB-машины.&nbsp;</p><p>В случае проблем с виртуальной машиной с Caching/Authoritative DNS балансировщик через healthchecks понимает это и переключает трафик на виртуалку Caching/Authoritative DNS в другом ЦОД.&nbsp;</p><p>Switchover: аналогично failover, но без отказа в обслуживании для клиента — нагрузка с машины LB снимается с помощью прекращения BGP-анонса VIP-адреса, с машины Caching/Authoritative DNS — неудачным healthcheck со стороны LB.&nbsp;</p><p>Мониторинг через Prometheus.&nbsp;</p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/790/399/c16/790399c165b0f898fda2492f6fe765d0.png" width="1656" height="1117"></figure><p>По сути, DNS — это такой же сервис, и перед выкаткой в production новая конфигурация должна быть протестирована на более терпимом к сбоям окружении. Таким окружением для PowerDNS, как и для наших микросервисов, является staging. Для максимального приближения к условиям в prod на PowerDNS кластер в staging-окружении также подаётся нагрузка. Это запросы сервисов из development- и staging-окружений. Таким образом, и по конфигу, и по данным, и по наличию трафика кластеры в production и staging почти идентичны. Разница только в конфигурации «железной» зоны (h.lan). Исторически сложилось, что у нас нет отдельной зоны для production, отдельной для staging и т.д. Все реальные имена машин изо всех окружений находятся в h.lan. Очевидно, что вносить изменения в «железную» зону мы обязаны через единый эндпоинт, которым является production. При этом изменения, прилетевшие в production, мы должны видеть и в staging PowerDNS. Связывать эти окружения БД-репликацией не очень хорошая идея, потому что реплика из staging легко может повлиять на prod, а вот обычная master → slave DNS-репликация (через <a href="https://www.rfc-editor.org/rfc/rfc5936">AXFR</a>) — то, что нужно.&nbsp;</p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/d35/956/5ce/d359565ced982a509e62b8834ffd9b68.png" width="1300" height="888"></figure><h2>Выбор программного обеспечения </h2><h4>Authoritative DNS и Caching DNS</h4><p>В качестве authoritative и caching DNS у нас уже использовался PowerDNS, поэтому в первую очередь смотрели на него.</p><p>PowerDNS Authoritative Server (или просто pdns auth) поддерживает различные SQL-базы, файлы bind zone, кучу других бэкендов, Lua-записи (это нам чуть позже пригодится), встроенные метрики для Prometheus и SNMP, имеет API для менеджмента RR и управления демоном.&nbsp;</p><p>PowerDNS Caching Server (или просто pdns recursor) — высокопроизводительный кеширующий DNS-сервер со встроенной поддержкой Lua-сценариев. Метрики тоже имеются.&nbsp;</p><h4>L7 LoadBalancer</h4><p>Долго искать не пришлось: оказывается, в PowerDNS обо всём уже подумали и завезли Dnsdist — балансировщик с защитой от DNS- и DoS-атак.&nbsp;</p><p>Справедливости ради попытались нагуглить другие альтернативы, но ничего даже отдалённо напоминающее Dnsdist не нашлось.&nbsp;</p><h4>BGP</h4><p>Кроме, собственно, BGP-сервиса нам нужны healthcheks, чтобы снять или вернуть нагрузку (убрать или вернуть анонс /32 префикса VIP), если что-то не так с интерфейсом, dnsdist, или если мы решили вывести машину на обслуживание.&nbsp;</p><p>Выбирали между:&nbsp;</p><ul><li><p><strong>ExaBGP</strong> — демоном на Python с поддержкой healthchecks, но без <a href="https://en.wikipedia.org/wiki/Bidirectional_Forwarding_Detection"><u>BFD</u></a>.</p></li><li><p><strong>BIRD</strong> — можно сказать, стандартом де-факто в индустрии. Есть встроенный BFD, но нет healthchecks, то есть все проверки придётся костылить сбоку.&nbsp;</p></li></ul><p>Из-за большой применимости и наличия встроенного BFD остановились на BIRD.&nbsp;</p><h4>Database &amp; database orchestrator</h4><p>Для редактирования RR PowerDNS требует SQL-совместимую БД. В нашей компании большая экспертиза в PostgreSQL, поэтому выбрали её. Также в качестве оркестратора поверх PostgreSQL мы используем Patroni, здесь выбор тоже очевиден.&nbsp;</p><h2>Кеширование в PowerDNS </h2><p>Если взять всю цепочку прохождения DNS-запроса — Dnsdist → PDNS Recursor → PDNS Auth, — то в сумме мы получим пять уровней, на которых запрос может быть закеширован. Пять, Карл!!! Понятно, что если мы включим их все, то навряд ли debug окажется лёгкой прогулкой.&nbsp;</p><p>Dnsdist:<a href="https://dnsdist.org/guides/cache.html"> <u>packet cache</u></a>.&nbsp;</p><p>PDNS Recursor:<a href="https://doc.powerdns.com/recursor/settings.html#packetcache-ttl"> <u>packet cache</u></a>,<a href="https://doc.powerdns.com/recursor/settings.html#max-cache-entries"> <u>query cache</u></a>.</p><p>PDNS Auth:<a href="https://doc.powerdns.com/authoritative/settings.html#cache-ttl"> <u>packet cache</u></a>,<a href="https://doc.powerdns.com/authoritative/settings.html#query-cache-ttl"> <u>query cache</u></a>.</p><p>Разница между кешами пакетов и запросов следующая.</p><p>В кеше пакетов лежат записи в виде уже сформированных ответов. То есть на идентичные запросы без какой-либо дополнительной обработки отдаём готовые ответы. Получается вроде <a href="https://dev.mysql.com/doc/refman/5.7/en/query-cache.html"><u>кеша запросов в MySQL</u></a>.&nbsp;</p><p>Query cache или record cache, — кеш внутренних запросов, сюда попадают отдельные записи, то есть ответы от бэкенда. Некоторые запросы приводят к ряду внутренних запросов, которые также попадут в query cache. Самый очевидный пример — когда запрос A-типа приводит к дополнительному запросу CNAME-типа.&nbsp;</p><p>TTL в ответе из packet cache не будет меняться, в то время как из query cache TTL честно будет уменьшаться на 1 с каждой секундой.&nbsp;</p><p>Что еще… <a href="https://doc.powerdns.com/authoritative/performance.html#packet-cache"><u>Packet cache</u></a> для всех ответов проставляет одинаковый TTL (packetcache-ttl), в то время как query cache ориентируется на TTL записи и может быть разным, но не более max-cache-ttl. Если используются бэкенды на основе ОЗУ (не требующие переключений контекста), то packet cache может быть даже вреден и лучше его отключить.&nbsp;</p><p>Оставляем максимум два кеша. Какие именно?&nbsp;</p><p>Dnsdist для нас — проксирующий узел, который должен просто передать пакет дальше, поэтому кеш здесь не используем.&nbsp;</p><p>PDNS Recursor — кеш запросов — да, кеш пакетов — нет. Простой синтетический тест показал, что packet cache на бэкенде bind-zone профита не дает. Поэтому выключим его в pdns, но включим с небольшим TTL query cache. Он нам нужен, чтобы не сильно мучить тяжелый SQL-бэкенд, но и слишком длительным по времени он тоже быть не должен (по крайней мере в нашем случае), чтобы healthcheck сквозь SQL-бэкенд был достаточно актуальным.&nbsp;</p><h2>Приступим к настройке </h2><h3>Dnsdist на LoadBalancer (LB) узле </h3><p>/etc/dnsdist/dnsdist.conf&nbsp; </p><details class="spoiler"><summary>Ключевые моменты</summary><div class="spoiler__content"><pre><code class="cpp">--- алгоритм выбора бэкенда для поступившего запроса
setServerPolicy(roundrobin)


--- backends
newServer({
    pool="current_dc",
      ...
})

newServer({
    pool="fallback_dc",
      ...
})</code></pre><p></p></div></details><details class="spoiler"><summary>Полный конфиг </summary><div class="spoiler__content"><pre><code class="cpp">--- добавляем в dns запрос source ip клиента - /32 чтобы сохранить весь ipv4 адрес
setECSSourcePrefixV4(32)

--- чтобы можно было подключится к работающему демону и что-нибудь с ним поделать
controlSocket("127.0.0.1:5199")
--- для безопасности
setKey("секретный_ключ")

--- webui для просмотра статистики в realtime 
webserver("0.0.0.0:8080")
setWebserverConfig({
  password="секретный_ключ_2",
  apiKey="",
  statsRequireAuthentication=false,
  acl="127.0.0.1, ::1, 10.0.0.0/8"
})

--- только чтение, нам нужны только метрики
setAPIWritable(false)

--- принимаем запросы на 53 порту на всех интерфейсах
setLocal("0.0.0.0:53")

--- политика выбора бэкенда для поступившего запроса
setServerPolicy(roundrobin)

  
--- backends. Для простоты оставим по одному бэкенду на ЦОД (1 в current_dc пуле, 2 в fallback_dc пуле)
newServer({
  --- адрес бэкенда
  address="10.0.0.1",
  --- имя бэкенда
  name="powerdns1",
  --- один из бэкендов пула "fallback_dc"
  pool="fallback_dc",
  --- проверка живости бэкенда
  checkClass=DNSClass.IN,
  checkName="status.backend.powerdns.lan.", 
  checkType="TXT",
  checkTimeout=2000,
  --- проверяем 3 раза
  maxCheckFailures=3,
  --- 3 секунды между попытками
  checkInterval=3,
  --- должны явно получить ответ, без ошибок
  mustResolve=true,
  --- добавляем ECS
  useClientSubnet=true,
  --- ждем 2 удачные попытки перед вводом бэкенда обратно в строй
  rise=2
})

newServer({
  address="10.0.0.2",
  name="powerdns2",
  pool="fallback_dc",
  checkClass=DNSClass.IN,
  checkName="status.backend.powerdns.lan.",
  checkType="TXT",
  checkTimeout=2000,
  maxCheckFailures=3,
  checkInterval=3,
  mustResolve=true,
  useClientSubnet=true,
  rise=2
})

newServer({
  address="10.0.0.3",
  name="powerdns3",
  pool="current_dc",
  checkClass=DNSClass.IN,
  checkName="status.backend.powerdns.lan.",
  checkType="TXT",
  checkTimeout=2000,
  maxCheckFailures=3,
  checkInterval=3,
  mustResolve=true,
  useClientSubnet=true,
  rise=2
})


--- если "current_dc" доступен (хотя бы один из его бэкендов), отправляем запросы в него
addAction(PoolAvailableRule("current_dc"), PoolAction("current_dc"))
--- если нет – отправляем запросы в "fallback_dc"
addAction(AllRule(), PoolAction("fallback_dc"))
</code></pre><p></p></div></details><p>Если настроить webserver, то можно посмотреть статистику по <a href="http://127.0.0.1:8080/"><u>http://127.0.0.1:8080</u></a>:</p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/344/bb2/197/344bb2197e8900dbc801a15196966f56.png" width="1846" height="811"></figure><details class="spoiler"><summary>Или её можно посмотреть из CLI:</summary><div class="spoiler__content"><pre><code class="cpp">lbdns1:~# echo "showServers()" | dnsdist -c 127.0.0.1:5100
#   Name                 Address            State     Qps    Qlim Ord Wt    Queries      Drops     Drate   Lat Outstanding Pools
0   powerdns1     10.0.0.1:53         up       0.0       0   1  1          0          0       0.0   0.0           0 fallback_dc
1   powerdns2     10.0.0.2:53         up       0.0       0   1  1     163994       3917       0.0   1.2           0 fallback_dc
2   powerdns3     10.0.0.3:53         up     971.8       0   1  1 5209759184  512719881      80.0  40.3        9603 current_dc
3   powerdns4     10.0.0.4:53         up     972.1       0   1  1 5261742931      17716       0.0  75.2          57 current_dc
4   powerdns5     10.0.0.5:53         up       0.0       0   1  1      23001          0       0.0   0.8           0 fallback_dc
5   powerdns6     10.0.0.6:53         up       0.0       0   1  1      23435          0       0.0   1.1           0 fallback_dc
All                                         1943.0                10471712545 512741514 
</code></pre><p></p></div></details><p>Что ещё, кроме балансировки, умеет dnsdist?&nbsp;</p><p>Отбрасывать неугодные по содержанию запросы, кешировать запросы, лимитировать клиентов по DNS query и по IP, использовать в качестве фильтра <a href="https://en.wikipedia.org/wiki/EBPF">eBPF</a> для максимальной производительности.&nbsp;</p><details class="spoiler"><summary>Если захотите включить packet cache в dnsdist:</summary><div class="spoiler__content"><pre><code class="cpp">pc = newPacketCache( 
  10000, --- записей в кэше 
    { 
    --- максимальный ttl 
    maxTTL=86400, 
    --- минимальный ttl для включения в кэш 
    minTTL=0, 
    --- кэшируем Server Failure or a Refused 
    temporaryFailureTTL=60, 
    ---  
    staleTTL=60, 
    dontAge=false 
  } 
) 
getPool(""):setCache(pc)
</code></pre><p></p></div></details><p>Кеш включается на каждый пул. “” — пул по умолчанию. А с помощью<a href="https://dnsdist.org/reference/tuning.html#setStaleCacheEntriesTTL"> <u>setStaleCacheEntriesTTL()</u></a> можно временно отдавать клиенту устаревший кеш, пока бэкенд не придёт в норму.&nbsp;</p><h3>BIRD на LoadBalancer узле</h3><p>Сообщаем наш VIP-адрес, а точнее маршрут к нему (обязательно с префиксом /32). Сам VIP будет висеть на dummy-интерфейсе, а анонс префикса /32 будет убираться и добавляться в BGP через удаление и добавление маршрута /32. Всё это будем делать скриптами под управлением monit.&nbsp;</p><details class="spoiler"><summary>/etc/bird/bird.conf </summary><div class="spoiler__content"><pre><code class="cpp">log syslog all;
router id 10.1.0.1;

filter z00_p32 {
  if net ~ [ 10.10.0.0/23{32,32} ] then accept;
  reject;
}

protocol device {
  debug { states,routes,filters,interfaces,events,packets };
}

protocol direct {
  disabled;
}

protocol kernel {
  learn;             # Learn all alien routes from the kernel
  persist;           # Don't remove routes on bird shutdown
  scan time 10;       # Scan kernel routing table every 2 seconds
  import filter z00_p32;
  export none;      # Export to protocol. default is export none
  graceful restart;  # Turn on graceful restart to reduce potential flaps in
}

template bgp bgp_template {
  debug { states,routes,filters,interfaces,events,packets };
  description "Connection to BGP peer";
  local as 4200000002;
  multihop;
  gateway recursive; # This should be the default, but just in case.
  add paths on;
  graceful restart;  # See comment in kernel section about graceful restart.
  connect delay time 2;
  connect retry time 5;
  error wait time 5,30;
  import none;
  # самое главное место
  export filter z00_p32;
  bfd on;
}
protocol bgp Node_10_1_1_1 from bgp_template {
  neighbor 10.1.1.1 as 4200000001;
  source address 10.1.0.1;
}
# bfd, чтобы быстрее детектить проблемы на сети
protocol bfd {
  interface "eth*" {
    min rx interval 100 ms;
    min tx interval 100 ms;
    idle tx interval 300 ms;
    multiplier 10;
  };
  multihop {
    interval 200 ms;
    multiplier 10;
  };
  import none;
  export filter z00_p32;
  neighbor 10.1.1.1 local 10.1.0.1 multihop;
}
</code></pre><p></p></div></details><h3>Monit на LoadBalancer узле </h3><p>Давайте настроим систему так, чтобы трафик снимался с машины, если мы не можем получить успешный ответ от локального Dnsdist, или когда инженер выполняет регламентные работы.&nbsp;</p><p>Алгоритм простой:&nbsp;</p><ol><li><p>Выполняем healthcheck (обычный DNS-запрос к локальному Dnsdist) и проверяем наличие файла /var/lib/vip0.down.</p></li><li><p>Снимаем анонс (удаляем маршрут к vip0), если результат healthcheck неуспешен или существует /var/lib/vip0.down.</p></li><li><p>Добавляем анонс (добавляем маршрут к vip0), если healthcheck успешен и отсутствует файл /var/lib/vip0.down.</p></li></ol><p>Скрипт проверки живости:&nbsp;&nbsp;</p><details class="spoiler"><summary>/usr/local/bin/dns_healthcheck_vip0.sh&nbsp;</summary><div class="spoiler__content"><pre><code class="cpp">#!/bin/bash

dummy_iface=vip0
announce_ip=10.50.0.1

check_record=status.backend.powerdns.lan.
check_type=TXT
check_content=\"up\"

# check1
if [ -e "/var/lib/${dummy_iface}.down" ]; then
  echo "file /var/lib/${dummy_iface}.down is exist"
  exit 1
fi

# check2
_result=$(dig +short +timeout=3 +tries=2 @127.0.0.1 -t ${check_type} ${check_record})
if [ "${_result}" != "${check_content}" ]; then
  echo "failed to check record ${check_record}"
  exit 22
fi

echo OK</code></pre><p></p></div></details><p>Снимаем анонс маршрута /32:&nbsp;</p><details class="spoiler"><summary>/usr/local/bin/bgp_withdraw_vip0.sh</summary><div class="spoiler__content"><pre><code class="cpp">#!/bin/bash

dummy_iface=vip0
announce_ip=10.50.0.1

_result=$(ip route show ${announce_ip})
if [ -n "${_result}" ]; then
  ip route delete ${announce_ip}/32 &amp;&amp; echo OK
else
  echo "NOTHING TO DO: route ${announce_ip}/32 not exists"
fi</code></pre><p></p></div></details><p>Возвращаем анонс маршрута /32: </p><details class="spoiler"><summary>/usr/local/bin/bgp_announce_vip0.sh </summary><div class="spoiler__content"><pre><code class="cpp">#!/bin/bash

check_vip () {
  iface=${1}
  ip=${2}
  if [[ "${ip}" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    ip -brief a | grep "^${iface} " | grep " ${ip}/32 " | grep -q -v " DOWN "
    e_code=$?
    if (( e_code != 0 )); then
      echo "Interface \"${iface}\" is not UP or IP \"${ip}\" is not match ip format"
      exit 0
    fi
  fi
}

check_maintenance () {
  if [ -e "/var/lib/${dummy_iface}.down" ]; then
    echo "file /var/lib/${dummy_iface}.down is exist"
    exit 0
  fi
}


dummy_iface=vip0
announce_ip=10.50.0.1

check_maintenance
check_vip ${dummy_iface} ${announce_ip}

_result=$(ip route show ${announce_ip})
if [ -z "${_result}" ]; then
  ip route add ${announce_ip}/32 dev ${dummy_iface} &amp;&amp; echo OK
else
  echo "NOTHING TO DO: route ${announce_ip}/32 already exists"
fi</code></pre><p></p></div></details><p>Осталось передать это всё под управление какого-нибудь супервизора. Старый добрый monit должен с этим справиться.&nbsp;</p><details class="spoiler"><summary>/etc/monit/monitrc</summary><div class="spoiler__content"><pre><code class="cpp">set daemon 10
set log /var/log/monit.log
set idfile /var/lib/monit/id
set statefile /var/lib/monit/state
set eventqueue
basedir /var/lib/monit/events
slots 100 
check program dns_healthcheck_vip0.sh
    with path /usr/local/bin/dns_healthcheck_vip0.sh
    with timeout 8 seconds
    if status != 0 for 3 cycles then
        exec /usr/local/bin/bgp_withdraw_vip0.sh
        repeat every 5 cycles
    if status == 0 for 2 cycles then
        exec /usr/local/bin/bgp_announce_vip0.sh
        repeat every 5 cycles</code></pre><p></p></div></details><h3>PDNS Recursor на узле PowerDNS</h3><p>Конфигурация рекурсора:</p><details class="spoiler"><summary>/etc/powerdns/recursor.conf 
</summary><div class="spoiler__content"><pre><code class="cpp">allow-from=0.0.0.0/0, 127.0.0.0/8, 10.0.0.0/8, 169.254.0.0/16, 192.168.0.0/16, 172.16.0.0/12, ::1/128, fc00::/7, fe80::/10
api-key=секретный_апи_кей
config-dir=/etc/powerdns
forward-zones-file=/etc/powerdns/recursor-forward.zones
hint-file=/usr/share/dns/root.hints
include-dir=/etc/powerdns/recursor.d
local-address=0.0.0.0
local-port=53
disable-packetcache=yes
#packetcache-ttl=5
#packetcache-servfail-ttl=5
max-cache-ttl=86400
max-negative-ttl=10
quiet=no
security-poll-suffix=
setgid=pdns
setuid=pdns
webserver=yes
webserver-address=0.0.0.0
webserver-password=вебсервер_пароль
webserver-port=8082
dnssec=off
# а здесь будем делать всякие интересные вещи, типа контролиовать maintenance режим и беспардонно модифицировать пролетающие запросы и ответы 
lua-dns-script=/etc/powerdns/recursor.lua.d/main.lua
lua-maintenance-interval=5
trace=fail
loglevel=5
ecs-ipv4-bits=32
use-incoming-edns-subnet=yes</code></pre><p></p></div></details><p>Для удобства объединяем все Lua-вставки в один файл:</p><details class="spoiler"><summary>/etc/powerdns/recursor.lua.d/main.lua</summary><div class="spoiler__content"><pre><code class="lua">function fileExists(file)
  local f = io.open(file, "rb")
  if f then
    f:close()
    return true
  end
  return false
end


dofile("/etc/powerdns/recursor.lua.d/maintenance.lua")
dofile("/etc/powerdns/recursor.lua.d/dns.lua")</code></pre><p></p></div></details><p>Далее рассмотрим код процедуры maintenance. Наличие файла включает режим обслуживания, отсутствие — выключает. Физически это заключается в проверке наличия файла и присвоении булевой переменной maintenanceState значения true или false.&nbsp;</p><details class="spoiler"><summary>/etc/powerdns/recursor.lua.d/dns.lua</summary><div class="spoiler__content"><pre><code class="lua">healthcheckSet = newDS()
healthcheckSet:add{"status.backend.powerdns.lan"}

function preresolve(dq)
  if healthcheckSet:check(dq.qname) then
    dq.variable = true                      -- disable packet cache. Это нужно если у вас ключен packet cache в recursor
    if maintenanceState == true then
      dq.rcode = pdns.NXDOMAIN
      return true;
    end
  end

  return false;
end</code></pre><p></p></div></details><details class="spoiler"><summary>Полный конфиг</summary><div class="spoiler__content"><pre><code class="lua">healthcheckSet = newDS()
healthcheckSet:add{"status.backend.powerdns.lan"}

backendname_request = "name.backend.powerdns.lan"
backendname_response = "\"powerdns1.lan\""

function preresolve(dq)
  if healthcheckSet:check(dq.qname) then
    dq.variable = true                      -- disable packet cache. Это нужно если у вас ключен packet cache в recursor
    if maintenanceState == true then
      dq.rcode = pdns.NXDOMAIN
      return true;
    end
  end

  if dq.qname:equal(backendname_request) then
    dq.variable = true                      -- disable packet cache
    dq.rcode=0                              -- make it a normal answer
    dq:addAnswer(pdns.TXT, backendname_response, 1)     -- ttl 1s
    return true
  end

  return false;
end</code></pre><p></p></div></details><p>Файл форварда зон: </p><details class="spoiler"><summary>/etc/powerdns/recursor-forward.zones  </summary><div class="spoiler__content"><pre><code class="lua"># forward zones
h.lan=127.0.0.1:5300
s.lan=127.0.0.1:5300
powerdns.lan=127.0.0.1:5300 

# forward zones recurse
+k8s.lan=10.2.0.1, 10.2.0.2
+example.net=9.9.9.9 , 8.8.8.8:53, 8.8.4.4 
+.=10.9.0.1

# Где 127.0.0.1:5300 это pdns auth</code></pre><p></p></div></details><h3>PDNS Auth на узле PowerDNS </h3><p>Конфигурация авторитетного DNS:</p><details class="spoiler"><summary>/etc/powerdns/pdns.conf </summary><div class="spoiler__content"><pre><code class="cpp">allow-axfr-ips=127.0.0.0/8, ::1
api=yes
api-key=секрет_ари_кей
include-dir=/etc/powerdns/pdns.d  # подключаем BIND и PG бэкенды
launch=
local-address=127.0.0.1,10.1.2.1
local-port=5300
cache-ttl=0
negquery-cache-ttl=10
query-cache-ttl=3
security-poll-suffix=
setgid=pdns
setuid=pdns
webserver=yes
webserver-address=0.0.0.0
webserver-allow-from=127.0.0.1,10.0.0.0/8
webserver-password=вебсервер_пароль
webserver-port=8081
enable-lua-records=yes  # это чтобы работали LUA RR в бэкенде
primary=no              # дальше будет понятно почему
secondary=no            # дальше будет понятно почему
xfr-cycle-interval=60
only-notify=
also-notify=
loglevel=5</code></pre><p></p></div></details><p>Подключение плагинов bind и gpgsql:</p><details class="spoiler"><summary>/etc/powerdns/pdns.d/40_bind.conf </summary><div class="spoiler__content"><pre><code class="cpp">launch+=bind
bind-config=/etc/powerdns/backend_bind/zone_bind.conf
bind-supermaster-config=/var/lib/powerdns/supermaster.conf
bind-supermaster-destdir=/var/lib/powerdns/zones.slave.d</code></pre><p></p></div></details><details class="spoiler"><summary>/etc/powerdns/pdns.d/20_gpgsql.conf </summary><div class="spoiler__content"><pre><code class="cpp">launch+=gpgsql
gpgsql-host=127.0.0.1
gpgsql-port=5432
gpgsql-dbname=powerdns
gpgsql-user=powerdns
gpgsql-password=пароль_к_бд
gpgsql-dnssec=yes</code></pre><p></p></div></details><p>Здесь мы подключили плагины bind и gpgsql.&nbsp;</p><p>Может показаться хорошей идеей прописать одну и ту же зону с разным набором записей в разных бэкендах и получить выгоду от использования обоих. Например, нам было бы удобно работать с простым и понятным всем по формату bind-файлом, но в некоторых случаях всё-таки подключать записи из <a href="https://doc.powerdns.com/authoritative/backends/geoip.html"><u>GeoIP</u></a>-бэка (то есть отдавать разный набор записей в зависимости от source IP клиента, просто потому что там это делать очень удобно.&nbsp;</p><p>Так вот, забудьте про это. Архитектура бэкендов на это не рассчитана. Да, технически вы можете разместить одну и ту же зону с разным или идентичным набором записей в разных бэкендах, и PDNS Auth это проглотит без ошибок, но порядок просмотра бэкендов в этом случае неочевиден. Зону из какого бэка PDNS Auth возьмёт в качестве эталонной? Ответ знает только сам PDNS Auth.&nbsp;</p><p>Может поиграться с опцией launch=bind в gpgsql, меняя очерёдность подгрузки бэкендов. В этом случае бэки действительно загрузятся в том порядке, в котором они перечислены в опции launch, но, опять же, это никак не повлияет на то, в какой бэк PDNS Auth пойдёт за зоной.&nbsp;</p><p>Пример:&nbsp;</p><ol><li><p>берём bind- и geoip-бэки;</p></li><li><p>заполняем одинаковым по количеству набором записей, но с немного отличающимся содержимым (чтобы понимать, из какого бэка пришёл ответ);</p></li><li><p>делаем запрос;</p></li><li><p>получаем содержимое из geoip-бэка;</p></li><li><p>меняем местами бэки в launch;</p></li><li><p>опять получаем содержимое из geoip-бэка;</p></li><li><p>меняем serial в большую и в меньшую сторону;</p></li><li><p>снова получаем контент из geoip-бэка;</p></li><li><p>добавляем новую запись только в bind-бэк;</p></li><li><p>ищем по ней</p></li><li><p>получаем NXDOMAIN;</p></li><li><p>удаляем SOA из geoip;</p></li><li><p>получаем REFUSED.&nbsp;</p></li></ol><p>А вот с парой bind + gpgsql было чуть иначе: при именовании конфигурационных файлов 40_gpgsql.conf и 20_bind.conf (которые подключались через include-dir=/etc/powersns/pdns.d).</p><p><strong>Вывод: каждая зона должна быть определена только один раз в одном из бэкендов PDNS Auth.&nbsp;</strong></p><p>Теперь донастроим оба бэка и добавим пару ресурсных записей.</p><p>Настроим кластер PostgreSQL. Процесс настройки связки master –&gt; replica тривиален, поэтому останавливаться здесь не будем. Гораздо интереснее подъём полноценного HighAvailability (HA)решения, например Patroni. В Ozon по нему отличная компетенция, поэтому сюрпризов в эксплуатации быть не должно. Однако есть небольшое отличие от стандартных кластеров под микросервисы: все необходимые для HA компоненты (PostgreSQL, Patroni, etcd) будут располагаться на тех же машинах, что и PDNS Auth. Сделано это для того, чтобы запросы к БД были максимально быстрыми, а отдельные компоненты, такие как etcd, не использовались совместно с другими сервисами, никак не связанными с DNS, дабы избежать влияния от них.</p><blockquote><p><em>Небольшой оффтоп. Наш текущий кластер etcd-Patroni (тот, который под микросервисы, а не тот, который под DNS), обслуживает уже 3,7 тыс. Patroni-кластеров и 11 тыс. отдельных экземпляров PostgreSQL в production.</em></p></blockquote><p>Конфиг Patroni будет примерно такой:</p><details class="spoiler"><summary>/etc/patroni/patroni.yml</summary><div class="spoiler__content"><pre><code class="cpp">---
name: stgpowerdns1.h.lan
namespace: /service/
scope: powerdns_multidc
restapi:
  listen: 0.0.0.0:8008
  connect_address: 10.40.0.11:8008
  authentication:
    username: patroni
    password: "somepassword"
bootstrap:
  dcs:
    ttl: 60
    loop_wait: 10
    retry_timeout: 20
    maximum_lag_on_failover: 1048576
    master_start_timeout: 60
    synchronous_mode: True
    postgresql:
      use_pg_rewind: True
      use_slots: True
      parameters:
        wal_level: logical
        hot_standby: 'on'
        wal_keep_segments: 100
        max_wal_senders: 24
        max_replication_slots: 30
        wal_log_hints: 'on'
        max_connections: '100'
        max_locks_per_transaction: '64'
  initdb: ['encoding=UTF8', 'data-checksums', 'auth-local=trust', 'locale=en_US.UTF-8', 'auth-host=md5', 'auth-local=trust']
  pg_hba:
    - 'local all all trust'
    - 'local replication all trust'
    - 'host replication replication 127.0.0.1/32 trust'
    - 'host replication replication 127.0.0.1/32 md5'
    - 'host all all 127.0.0.0/8 md5'
    - 'local all all trust'
    - 'host replication replication 10.40.0.11/32 trust'
    - 'host replication replication 10.40.0.12/32 trust'
    - 'host replication replication 10.40.0.13/32 trust'
    - 'host replication replication 10.40.0.14/32 trust'
    - 'host replication replication 10.40.0.15/32 trust'
postgresql:
  basebackup:
    {'max-rate': '1000M', 'checkpoint': 'fast'}
  listen: 0.0.0.0:5432
  connect_address: 10.40.0.11:5432
  data_dir: "/data/postgresql"
  config_dir: "/etc/postgresql/12/main"
  bin_dir: "/usr/lib/postgresql/12/bin"
  use_unix_socket: True
  parameters:
    unix_socket_directories: "/var/run/postgresql"
  authentication:
    replication:
      username: replication
      password: "somepassword2"
    superuser:
      username: postgres
      password: "somepassword3"
etcd: # отказоустойчивое хранилище для хранения состояния кластера 
  protocol: https
  cert: "/etc/patroni/ssl/patroni.pem"
  key: "/etc/patroni/ssl/patroni-key.pem"
  cacert: "/etc/patroni/ssl/ca.pem"
  hosts: "10.40.0.11:2379,10.40.0.12:2379,10.40.0.13:2379,10.40.0.14:2379,10.40.0.15:2379"
watchdog:
  mode: "off"
  device: "/dev/watchdog"
  safety_margin: 5
tags:
  noloadbalance: False
  nofailover: False
  clonefrom: False
  nosync: False</code></pre><p></p></div></details><p>После сетапа БД..</p><p>Импортируем схему данных (таблицы, индексы и т.д.). Для PostgreSQL: <a href="https://doc.powerdns.com/authoritative/backends/generic-postgresql.html#default-schema"><u>https://doc.powerdns.com/authoritative/backends/generic-postgresql.html#default-schema&nbsp;</u></a></p><p>Теперь можно создать пару зон и наполнить их записями.</p><p>Зона <strong>powerdns.lan</strong></p><p>Нужна для правильной работы механизма healthchecks. Dnsdist постоянно запрашивает у бэкенда status.backend.powerdns.lan текстовую запись и тем самым прозрачно проверяет работоспособность базы данных на каждом PowerDNS узле. Чтобы healthcheck был более-менее актуален, отключаем paсket cache на рекурсоре, выставляем TTL записи в 1 секунду и кеш запроса в 3 секунды (чтобы не сильно мучить PostgreSQL).</p><p>Поскольку в зону powerdns.lan мы никогда никакие изменения не вносим, то вероятность накосячить, удалив или изменив ключевую запись status.backend.powerdns.lan, существенно снижается.</p><p>Создаём зону в БД: pdnsutil create-zone powerdns.lan ns1.powerdns.lan.</p><ul><li><p>Заполняем: pdnsutil edit-zone powerdns.lan.</p></li><li><p>Смотрим: pdnsutil list-zone powerdns.lan.</p></li></ul><details class="spoiler"><summary>Загляните под спойлер</summary><div class="spoiler__content"><pre><code class="cpp">$ORIGIN .
powerdns.lan    3600    IN      SOA     ns1.powerdns.lan hostmaster.powerdns.lan 1234568 10800 3600 604800 3600
powerdns.lan    3600    IN      NS      ns1.powerdns.lan.
ns1.powerdns.lan        3600    IN      A       10.10.0.1
status.backend.powerdns.lan     1       IN      TXT     "up"</code></pre><p></p></div></details><p>Зона <strong>h.lan</strong> — основная («железная») зона.</p><p>Создаём, заполняем и смотрим:</p><p>pdnsutil create-zone h.lan ns1.powerdns.lan</p><p>pdnsutil edit-zone h.lan</p><p>pdnsutil list-zone h.lan</p><details class="spoiler"><summary>Загляните под спойлер</summary><div class="spoiler__content"><pre><code class="cpp">$ORIGIN .
h.lan   3600    IN      NS      ns1.powerdns.lan.
h.lan   3600    IN      SOA     ns1.powerdns.lan hostmaster.powerdns.lan 1234568 10800 3600 604800 3600
powerdns1.h.lan      3600    IN      A       10.40.0.11
powerdns2.h.lan      3600    IN      A       10.40.0.12
powerdns3.h.lan      3600    IN      A       10.40.0.13
powerdns4.h.lan      3600    IN      A       10.40.0.14
powerdns5.h.lan      3600    IN      A       10.40.0.15
...
...</code></pre><p></p></div></details><p>Всё, теперь резолв h.lan должен заработать:</p><pre><code class="go">dig @10.10.0.1 +short powerdns3.h.lan
10.40.0.13</code></pre><p>Для production зону h.lan мы настроили, теперь её нужно затащить в staging-окружение. Навскидку это можно организовать через репликацию PostgreSQL или DNS. DNS-репликация видится более гибким решением, потому что позволяет для того же staging-окружения применить отличную от production «конфигурацию». Например, можно <a href="https://doc.powerdns.com/authoritative/modes-of-operation.html#modes-of-operation-axfrfilter"><u>на лету модифицировать получаемую по AXFR зону</u></a>&nbsp; или настроить DNSSEC, что в доступной только для чтения базе PostgreSQL было бы невозможно.</p><p>Соответственно, для staging-окружения поднимаем свой экземпляр кластера Patroni и всего остального (PDNS Auth, PDNS Recursor, Dnsdist).</p><p>И далее у нас есть два пути.&nbsp;</p><h4>Путь 1</h4><ul><li><p>Создаём в БД вторичную зону h.lan: pdnsutil create-secondary-zone h.lan 10.40.0.11:5300 10.40.0.12:5300 и т.д.</p></li><li><p>Заполняем pdnsutil edit-zone h.lan.</p></li></ul><p>Чтобы DNS-репликации заработала в конфигурации PDNS Auth (/etc/powerdns/pdns.conf), мы должны прописать secondary=yes. <strong>И только на той </strong>PowerDNS-<strong>машине, на которой PostgreSQL в данный момент является primary!</strong> Если это сделать и на остальных vm, то при попытке получить зону (AXFR-запрос) процесс pdns_server (PDNS Auth) будет постоянно падать, потому что БД находиться в режиме только для чтения.</p><details class="spoiler"><summary>Загляните под спойлер</summary><div class="spoiler__content"><p>Ну и остался bind-бэкенд. Тут всё максимально просто: обычный файл bind zone, который раскатываем сначала в staging, потом в production: /etc/PowerDNS/backend_bind/zone_bind.conf.</p><p>Описываем тип зоны/зон: master, slave или native.</p><p></p></div></details><p>Вспоминаем, что PDNS Auth (бэкенд gpgsql) смотрит на локальный экземпляр PostgreSQL, и только на одной из машин находится master, на остальных — реплики только на чтение.</p><h4>Путь 2</h4><p>Создаём в БД зону h.lan: pdnsutil create-zone h.lan</p><p>Заполняем: pdnsutil edit-zone h.lan</p><p>На всех PowerDNS-машинах staging-окружения прописываем в конфигурации pdns secondary=yes.</p><p>А зону h.lan (AXFR-запрос) получаем через периодический запуск команды:</p><pre><code class="cpp">/usr/bin/pdns_control retrieve h.lan 10.40.0.11:5300.</code></pre><p>В чем тут соль? Через secondary=yes мы говорим PDNS Auth, чтобы он был готов выполнять функции вторичного (slave) DNS, но будет ли он по факту брать зону с первичного , определяется настройками (типом) зоны.</p><p>В первом примере (Путь 1) мы явно задали тип зоны как SECONDARY. И в соответствии с TTL из SOA-записи PDNS Auth начал периодические попытки «стянуть» зону.</p><p>Во втором примере (Путь 2) тип зоны получился NATIVE, что отключает логику PRIMARY (отсылка notify всем NS) при обновлении зоны и отключает логику SECONDARY (периодический опрос PRIMARY-машин), но отсутствие функциональности SECONDARY нивелируется периодическим выполнением pdns_control retrieve.&nbsp;</p><p>Второй путь кажется красивше. Все узлы PowerDNS в staging получаются идентичны по конфигурации:</p><ul><li><p>на всех узлах включен secondary=yes;</p></li><li><p>на всех узлах есть cron-задача pdns_control retrieve, которая успешно запускается, только если локальный PostgreSQL является первичным.</p></li></ul><p>Ну и остался bind-бэкенд. Тут всё максимально просто: обычный файл bind zone, который раскатываем сначала в staging, потом в production: /etc/PowerDNS/backend_bind/zone_bind.conf.</p><p>Описываем тип зоны/зон: master, slave или native.</p><details class="spoiler"><summary>https://doc.powedns.com/authoritative/backends/bind.html#master-slave-native-configuration </summary><div class="spoiler__content"><pre><code class="cpp">zone "s.lan" {
  file "/etc/powerdns/backend_bind/s.lan.zone";
  type native;
};</code></pre><p></p></div></details><details class="spoiler"><summary>Добавляем записи:</summary><div class="spoiler__content"><pre><code class="cpp">s.lan.      3600    IN    SOA    ns1.powerdns.lan hostmaster.powerdns.lan 2021081853 3600 300 604800 300
s.lan.      3600    IN    NS     ns1.powerdns.lan.
db1.s.lan.  600     IN    A      10.100.0.45
web1.s.lan. 600     IN    A      10.100.0.47</code></pre><p></p></div></details><p>Обновить состояние зоны можно без рестарта pdns_server (PDNS Auth) службы:</p><pre><code class="go">&nbsp;/usr/bin/pdns_control bind-reload-now s.lan</code></pre><h3>Доставка resource records до PowerDNS </h3><p>Пару лет назад у нас случился «неплохой» такой инцидент, который привёл к даунтайму <a href="http://ozon.ru">ozon.ru</a> на час с лишним и убытку в огромную сумму. Просто из PowerDNS пропала бОльшая часть записей.&nbsp;</p><p>Почему? Всё дело в той самой админке, о которой я писал выше, PowerDNS-Admin — WebUI для управления ресурсными записями в PowerDNS. И оказалось, что если при редактировании внести синтаксически, с точки зрения формата RR, ошибочную запись, то этот UI типа этого не замечает.</p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/86d/f8b/bd1/86df8bbd19bc418b6f6a7598d5f6fc09.png" width="1210" height="800"></figure><p>Он отбрасывает пачку текущих записей, но добавить новые не может, так как в одной из записей синтаксическая ошибка. В общем, в первый раз табличка PostgreSQL records потёрлась из-за неверно внесённой записи, во второй раз — ну, надо было проверить, что мы не ошиблись в своих суждениях, и повторили предыдущую операцию, а в третий раз — просто дрогнула рука.&nbsp;</p><p>Проблема <a href="https://github.com/PowerDNS-Admin/PowerDNS-Admin/issues/752"><u>известна</u></a> и на тот момент не была решена. В итоге, админку отключили совсем и временно перешли на pdnsutil edit-zone &lt;zone&gt;.&nbsp;</p><p>Теперь подумаем, как можно уменьшить влияние подобных эксцессов, сохранив приемлемый уровень контроля и комфорта при внесении правок в статичные зоны.&nbsp;</p><p>Первое, что приходит в голову — разделить имеющийся набор SQL-записей на две части:</p><ol><li><p>Редко меняющуюся. Положить её в какой-нибудь статичный бэкенд типа bind</p></li><li><p>Часто меняющуюся — динамический бэк, типа SQL.&nbsp;</p></li></ol><p>Так и сделаем: сервисные записи (s.lan) выносим в bind-бэкенд, а железные записи (h.lan) — в GPGSQL.&nbsp;</p><p>С GPGSQL всё понятно: заходим на машину и редактируем зону через CLI pdnsutil edit-zone &lt;zone&gt;, благо не приходится это делать достаточно часто, ведь обычно за нас эту работу выполняет Terraform или другой наливатор железных или виртуальных машин.&nbsp;</p><p>Проблем со сменой IP-адресов мы, как правило, не имеем, потому что никогда их не меняем (исключением может быть первоначально неудачная настройка виртуальных машин или оборудования). Подход такой: если хочешь перенести виртуальную машину или железный сервер в другое место — как правило, другой ЦОД, — то полностью перенастрой: задай новое имя, IP-адрес и т.д.&nbsp;</p><p>А как быть со статикой? Может, в Git положить?&nbsp;</p><p>В нашей компании в качестве основной системы CI/CD используется <a href="https://gitlab.com/"><u>gitlab</u></a> (локальная версия. конечно). На первый взгляд, правильное место для интеграции, давайте на нём и остановимся.&nbsp;</p><p>Алгоритм выкатки такой:&nbsp;&nbsp;</p><ol><li><p>Создать задачу.</p></li><li><p>Внести изменения в данные зоны.</p></li><li><p>Закоммитить и запушить в новую ветку.</p></li><li><p>Создать MR.</p></li><li><p>Попросить коллег проверить и заапрувить.</p></li><li><p>После удачного завершения задачи zones check мержим MR.</p></li><li><p>Ждём, пока запустится новый pipeline и успешно отработают стадии diff staging и diff production.</p></li><li><p>Проверяем diff -зоны (достаточно по одной job из diff staging/diff production).&nbsp;</p></li><li><p>Если diff соответствует нашим ожиданиям, то запускаем задачуstgpowerdns1.lan.</p></li><li><p>После успешного прогона stgpowerdns1.lan прогоняем оставшиеся задачи в Deploy staging и Deploy production.</p></li></ol><p>Gitlab pipeline выглядит следующим образом:&nbsp;</p><details class="spoiler"><summary>.gitlab-ci.yml</summary><div class="spoiler__content"><pre><code class="yaml">---
include:
  - local:   ".vault.gitlab-ci.yml"

stages:
  - build
  - validate
  - diff staging
  - diff production
  - deploy staging
  - deploy production

workflow:
  rules:
    - &amp;merge_and_changes
      if: $CI_MERGE_REQUEST_ID               # Execute jobs in merge request context
      changes: &amp;change_list
        - Dockerfile
        - .gitlab-ci.yml
        - bind/zones/*
    - &amp;master_and_changes
      if: $CI_COMMIT_BRANCH == 'master'      # Execute jobs when a new commit is pushed to master branch
      changes:
        *change_list
    - when: never
    - allow_failure: false

.master.on_success:
  rules:
    - if: $CI_COMMIT_BRANCH == 'master'      # Execute jobs when a new commit is pushed to master branch
      when: on_success

variables:
  TARGET_IMAGE: $CI_REGISTRY_IMAGE/deploy:latest
  WORKDIR: workdir/$CI_PIPELINE_ID
  ZONES_FILE: workdir/$CI_PIPELINE_ID/zones.list
  SSH_PRIVATE_KEY: .ssh_private_key
  VAULT_SECRET: deploy:ssh_private_key

create image:
  extends: .containers.build
  stage: build
  variables:
    BUILD_DST: ${TARGET_IMAGE}
    DOCKERFILE_PATH: Dockerfile
  when: manual

zones check:
  stage: validate
  image: ${TARGET_IMAGE}
  script:
    - unset COMMIT_FIRST COMMIT
    - rm -rf ${WORKDIR}
    - mkdir -p ${WORKDIR}
    - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.lan/".insteadOf "ssh://git@gitlab.lan/"
    - echo "Searching for zones changed"
    - |
      if [[ -n "$CI_MERGE_REQUEST_ID" ]]; then
        COMMIT=$CI_COMMIT_SHA
        echo $COMMIT
      fi
    - |
      if [[ -z "$CI_MERGE_REQUEST_ID" ]]; then
        COMMITS="$(git show --pretty=format:%P $CI_COMMIT_SHA | head -1 || true)"
        COMMIT_FIRST=${COMMITS%% *}
        COMMIT=${COMMITS##* }
      fi
    - git diff-tree --no-commit-id --name-only -r ${COMMIT} bind/zones/*
    - |
      for zone_file in $(git diff-tree --no-commit-id --name-only -r ${COMMIT} bind/zones/*); do
        echo ${zone_file##*/}
      done | sort | uniq &gt; ${ZONES_FILE}
    - |
      if [[ -s "${ZONES_FILE}" ]]; then 
        echo -e "\e[1m\e[34mProcceding zones\e[0m"
        echo -e "\e[1m\e[34m================\e[0m"
        cat ${ZONES_FILE}
        echo -e "\e[1m\e[34m================\e[0m"
        # gen config
        for ZONE in $(cat ${ZONES_FILE}); do
          echo "
          zone \"${ZONE}\" {
            file \"/tmp/pdns/zones/${ZONE}\";
            type native;
          };" &gt;&gt; /tmp/pdns/zone.conf
          cp bind/zones/${ZONE} /tmp/pdns/zones/${ZONE}
          echo "${ZONE}"
          echo -e "\e[1m\e[34m--------\e[0m"
          cat /tmp/pdns/zones/${ZONE}
          echo -e "\e[1m\e[34m========\e[0m"
        done
        # run powerdns
        pdnsutil create-bind-db /tmp/pdns/dnssec-db
        pdns_server --config-dir=/tmp/pdns/ --daemon=no --write-pid=no --disable-syslog &amp;
        sleep 5
        echo -----------------
        find /tmp/pdns
        echo -----------------
        cat /tmp/pdns/pdns.conf
        echo -----------------
        cat /tmp/pdns/zone.conf
        echo -----------------
        # reload zones
        for ZONE in $(cat ${ZONES_FILE}); do
          pdns_control bind-reload-now ${ZONE} | grep 'parsed into memory'
        done
        pdnsutil --config-dir=/tmp/pdns check-all-zones
      else 
        echo -e "\e[1m\e[34mNo zone files found in the commit. Nothing to do. Exit\e[0m"
        exit 10
      fi
  artifacts:
    paths:
      - ${ZONES_FILE}
    expire_in: 1 week

# ======
#  DIFF
# ======

.diff_zone_script:
  image: ${TARGET_IMAGE}
  extends: .vault_before_script
  script:
    - vault_get_secret ${VAULT_PATH}/${VAULT_SECRET} &gt; ${SSH_PRIVATE_KEY}
    - chmod go= ${SSH_PRIVATE_KEY}
    - |
      for zone in $(cat ${ZONES_FILE}); do
        ssh -i ${SSH_PRIVATE_KEY} \
            -o "StrictHostKeyChecking no" \
            -o "VerifyHostKeyDNS no" \
            deploy@${CI_JOB_NAME#diff } diff-bind-zone ${zone} ${CI_PIPELINE_ID}
      done
  rules:
    - *master_and_changes
    - when: never
    - allow_failure: true

.diff_staging:
  extends: .diff_zone_script
  stage: diff staging
  tags: [staging, deploy]
  environment:
    name: staging
  needs: [zones check]
  resource_group: staging

.diff_production:
  extends: .diff_zone_script
  stage: diff production
  tags: [production, deploy-specific]
  environment:
    name: production
  needs: [zones check]
  resource_group: production

diff stgpowerdns1.lan:
  extends: .diff_staging
diff stgpowerdns2.lan:
  extends: .diff_staging

diff prodpowerdns1.lan:
  extends: .diff_production
diff prodpowerdns2.lan:
  extends: .diff_production

# ======
# DEPLOY
# ======

.deploy_zone_script:
  image: ${TARGET_IMAGE}
  extends: .vault_before_script
  script:
    - vault_get_secret ${VAULT_PATH}/${VAULT_SECRET} &gt; ${SSH_PRIVATE_KEY}
    - chmod go= ${SSH_PRIVATE_KEY}
    - |
      for zone in $(cat ${ZONES_FILE}); do
        ssh -i ${SSH_PRIVATE_KEY} \
            -o "StrictHostKeyChecking no" \
            -o "VerifyHostKeyDNS no" \
            deploy@${CI_JOB_NAME} deploy-bind-zone ${zone} ${CI_PIPELINE_ID}
      done
  rules:
    - if: $CI_COMMIT_BRANCH == 'master'      # Execute jobs when a new commit is pushed to master branch
      changes:
        *change_list
      when: manual
    - when: never
    - allow_failure: true

.deploy_staging:
  extends: .deploy_zone_script
  stage: deploy staging
  tags: [staging, deploy]
  environment:
    name: staging
  needs: [zones check, diff stgpowerdns1.lan]
  resource_group: staging

.deploy_production:
  extends: .deploy_zone_script
  stage: deploy production
  tags: [production, deploy-specific]
  environment:
    name: production
  needs: [zones check, stgpowerdns1.lan]
  resource_group: production

stgpowerdns1.lan:
  extends: .deploy_staging
stgpowerdns2.lan:
  extends: .deploy_staging

prodpowerdns1.lan:
  extends: .deploy_production
prodpowerdns2.lan:
  extends: .deploy_production</code></pre><p></p></div></details><p>В итоге deploy заходит по SSH на каждый узел PowerDNS, берёт master-ветку из Gitlab и подгружает в PDNS Auth новые данные зоны. Загрузка данных сделана через reload, простоя в обслуживании нет.</p><p>Pull-модель выглядит более безопасной по сравнению с push, выбрали её. </p><pre><code class="go">command="/home/deploy/deploy.sh",from="10.0.0.0/8",no-agent-forwarding,no-port-forwarding,no-user-rc,no-X11-forwarding,no-pty ssh-ed25519 &lt;PUBLIC KEY&gt; </code></pre><details class="spoiler"><summary>/home/deploy/deploy.sh</summary><div class="spoiler__content"><pre><code class="yaml">#!/bin/bash -fue
# Managed by Ansible

set -- ${SSH_ORIGINAL_COMMAND}

case ${1} in
    deploy-bind-zone)
        ZONE=${2}
        ZONE_ENC=${ZONE//./%2E}
        PIPELINE_ID=${3}
        mkdir -p ${HOME}/zones/${PIPELINE_ID}
        mkdir -p ${HOME}/zones_last
        mkdir -p ${HOME}/zones_backup
        echo "Deploing zone ${ZONE} by gitlab pipeline (id ${PIPELINE_ID})"
        curl --fail --silent\
             --header "PRIVATE-TOKEN: `cat ${HOME}/.gitlab_access_token`" \
             "https://gitlab.lan/api/v4/projects/&lt;project_id&gt;/repository/files/bind%2Fzones%2F${ZONE_ENC}/raw?ref=master" \
             &gt; ${HOME}/zones/${PIPELINE_ID}/${ZONE}
        sudo -u root /bin/cp -a ${HOME}/zones/${PIPELINE_ID} /etc/powerdns/deploy/
        echo '###  DIFF  ###'
        /usr/bin/diff -u /etc/powerdns/backend_bind/${ZONE}.zone /etc/powerdns/deploy/${PIPELINE_ID}/${ZONE} || true
        echo '###  END DIFF  ###'
        /bin/cp -f /etc/powerdns/backend_bind/${ZONE}.zone ${HOME}/zones_backup/${ZONE}
        sudo -u root /bin/ln -f -s /etc/powerdns/deploy/${PIPELINE_ID}/${ZONE} /etc/powerdns/backend_bind/${ZONE}.zone
        sudo -u root /usr/bin/pdns_control bind-reload-now ${ZONE}
        /bin/cp -f /etc/powerdns/backend_bind/${ZONE}.zone ${HOME}/zones_last/${ZONE}
        ;;
    diff-bind-zone)
        ZONE=${2}
        ZONE_ENC=${ZONE//./%2E}
        PIPELINE_ID=${3}
        mkdir -p /tmp/diff-bind-zone/${PIPELINE_ID}
        echo "Diff zone ${ZONE} by gitlab pipeline (id ${PIPELINE_ID})"
        curl --fail --silent\
             --header "PRIVATE-TOKEN: `cat ${HOME}/.gitlab_access_token`" \
             "https://gitlab.ozon.ru/api/v4/projects/14443/repository/files/bind%2Fzones%2F${ZONE_ENC}/raw?ref=master" \
             &gt; /tmp/diff-bind-zone/${PIPELINE_ID}/${ZONE}
        echo '###  DIFF  ###'
        /usr/bin/diff -u /etc/powerdns/backend_bind/${ZONE}.zone /tmp/diff-bind-zone/${PIPELINE_ID}/${ZONE} || true
        echo '###  END DIFF  ###'
        rm -rf /tmp/diff-bind-zone/${PIPELINE_ID}
        ;;
    *)
        echo "Bad command"
        exit 1
        ;;
esac</code></pre><p></p></div></details><p>Но через некоторое время выяснили «на практике», что Gitlab может быть недоступен, а изменения в DNS нас могут попросить выкатить в любое время. Сделали процедуру аварийной выкатки нужных изменений в рамках Ansible (это наш основной инструмент управления конфигурацией серверов). Выглядит так:&nbsp;</p><ol><li><p>Берём репозиторий с данными зон.</p></li><li><p>Берём Ansible (как правило, у каждого инженера Ansible репозиторий уже есть и актуален).</p></li><li><p>Вносим правки в файлы зон.</p></li><li><p>Катим: playbooks/powerdns/disaster_zones_deploy/main.yml -l 	powerdns_multidc -v.</p></li></ol><details class="spoiler"><summary>playbooks/powerdns/disaster_zones_deploy/readme.md </summary><div class="spoiler__content"><pre><code class="yaml"># check zones loaded to pdns last time
ansible-playbook -i inventory/production_powerdns_multidc.yml playbooks/powerdns/disaster_zones_deploy/check_loaded_status.yml -l powerdns_multidc -v | grep -e changed -e lan --color=never
# specific zone
ansible-playbook -i inventory/production_powerdns_multidc.yml playbooks/powerdns/disaster_zones_deploy/check_loaded_status.yml -l powerdns_multidc -v -e zone=lan | grep -e changed -e lan --color=never

# PREPARE TO DEPLOY
cd git
git clone git@gitlab.lan:powerdns/deploy-zones.git
git clone git@gitlab.lan:ansible.git
cd ansible
https://gitlab.lan/ansible/-/blob/master/README.md#prepare-for-local-work
https://gitlab.lan/ansible/-/blob/master/README.md#vault
vim ../powerdns/deploy-zones/bind/zones/lan

# STAGING DEPLOY
# check mode
ansible-playbook -i inventory/staging_powerdns_multidc.yml playbooks/powerdns/disaster_zones_deploy/main.yml -l powerdns_multidc -CD -v
# check mode | specific zone
ansible-playbook -i inventory/staging_powerdns_multidc.yml playbooks/powerdns/disaster_zones_deploy/main.yml -l powerdns_multidc -CD -v -e zone=s.lan
# fire
ansible-playbook -i inventory/staging_powerdns_multidc.yml playbooks/powerdns/disaster_zones_deploy/main.yml -l powerdns_multidc -D -v
# fire | specific zone
ansible-playbook -i inventory/staging_powerdns_multidc.yml playbooks/powerdns/disaster_zones_deploy/main.yml -l powerdns_multidc -D -v -e zone=s.lan

# PRODUCTION DEPLOY
# check mode
ansible-playbook -i inventory/production_powerdns_multidc.yml playbooks/powerdns/disaster_zones_deploy/main.yml -l powerdns_multidc -CD -v
# check mode | specific zone
ansible-playbook -i inventory/production_powerdns_multidc.yml playbooks/powerdns/disaster_zones_deploy/main.yml -l powerdns_multidc -CD -v -e zone=s.lan
# fire
ansible-playbook -i inventory/production_powerdns_multidc.yml playbooks/powerdns/disaster_zones_deploy/main.yml -l powerdns_multidc -D -v
# fire | specific zone
ansible-playbook -i inventory/production_powerdns_multidc.yml playbooks/powerdns/disaster_zones_deploy/main.yml -l powerdns_multidc -D -v -e zone=s.lan</code></pre><p></p></div></details><p>Сам код:</p><details class="spoiler"><summary>playbooks/powerdns/disaster_zones_deploy/main.yml  </summary><div class="spoiler__content"><pre><code class="yaml">---
- hosts: powerdns_multidc
  gather_facts: false
  become: true
  vars:
    static_zones:
    - s.lan


  tasks:
  - name: include __deploy_zone_tasks.yml
    include_tasks: __deploy_zone_tasks.yml
    with_items:
      - "{{ zone | default(static_zones) }}"</code></pre><p></p></div></details><details class="spoiler"><summary>playbooks/powerdns/disaster_zones_deploy/__deploy_zone_tasks.yml  </summary><div class="spoiler__content"><pre><code class="yaml">---
- name: deploy bind zone {{ item }}
  copy:
    src: ../../../../powerdns-deploy-zones/bind/zones/{{ item }}
    dest: /etc/powerdns/backend_bind/{{ item }}.zone
    owner: pdns_deploy
    group: pdns_deploy
    mode: 0664
    follow: true
    backup: true
  register: zone_file

- name: /usr/bin/pdns_control bind-reload-now {{ item }}  # noqa 503
  shell: &gt;
    [ "{{ ansible_check_mode }}" = "True" ]
    &amp;&amp; echo "DO NOTHING"
    || /usr/bin/pdns_control bind-reload-now {{ item }}
  check_mode: false
  ignore_errors: "{{ ansible_check_mode }}"
  when: zone_file.changed</code></pre><p></p></div></details><details class="spoiler"><summary>playbooks/powerdns/disaster_zones_deploy/check_loaded_status.yml </summary><div class="spoiler__content"><pre><code class="yaml">---
- hosts: powerdns_multidc
  gather_facts: false
  become: true

  tasks:
  - name: /usr/bin/pdns_control bind-domain-status ZONE  # noqa 301
    shell: /usr/bin/pdns_control bind-domain-status {{ zone | default("") }} | sort
    check_mode: false
    ignore_errors: "{{ ansible_check_mode }}"</code></pre><p></p></div></details><p>«Железную» зону редактируем через API PowerDNS: например, добавляем RR при настройке виртуальной машины через Terraform или настройке железного хоста через MaaS. Вручную исправляем редко, но если нужно, то выполняем pdnsutil edit-zone &lt;zone&gt; на узле с PostgreSQL-мастером.&nbsp;&nbsp;</p><p>Хорошо, а если всё вышеописанное работает слишком медленно, громоздко, или мне не нравится катить DNS через Gitlab или другой CI/CD, да и вообще я смелый?! Берите PowerDNS-Admin. Ошибка с отбрасыванием данных исправлена, пользоваться можно.</p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/2a3/2d6/bbe/2a32d6bbe2ef8f2a16c136ed3e94a85f.png" width="1440" height="304"></figure><p>Какие есть аналоги для редактирования RR:&nbsp;</p><ul><li><p>Pdns-gui не поддерживается (последний релиз — 25 апреля 2010).</p></li><li><p><a href="https://www.poweradmin.org/"><u>Poweradmin</u></a> (478 звёзд). Имеет неприятную особенность: в текстовых записях не сохраняет двойные кавычки (“), что напрочь ломает доступ к этим записям через API, который необходим для хранения текстовыми полями информации внутри экранированного кавычками (”) блока. Хотя на функционирование самого сервера это не влияет. Также Poweradmin добавляет несколько своих таблиц и полей в исходную БД, не ведет никаких логов работы в веб-интерфейсе.&nbsp;</p></li><li><p> <a href="https://pdnsmanager.org"><u>PDNS manager</u></a> (160 звёзд) — два года не обновлялся.</p></li><li><p> Ну и сам <a href="https://github.com/ngoduykhanh/PowerDNS-Admin"><u>PowerDNS-Admin</u></a> (1,8 тыс. звёзд). Самая популярная админка, достаточно гибкая, есть аудит, разграничение прав, разные методы аутентификации, двухфакторка… но удаляет данные.</p></li></ul><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/244/b00/23f/244b0023f47a2d5adef9a09e379853aa.png" width="1918" height="942"></figure><h2>Проблемы после внедрения </h2><h3>Resolve Lua record</h3><p>Тут весело. Оказывается, Lua record, та, что реализует проверки и формирует на их основе ответ, начинает работать только <a href="https://github.com/PowerDNS/pdns/issues/9529"><u>после первого</u></a> совершённого к ней DNS-запроса. Для обхода этой проблемы существует прекрасный костыль:&nbsp;</p><pre><code class="lua">crontab -l 
* * * * * dig @localhost smart-record.s.lan &amp;&gt; /dev/null</code></pre><h3>Деплой статичных зон через Gitlab </h3><p>Как-то раз случился инцидент, не связанный с PowerDNS, который, в итоге, привёл к сильному замедлению задач, выполнявшихся на gitlab runners. Одним из шагов по решению проблемы была задача поправить несколько A-записей. Конечно же, через Gitlab нам этого сделать не удалось, джобы могли висеть в статусе ожидания ресурсов по 10-20 минут. В итоге зону поправили вручную и позже написали процедуру раскатки статичных зон в случае форс-мажора.</p><h3>Из кеша recursor не удалялась устаревшая DNS-запись </h3><p>У нас Kubernetes, и его записи имеют достаточно малый TTL, порядка пяти секунд. Иногда замечали, что при перевыкатке некоторых проектов их сервисные DNS-имена, которые указывают на service_ip в Kubernetes, вели в никуда (NXDOMAIN). Настройка кеша подобных записей стояла 10 секунд (max-negative-ttl=10), но почему-то они висели в кеше минуты и часы. Если сбросить кеш рекурсора или перезапустить сам рекурсор, то всё приходило в норму. Может, ошибка была в предыдущей версии рекурсора (4.4.<em>), или нет, но после обновления на 4.5.</em> такое поведение прекратилось.&nbsp;</p><p>Есть подозрения в отношении обработки ECS или DNSSEC, потому как после включения опций edns0 и/или trust-ad в /etc/resolv.conf системный резолвер начинал видеть желанный IP-адрес. Также, если попытаться разрезолвить имя через nslookup, получали NXDOMAIN, в то время как dig всё прекрасно видел. Разница в том, что dig по умолчанию выставляет query опции +adflag +edns. А вот так они уравниваются: dig +noadflag +noedns == nslookup.&nbsp;</p><h3>Что насчёт функциональности наподобие bind views?</h3><p>В самом PDNS Auth её нет (<a href="https://github.com/powerdns/pdns/issues/63">https://github.com/powerdns/pdns/issues/63</a>, <a href="https://github.com/powerdns/pdns/issues/10816">https://github.com/powerdns/pdns/issues/10816</a>), но можно накостылить:&nbsp;&nbsp;</p><ul><li><p>использовать GeoIP-бэкенд;</p></li><li><p>использовать Lua-записи;</p></li><li><p>использовать Dnsdist и несколько PDNS Auth.</p></li></ul><h3>GeoIP-бэкенд </h3><details class="spoiler"><summary>Пример из https://doc.powerdns.com/authoritative/backends/geoip.html </summary><div class="spoiler__content"><pre><code class="cpp">domains:
- domain: geo.example.com
  ttl: 30
  records:
    geo.example.com:
      - soa: ns1.example.com hostmaster.example.com 2014090125 7200 3600 1209600 3600
      - ns:
           content: ns1.example.com
           ttl: 600
      - ns: ns2.example.com
    fin.eu.service.geo.example.com:
      - a: 192.0.2.2
      - txt: hello world
      - aaaa: 2001:DB8::12:34DE:3
# this will result first record being handed out 30% of time
    swe.eu.service.geo.example.com:
      - a:
           content: 192.0.2.3
           weight: 50
      - a: 192.0.2.4
  services:
# syntax 1
    service.geo.example.com: '%co.%cn.service.geo.example.com'
# syntax 2
    service.geo.example.com: [ '%co.%cn.service.geo.example.com', '%cn.service.geo.example.com']
# alternative syntax
  services:
    service.geo.example.com:
      default: [ '%co.%cn.service.geo.example.com', '%cn.service.geo.example.com' ]
      10.0.0.0/8: 'internal.service.geo.example.com'
mapping_lookup_formats: ['%cc-%re', '%cc']
custom_mapping:
  fr: eu-central
  be: eu-central
  es: eu-south
  us-tx: us-south</code></pre><p></p></div></details><p>Самый гибкий вариант. Недостаток в том, что если исходная зона находится в другом бэке, то придётся перенести её в GeoIP-бэк полностью. </p><h3>Lua-записи</h3><p>Файл bind zone:&nbsp;</p><pre><code class="go">www IN LUA A ";if countryCode('US') then return {'192.0.2.1','192.0.2.2'} else return '192.0.2.2' end" </code></pre><p>Самый простой для внедрения вариант. Недостаток в отсутствии гибкости, один if и два варианта содержимого. Если захочется что-то более сложное, возможно, придётся писать свою Lua-функцию. В SQL-совместимом бэкенде также будет работать.&nbsp;</p><h3>Dnsdist и несколько PDNS Auth </h3><p>Два экземпляра PDNS Auth с разным содержимым для внутренних и внешних потребителей. </p><pre><code class="cpp">newServer({address="10.0.9.1:5301", pool="INTERNAL"}) 
newServer({address="10.0.9.1:5302", pool="EXTERNAL"}) 

addAction({"10.0.0.0/8"}, PoolAction("INTERNAL")) 
addAction(AllRule(),PoolAction("EXTERNAL")) </code></pre><p>Если сюда добавить логику выбора следующего сервера при недоступности основного, то получится достаточно громоздко. </p><h3>Логирование DNS-запросов </h3><p>Нужно как минимум в двух случаях: для отдела ИБ и для отладки.&nbsp;</p><p>Решили логировать на уровне рекурсора, потому что запрос обязан через него проходить. Dnsdist можно обойти, зная реальные адреса PowerDNS-машин (закрыть не проблема), а прямой доступ в PDNS Auth есть только у локального PDNS Recursor (специально).&nbsp;</p><p>Каких-то специфичных требований к логированию запросов не было, поэтому сделали просто:&nbsp;</p><details class="spoiler"><summary>/etc/powerdns/recursor.conf
</summary><div class="spoiler__content"><pre><code class="cpp">quiet=no 
trace=fail 
loglevel=5</code></pre><p></p></div></details><details class="spoiler"><summary>journalctl -u pdns-recursor.service</summary><div class="spoiler__content"><pre><code class="cpp"># запрос 
pdns_recursor[10861]: 3 [1418626328/2] question for 'stgpostgres44.lan|A' from 10.1.2.3:55002 (ecs 10.100.1.52/32) 

# и ответ
pdns_recursor[10861]: 3 [1418626328/2] answer to question 'stgpostgres44.lan|A': 1 answers, 1 additional, took 1 packets, 0.359 netw ms, 0.474 tot ms, 0 throttled, 0 timeouts, 0 tcp connections, rcode=0</code></pre><p></p></div></details><p>Если packetcache включен и ответ из него отдаётся, то в логе увидим:&nbsp;</p><pre><code class="cpp">pdns_recursor[10861]: 3 question answered from packet cache tag=0 from 10.1.2.3:55002 </code></pre><p>Но существует более зрелый подход — DNStap (<a href="https://dnstap.info/"><u>https://dnstap.info</u></a>). Это гибкий, структурированный бинарный формат лога на основе protobuf. Dnsdist поддерживает его с версии 1.3 (<a href="https://dnsdist.org/reference/dnstap.html">https://dnsdist.org/reference/dnstap.html</a>), pdns recursor — с версии 4.2 (<a href="https://docs.powerdns.com/recursor/lua-config/protobuf.html">https://docs.powerdns.com/recursor/lua-config/protobuf.html</a>)&nbsp;</p><p>Кроме его поддержки на стороне рекурсора и/или балансировщика, нам понадобится DNStap-коллектор, ведь сгенерированный лог нужно где-то хранить и анализировать (желательно централизованно). В качестве коллектора можно использовать <a href="https://github.com/dmachard/go-dns-collector"><u>go-dns-collector</u></a>. Много звёзд, поддерживается. Является одновременно агрегатором, анализатором и транспортом в другие системы. Может экспортировать логи в Elastic, Fluentd, Syslog и т.д., предоставляет метрики и REST API.</p><p>Запустим коллектор: ./go-dnscollector -config config.yml&nbsp;</p><details class="spoiler"><summary>config.yaml </summary><div class="spoiler__content"><pre><code class="cpp">global:
  trace:
    verbose: true
multiplexer:
  collectors:
    - name: dnstap
      dnstap:
        listen-ip: 0.0.0.0
        listen-port: 6000
  loggers:
    - name: console
      stdout:
        mode: json
  routes:
    - from: [dnstap]
      to: [console]</code></pre><p></p></div></details><p>И натравим на него рекурсор:</p><p>​​cat /etc/PowerDNS/resursor.conf </p><pre><code class="cpp">... 
lua-config-file=/etc/powerdns/recursor.lua.d/log.lua </code></pre><p>cat log.lua&nbsp;</p><pre><code class="cpp">dnstapFrameStreamServer("172.6.0.156:6001") </code></pre><p>Важные моменты:&nbsp;</p><ul><li><p>Для логирования в формате DNStap по TCP PDNS Recursor должен быть скомпилирован с параметром --enable-dnstap. Также должна быть обновлена библиотека libfstrm, иначе передача логов будет возможна только через unix-socket.&nbsp;</p></li></ul><ul><li><p>Передача данных на удалённый узел осуществляется по протоколу TCP, поэтому в 	случае недоступности коллектора неотправленные сообщения будут копиться, что в конечном итоге приведёт к исчерпанию оперативной памяти. Смотрим на параметры inputQueueSize и outputQueueSize, подбираем под себя размеры очередей, после переполнения которых DNStap логи начнут теряться.&nbsp;</p></li><li><p>Если логи нужны прям обязательно, да ещё чтобы не терялись, поднимаем несколько коллекторов и прописываем директиву DNStapFrameStreamServer необходимое количество раз.</p></li></ul><p>Ну и dnsdist давайте настроим. Тут всё аналогично:&nbsp;</p><pre><code class="cpp">cat /etc/dnsdist/dnsdist.conf 
... 
newFrameStreamTcpLogger("172.6.0.156:6001") </code></pre><p>Пример лога.</p><details class="spoiler"><summary>Операция "DNSQueryType" </summary><div class="spoiler__content"><pre><code class="cpp">{
  "network": {
    "family": "INET",
    "protocol": "UDP",
    "query-ip": "172.6.0.156",
    "query-port": "48408",
    "response-ip": "172.6.0.20",
    "response-port": "53",
    "as-number": "-",
    "as-owner": "-"
  },
  "dns": {
    "length": 28,
    "opcode": 0,
    "rcode": "-",
    "qname": "nginx.ozon",
    "qname-public-suffix": "-",
    "qname-effective-tld-plus-one": "-",
    "qtype": "A",
    "flags": {
      "qr": false,
      "tc": false,
      "aa": false,
      "ra": false,
      "ad": false
    },
    "resource-records": {
      "an": [],
      "ns": [],
      "ar": []
    },
    "malformed-packet": false
  },
  "edns": {
    "udp-size": 0,
    "rcode": 0,
    "version": 0,
    "dnssec-ok": 0,
    "options": []
  },
  "dnstap": {
    "operation": "DNSQueryType",
    "identity": "d12b46e263cc",
    "timestamp-rfc3339ns": "2022-12-01T07:24:41.000425932Z",
    "latency": "-"
  },
  "geo": {
    "city": "-",
    "continent": "-",
    "country-isocode": "-"
  },
  "pdns": {
    "tags": [],
    "original-request-subnet": "",
    "applied-policy": ""
  },
  "suspicious": {
    "score": 0,
    "malformed-pkt": false,
    "large-pkt": false,
    "long-domain": false,
    "slow-domain": false,
    "unallowed-chars": false,
    "uncommon-qtypes": false,
    "excessive-number-labels": false
  }
}</code></pre><p></p></div></details><details class="spoiler"><summary>Операция “DNSResponseType” </summary><div class="spoiler__content"><pre><code class="cpp">{
  "network": {
    "family": "INET",
    "protocol": "UDP",
    "query-ip": "172.6.0.156",
    "query-port": "48408",
    "response-ip": "172.6.0.20",
    "response-port": "53",
    "as-number": "-",
    "as-owner": "-"
  },
  "dns": {
    "length": 109,
    "opcode": 0,
    "rcode": "NOERROR",
    "qname": "nginx.ozon",
    "qname-public-suffix": "-",
    "qname-effective-tld-plus-one": "-",
    "qtype": "AAAA",
    "flags": {
      "qr": false,
      "tc": false,
      "aa": false,
      "ra": false,
      "ad": false
    },
    "resource-records": {
      "an": [],
      "ns": [],
      "ar": []
    },
    "malformed-packet": false
  },
  "edns": {
    "udp-size": 0,
    "rcode": 0,
    "version": 0,
    "dnssec-ok": 0,
    "options": []
  },
  "dnstap": {
    "operation": "DNSResponseType",
    "identity": "d12b46e263cc",
    "timestamp-rfc3339ns": "2022-12-01T07:24:41.000445065Z",
    "latency": "0.021053"
  },
  "geo": {
    "city": "-",
    "continent": "-",
    "country-isocode": "-"
  },
  "pdns": {
    "tags": [],
    "original-request-subnet": "",
    "applied-policy": ""
  },
  "suspicious": {
    "score": 0,
    "malformed-pkt": false,
    "large-pkt": false,
    "long-domain": false,
    "slow-domain": false,
    "unallowed-chars": false,
    "uncommon-qtypes": false,
    "excessive-number-labels": false
  }
}</code></pre><p></p></div></details><p>Вот что увидим в Grafana:</p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/129/4e0/790/1294e07903a542c3805ba21c832b7016.png" alt="Спасибо Юрию Макарову за исследование по теме DNStap, проверку работоспособности Proxy Protocol и за анализ инструментов редактирования RR в PowerDNS. " title="Спасибо Юрию Макарову за исследование по теме DNStap, проверку работоспособности Proxy Protocol и за анализ инструментов редактирования RR в PowerDNS. " width="1848" height="876"><div><figcaption>Спасибо Юрию Макарову за исследование по теме DNStap, проверку работоспособности Proxy Protocol и за анализ инструментов редактирования RR в PowerDNS. </figcaption></div></figure><h3>Debug</h3><p>С помощью утилиты rec_control и команды trace-regex можно получить детальный разбор запроса при прохождении его через рекурсор.</p><details class="spoiler"><summary># rec_control trace-regex '^(b|c).nonexists.domain'</summary><div class="spoiler__content"><pre><code class="go">00:32:06 stgpowerdns1 pdns_recursor[10861]: 3 [1801294368/1] question for 'c.nonexists.domain|A' from 127.0.0.1:39805
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] : no TA found for 'c.nonexists.domain' among 1
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] : no TA found for 'nonexists.domain' among 1
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: Wants NO DNSSEC processing, auth data in query for A
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: No cache hit for 'c.nonexists.domain|A', trying to find an appropriate NS record
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: Cache consultations done, have 1 NS to contact
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: Domain has hardcoded nameservers
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain.: Nameservers: +10.2.2.2:53(1.05ms), +10.2.2.1:53(862.82ms)
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: Resolved '.' NS (empty) to: 10.2.2.2, 10.2.2.1
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: Trying IP 10.2.2.2:53, asking 'c.nonexists.domain|A'
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: Got 2 answers from (empty) (10.2.2.2), rcode=3 (Non-Existent domain), aa=0, in 0ms
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: accept answer '.|SOA|a.root-servers.net. nstld.verisign-grs.com. 2023010801 1800 900 604800 86400' from '.' nameservers? ttl=537, place=2 YES! - This answer was received from a server we forward to. 
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: OPT answer '.' from '.' nameservers
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: determining status after receiving this packet
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: got negative caching indication for name 'c.nonexists.domain' (accept=1), newtarget='(empty)'
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: status=NXDOMAIN, we are done (have negative SOA)
00:32:06 stgpowerdns1 pdns_recursor[10861]: [1801294368] c.nonexists.domain: failed (res=3)
00:32:06 stgpowerdns1 pdns_recursor[10861]: 3 [1801294368/1] answer to question 'c.nonexists.domain|A': 0 answers, 1 additional, took 1 packets, 0.845 netw ms, 0.984 tot ms, 0 throttled, 0 timeouts, 0 tcp connections, rcode=3</code></pre><p></p></div></details><p>Вот с таким кодом на рекурсоре и соответствующим txt-запросом можно понять, на какие бэкенды в данный момент могут уходить DNS-запросы с того или иного хоста:&nbsp; </p><details class="spoiler"><summary>somehost# </summary><div class="spoiler__content"><pre><code class="cpp">dig +short txt name.backend.powerdns.lan
"stgpowerdns2.lan"
dig +short txt name.backend.powerdns.lan
"stgpowerdns1.lan"</code></pre><p></p></div></details><details class="spoiler"><summary>stgpowerdns1.lan# 
/etc/powerdns/recursor.lua.d/dns.lua  
</summary><div class="spoiler__content"><pre><code class="cpp">backendname_request = "name.backend.powerdns.lan"
backendname_response = "\"stgpowerdns1.lan\""

function preresolve(dq)
  if dq.qname:equal(backendname_request) then
    dq.variable = true                      -- disable packet cache
    dq.rcode=0                              -- make it a normal answer
    dq:addAnswer(pdns.TXT, backendname_response, 1)     -- ttl 1s
    return true
  end
  return false;
end</code></pre><p></p></div></details><p>А вот так мы понимаем, где находится первичный узел кластера PostgreSQL, на который настроен PowerDNS: </p><pre><code class="cpp">dig +short powerdns-leader.s.lan. 
10.14.0.9 </code></pre><details class="spoiler"><summary>Файл bind zone с Lua-записями</summary><div class="spoiler__content"><pre><code class="lua">config_stg   IN  LUA  LUA ("settings={stringmatch='replication'} backends={'10.12.0.1','10.13.1.59','10.14.0.9','10.15.0.2','10.16.0.40','10.17.0.5'}" )
powerdns-leader.s.lan.  30  IN  LUA  A  ( ";include('config_stg') return ifurlup('http://127.0.0.1:8005/leader',{backends,{}}, settings)" )</code></pre><p></p></div></details><p>На 127.0.0.1:8005 висит Patroni. Команда backends выводит список всех узлов Patroni-кластера.</p><h3>Наша Grafana</h3><p>Тут пусть будут одни картинки. </p><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/32d/8cf/3a7/32d8cf3a7ad918167662be9f2c1c0ea1.png" width="1800" height="848"></figure><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/432/9ba/694/4329ba694de70f74d081387d69565eaa.png" width="1799" height="769"></figure><figure class="full-width "><img src="https://habrastorage.org/getpro/habr/upload_files/9d9/5b2/8dc/9d95b28dccff5ff8e1f9f3713bb9b1ec.png" width="1800" height="691"></figure><h2>Заключение</h2><p>Эта статья должна была выйти год назад. Отлежалась, дополнилась некоторыми разделами. Приведённая конфигурация работает в бою уже 1,5 года. Инцидентов, кроме описанного, за это время не было.</p><p>Что нас ждёт впереди? Можно задуматься о написании собственной админки: ключевые моменты — уменьшение длительности выкатки статичных зон и уход от рисков, связанных с использованием стороннего ПО (вспоминаем PowerDNS-Admin и 2022 год в целом (<a href="https://habr.com/ru/news/t/655929/"><u>https://habr.com/ru/news/t/655929/</u></a>)).&nbsp;</p><p>Кардинально менять архитектуру не планируем, пока устраивает. Возможно, подумаем над выселением кластера PostgreSQL с узлов PowerDNS.</p><p>Из рекомендаций: в инфраструктурах меньшего масштаба, или когда нет возможности настроить динамическую маршрутизацию на LB, самым подходящим решением для VIP будет использование протокола CARP/VRRP. Например, пара LB машин с Keepalived на борту в каждом ЦОД, а в resolv.conf клиента перечислены все VIP.&nbsp;</p><p>Вроде всё. Спасибо.&nbsp;</p><p></p></div>
      
    </div>

    

    <dl class="post__tags">
      <dt class="post__tags-label">Теги:</dt>
      <dd class="post__tags-list">    <ul class="inline-list inline-list_fav-tags js-post-tags">
        <li class="inline-list__item inline-list__item_tag"><a href="https://habr.com/ru/search/?q=%5Bozon%20tech%5D&target_type=posts" rel="tag" class="inline-list__item-link post__tag  ">ozon tech</a></li>
        <li class="inline-list__item inline-list__item_tag"><a href="https://habr.com/ru/search/?q=%5Bdns%5D&target_type=posts" rel="tag" class="inline-list__item-link post__tag  ">dns</a></li>
        <li class="inline-list__item inline-list__item_tag"><a href="https://habr.com/ru/search/?q=%5Bedns%5D&target_type=posts" rel="tag" class="inline-list__item-link post__tag  ">edns</a></li>
        <li class="inline-list__item inline-list__item_tag"><a href="https://habr.com/ru/search/?q=%5Bpowerdns%5D&target_type=posts" rel="tag" class="inline-list__item-link post__tag  ">powerdns</a></li>
        <li class="inline-list__item inline-list__item_tag"><a href="https://habr.com/ru/search/?q=%5Bbgp%5D&target_type=posts" rel="tag" class="inline-list__item-link post__tag  ">bgp</a></li>
        <li class="inline-list__item inline-list__item_tag"><a href="https://habr.com/ru/search/?q=%5Bpostgresql%5D&target_type=posts" rel="tag" class="inline-list__item-link post__tag  ">postgresql</a></li>
        <li class="inline-list__item inline-list__item_tag"><a href="https://habr.com/ru/search/?q=%5Bmaintenance%5D&target_type=posts" rel="tag" class="inline-list__item-link post__tag  ">maintenance</a></li>
        <li class="inline-list__item inline-list__item_tag"><a href="https://habr.com/ru/search/?q=%5Brecursor%5D&target_type=posts" rel="tag" class="inline-list__item-link post__tag  ">recursor</a></li>
        <li class="inline-list__item inline-list__item_tag"><a href="https://habr.com/ru/search/?q=%5Bmulti-dc%5D&target_type=posts" rel="tag" class="inline-list__item-link post__tag  ">multi-dc</a></li>
        <li class="inline-list__item inline-list__item_tag"><a href="https://habr.com/ru/search/?q=%5Bhigh%20availability%5D&target_type=posts" rel="tag" class="inline-list__item-link post__tag  ">high availability</a></li>
    </ul>
    <button type="button" class="btn btn_outline_grey btn_mini hidden js-fav-edit-link" data-type="2" data-id="722042" onclick="show_edit_tags(this)">Добавить метки</button>
</dd>
    </dl>
      <dl class="post__tags">
        <dt class="post__tags-label">Хабы:</dt>
        <dd class="post__tags-list">
          <ul class="inline-list inline-list_fav-tags js-post-hubs">
              <li class="inline-list__item inline-list__item_tag">
                <a href="https://habr.com/ru/company/ozontech/" rel="tag" class="inline-list__item-link post__tag">
                  Блог компании Ozon Tech
                </a>
              </li>
              <li class="inline-list__item inline-list__item_tag">
                <a href="https://habr.com/ru/hub/sys_admin/" rel="tag" class="inline-list__item-link post__tag">
                  Системное администрирование
                </a>
              </li>
              <li class="inline-list__item inline-list__item_tag">
                <a href="https://habr.com/ru/hub/it-infrastructure/" rel="tag" class="inline-list__item-link post__tag">
                  IT-инфраструктура
                </a>
              </li>
              <li class="inline-list__item inline-list__item_tag">
                <a href="https://habr.com/ru/hub/dns/" rel="tag" class="inline-list__item-link post__tag">
                  DNS
                </a>
              </li>
              <li class="inline-list__item inline-list__item_tag">
                <a href="https://habr.com/ru/hub/distributed_systems/" rel="tag" class="inline-list__item-link post__tag">
                  Распределённые системы
                </a>
              </li>
          </ul>
        </dd>
      </dl>
  </div>
    <div class="overlay hidden" id="js-user-vote-reason">
  <div class="popup popup_reasons">
    <div class="popup__head popup__head_lang-settings">
      <span class="popup__head-title">Укажите причину минуса, чтобы автор поработал над ошибками</span>
      <button type="button" class="btn btn_small btn_popup-close js-hide_user-vote-reason">
        <svg class="icon-svg" width="12" height="12">
          <use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#close" />
        </svg>
      </button>
    </div>
    <div class="popup__body">
       <span class="checkbox checkbox_custom reasons-vote__item js-user-vote-popup_list-item">
          <input type="checkbox" id="reasonList" name="reasonList" class="checkbox__input js-user-vote_checkbox" value="">
          <label for="reasonList" class="checkbox__label checkbox__label_another js-user-vote_title"></label>
        </span>
      <div id="js-user-vote-popup_list"></div>
      <button type="button" class="btn btn_blue btn_huge js-user-vote_send" disabled>Отправить анонимно</button>
    </div>
  </div>
</div>

    <div class="overlay hidden" id="js-vote-reason">
  <div class="popup popup_reasons">
    <div class="popup__head popup__head_lang-settings">
      <span class="popup__head-title">Укажите причину минуса, чтобы автор поработал над ошибками</span>
      <button type="button" class="btn btn_small btn_popup-close js-hide_vote-reason">
        <svg class="icon-svg" width="12" height="12">
          <use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#close" />
        </svg>
      </button>
    </div>
    <div class="popup__body">
       <span class="radio radio_custom reasons-vote__item js-vote-popup_list-item">
          <input type="radio" id="reasonList" name="reasonList" class="radio__input js-vote_radio" value="">
          <label for="reasonList" class="radio__label radio__label_another js-vote_title"></label>
        </span>
      <div id="js-vote-popup_list"></div>
      <button type="button" class="btn btn_blue btn_huge js-vote_send" disabled>Отправить анонимно</button>
    </div>
  </div>
</div>

</article>


        <form action="/json/favorites/" method="post" class="form form_bordered form_favorites-tags hidden" id="edit_tags_form">
  <input type="hidden" name="action" value="add" />
  <input type="hidden" name="ti" value="0" />
  <input type="hidden" name="tt" value="0" />

  <button type="button" class="btn form__close-btn" onclick="closeForm(this)" title="Закрыть"><svg class="icon-svg icon-svg_navbar-close-search" width="31" height="32" viewBox="0 0 31 32" aria-hidden="true" version="1.1" role="img"><path d="M26.67 0L15.217 11.448 3.77 0 0 3.77l11.447 11.45L0 26.666l3.77 3.77L15.218 18.99l11.45 11.448 3.772-3.77-11.448-11.45L30.44 3.772z"/></svg>
</button>

  <fieldset class="form__fieldset">
    <legend class="form__legend">Пометьте публикацию своими метками</legend>
    <input type="text" name="tags_string" class="form__text-field" />
    <span class="form__desc">Метки лучше разделять запятой. Например: <i>программирование, алгоритмы</i></span>
  </fieldset>

  <div class="form__footer">
    <button type="submit" class="btn btn_x-large btn_outline_blue" disabled>Сохранить</button>
  </div>
</form>

        <div class="post-additionals post-additionals_company">
            <ul class="post-stats post-stats_post js-user_" data-post-type="publish_corp_ru,c_ozontech,h_221,h_6398,h_17708,h_21482" id="infopanel_post_722042">
          <li class="post-stats__item post-stats__item_voting-wjt">
            <div class="voting-wjt voting-wjt_post js-post-vote" data-id="722042" data-type="2">
              <button type="button" class="btn voting-wjt__button " data-action="plus" onclick="posts_vote_plus(this);" title="Голосовать могут только зарегистрированные пользователи" disabled><svg class="icon-svg_arrow-up" width="10" height="16"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#vote-arrow" /></svg></button>

              <span class="voting-wjt__counter  voting-wjt__counter_positive  js-score" onclick="posts_vote_result(25, 25, 0)" title="Всего голосов 25: &uarr;25 и &darr;0">+25</span>

              <button type="button" class="btn voting-wjt__button " data-action="minus" title="Голосовать могут только зарегистрированные пользователи" onclick="posts_vote_minus(this);" disabled><svg class="icon-svg_arrow-down" width="10" height="16"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#vote-arrow" /></svg></button>
            </div>
          </li>
    <li class="post-stats__item post-stats__item_bookmark">
      <button type="button" class="btn bookmark-btn bookmark-btn_post " data-post-type="publish_corp_ru,c_ozontech,h_221,h_6398,h_17708,h_21482" data-type="2" data-id="722042" data-action="add" title="Только зарегистрированные пользователи могут добавлять публикации в закладки" onclick="posts_add_to_favorite(this);" disabled>
        <span class="btn_inner"><svg class="icon-svg_bookmark" width="10" height="16"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="bookmark__counter js-favs_count" title="Количество пользователей, добавивших публикацию в закладки">12</span></span>
      </button>
    </li>

    <li class="post-stats__item post-stats__item_views">
      <div class="post-stats__views" title="Количество просмотров">
        <svg class="icon-svg_views-count" width="21" height="12"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-stats__views-count">1,2k</span>
      </div>
    </li>

      <li class="post-stats__item post-stats__item_comments">
          <a href="https://habr.com/ru/company/ozontech/blog/722042/#comments" class="post-stats__comments-link" rel="nofollow">
            <svg class="icon-svg_post-comments" width="16" height="16"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-stats__comments-count" id="post-stats-comments-count" title="Читать комментарии">1</span>
          </a>
      </li>


      <li class="post-stats__item post-stats__item_share">
        <div class="dropdown dropdown_share">
          <div href="https://habr.com/ru/company/ozontech/blog/722042/#comments" data-toggle="dropdown" class="post-stats__share" rel="nofollow">
            <svg class="icon-svg_post-share" width="24" height="24">
              <use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#share">
            </svg>
            <span class="post-stats__comments-text" title="Поделиться">
              Поделиться
            </span>
          </div>

          <div class="dropdown-container">
            <div class="post-share">
  <ul class="post-share__buttons">
    <li class="post-share__item post-share__item_post">
      <span
        class="post-share__item-link post-share__item-link_normal post-share__item-link_copy"
        title="Скопировать ссылку"
        onclick="copyCurrentUrl(), $('.dropdown_share').removeClass('dropdown_active')"
      >
        Скопировать ссылку
      </span>
    </li>
    <li class="post-share__item post-share__item_post">
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://habr.com/ru/company/ozontech/blog/722042/"
        class="post-share__item-link post-share__item-link_normal post-share__item-link_facebook"
        title="Facebook"
        onclick="window.open(this.href, 'Facebook', 'width=640,height=436,toolbar=0,status=0'); return false"
      >
        Facebook
      </a>
    </li>
    <li class="post-share__item post-share__item_post">
      <a href="https://twitter.com/intent/tweet?text=%D0%A7%D0%B5%D1%80%D0%B5%D0%B7+%D1%80%D0%B5%D0%BA%D0%B8%2C+%D1%87%D0%B5%D1%80%D0%B5%D0%B7+%D0%BB%D0%B5%D1%81+%D0%BF%D1%80%D1%8F%D0%BC%D0%BE+%D0%BA+PowerDNS+https://habr.com/p/722042/+via+%40habr_com"
        class="post-share__item-link post-share__item-link_normal post-share__item-link_twitter"
        title="Twitter"
        onclick="window.open(this.href, 'Twitter', 'width=800,height=300,resizable=yes,toolbar=0,status=0'); return false"
      >
        Twitter
      </a>
    </li>
    <li class="post-share__item post-share__item_post">
      <a href="https://vk.com/share.php?url=https://habr.com/ru/company/ozontech/blog/722042/"
        class="post-share__item-link post-share__item-link_normal post-share__item-link_vkontakte"
        title="ВКонтакте"
        onclick="window.open(this.href, 'ВКонтакте', 'width=800,height=300,toolbar=0,status=0'); return false"
      >
        ВКонтакте
      </a>
    </li>
    <li class="post-share__item post-share__item_post">
      <a href="https://t.me/share/url?url=https://habr.com/ru/company/ozontech/blog/722042/&title=Через реки, через лес прямо к PowerDNS"
        class="post-share__item-link post-share__item-link_normal post-share__item-link_telegram"
        title="Telegram"
        onclick="window.open(this.href, 'Telegram', 'width=800,height=300,toolbar=0,status=0'); return false"
      >
        Telegram
      </a>
    </li>
    <li class="post-share__item post-share__item_post">
      <a href="https://getpocket.com/edit?url=https://habr.com/ru/company/ozontech/blog/722042/&title=Через реки, через лес прямо к PowerDNS"
        class="post-share__item-link post-share__item-link_normal post-share__item-link_pocket"
        title="Pocket"
        target="_blank"
      >
        Pocket
      </a>
    </li>
  </ul>
</div>

          </div>
        </div>
      </li>






  </ul>

            <form action="/json/complaints/add/" class="form form_bordered form_abuse hidden" method="post" id="abuse_form">
  <input type="hidden" name="tt" value="2" />
  <input type="hidden" name="ti" value="722042" />

  <button type="button" class="btn form__close-btn" onclick="closeForm(this)"><svg class="icon-svg icon-svg_navbar-close-search" width="31" height="32" viewBox="0 0 31 32" aria-hidden="true" version="1.1" role="img"><path d="M26.67 0L15.217 11.448 3.77 0 0 3.77l11.447 11.45L0 26.666l3.77 3.77L15.218 18.99l11.45 11.448 3.772-3.77-11.448-11.45L30.44 3.772z"/></svg>
</button>

  <fieldset class="form__fieldset">
    <legend class="form__legend">Нарушение</legend>
    <input type="text" name="text" class="form__text-field" />
    <span class="form__desc">Опишите суть нарушения</span>
  </fieldset>

  <div class="form__footer">
    <button type="submit" class="btn btn_x-large btn_outline_blue" disabled>Отправить</button>
  </div>
</form>


            

            <div class="company-info company-info_post-additional author-panel">
              <div class="company-info__about">
                <div class="media-obj media-obj_company">
    <a href="/company/ozontech/" class="media-obj__image page-header__image">
        <img src="//habrastorage.org/getpro/habr/company/4c8/542/883/4c8542883ef14a62b065425db4a6e6cf.jpg" width="48" height="48" class="company-info__image-pic"/>
    </a>

  <div class="media-obj__body media-obj__body_page-header media-obj__body_page-header_branding">

    <div class="page-header__info">
        <a href="/company/ozontech/"  class="page-header__info-title">Ozon Tech</a>
        <div class="page-header__info-desc">
          Стремимся делать лучший e-commerce в России
        </div>
    </div>
  </div>
</div>


              </div>
              <div class="author-panel__user-info">
                <div class="user-info" data-user-login="makurus">
  <div class="user-info__stats">
      <div class="media-obj">
        <a href="https://habr.com/ru/users/makurus/" class="media-obj__image" onclick="if (typeof ga === 'function') { ga('send', 'event', 'author_info_bottom', 'profile', 'makurus');}">
            <span class="default-image default-image_medium default-image_pink">
              <svg class="icon-svg" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true" version="1.1" role="img"><path d="M21.5 24h-19c-1.379 0-2.5-1.122-2.5-2.5v-19c0-1.379 1.122-2.5 2.5-2.5h19c1.379 0 2.5 1.122 2.5 2.5v19c0 1.379-1.122 2.5-2.5 2.5zm-19-23c-.827 0-1.5.673-1.5 1.5v19c0 .827.673 1.5 1.5 1.5h19c.827 0 1.5-.673 1.5-1.5v-19c0-.827-.673-1.5-1.5-1.5h-19zM15.598 12.385zM19.438 15.417l-.002-.005v-.001c-.875-2.226-2.484-3.054-3.445-3.549l-.273-.143c.029-.497-.025-1.034-.167-1.599l-.128.032.123-.044c-.765-2.152-1.757-2.585-2.632-2.967l-.006-.003-.535-2.121c.357-.065.628-.375.628-.752.001-.423-.342-.765-.765-.765s-.766.342-.766.765c0 .358.248.657.581.74l-.825 1.654-.014-.003-.024-.003c-1.053-.033-1.842.369-2.5.947-.633-.322-1.515-.729-2.158-1.814.107-.12.174-.276.174-.45 0-.375-.303-.678-.678-.678s-.678.303-.678.678.303.678.678.678l.221-.04c.416.597 1.09 1.181 1.347 2.828l-.072.091.104.081-.112-.067c-1.157 1.914-.793 4.248.207 5.37-.998 2.546-1.035 4.681-.097 5.868l.002.002.003.003c.119.162.313.233.524.233.189 0 .39-.057.559-.154.312-.179.441-.459.326-.713l-.12.054.119-.056c-.581-1.243-.474-2.713.314-4.37.4.131.778.208 1.145.234l.139.73c.264 1.418.514 2.757 1.297 4.006.132.264.453.387.777.387.122 0 .245-.018.357-.051.385-.116.591-.399.537-.738l-.129.021.125-.042c-.204-.606-.431-1.146-.649-1.67-.373-.894-.725-1.742-.891-2.737.407-.042.797-.129 1.161-.261.825.692 1.661 1.492 2.743 3.406h.001c.072.14.224.215.41.215.105 0 .222-.024.339-.073.365-.155.652-.531.477-1.006v-.001c-.432-1.849-1.426-2.778-2.428-3.547.162-.175.311-.366.442-.576.75.399 1.878 1.005 3.127 2.766l.047.067.011-.008c.151.156.317.24.48.24.096 0 .191-.027.279-.084.306-.194.439-.662.29-1.005zm-8.878-2.493c-.947 0-1.713-.767-1.713-1.713s.767-1.713 1.713-1.713c.947 0 1.713.767 1.713 1.713s-.767 1.713-1.713 1.713zm6.587 4.648l-.084.021v-.001l.084-.02zm-2.007-5.312zm.022 1.006zM11.225 11.604c0 .385-.312.697-.697.697s-.697-.312-.697-.697c0-.385.312-.697.697-.697s.697.312.697.697z"/></svg>
            </span>
        </a>

        <div class="media-obj__body media-obj__body_user-info">
              <a href="https://habr.com/ru/info/help/karma/" class="user-info__stats-item stacked-counter" title="7 голосов">
                <div class="stacked-counter__value stacked-counter__value_green ">7,0</div>
                <div class="stacked-counter__label">Карма</div>
              </a>

            <a href="https://habr.com/ru/info/help/karma/#rating" class="user-info__stats-item stacked-counter stacked-counter_rating" title="Рейтинг пользователя">
              <div class="stacked-counter__value stacked-counter__value_magenta">25,0</div>
              <div class="stacked-counter__label">Рейтинг</div>
            </a>
        </div>
      </div>

  </div>

  <div class="user-info__about">
    <div class="user-info__links">
        <a href="/users/makurus/" class="user-info__nickname user-info__nickname_doggy" onclick="if (typeof ga === 'function') { ga('send', 'event', 'author_info_top', 'profile', 'makurus');}">makurus</a>
        
    </div>

      <div class="user-info__specialization">Пользователь</div>
  </div>
</div>

<div class="overlay hidden" id="js-donate">
  <div class="popup">
    <div class="popup__head popup__head_lang-settings">
      <span class="popup__head-title js-popup_title" data-section="1">Платежная система</span>
      <button type="button" class="btn btn_small btn_popup-close js-hide-donate">
        <svg class="icon-svg" width="12" height="12">
          <use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#close" />
        </svg>
      </button>
    </div>
    <div class="popup__body js-donate-popup_body">
    </div>
  </div>
</div>


              </div>
              
            </div>
            
        </div>

          

    <div class="default-block default-block_content">
      <div class="default-block__header default-block__header_large">
        <h2 class="default-block__header-title default-block__header-title_large">Похожие публикации</h2>
      </div>
      <div class="default-block__content">

        <ul class="content-list">
            <li class="content-list__item content-list__item_devided post-info">
              <span class="post-info__date">8 февраля 2023 в 17:09</span>
                <h3 class="post-info__title post-info__title_large">
                  <a href="https://habr.com/ru/post/715144/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block', 'similar_posts', 'common', '1'); }">
                    Приглашаем на Ozon Tech Community Design Meetup. Дизайн продукта: путь до прода
                  </a>
                </h3>

              <div class="post-info__meta">
                <span class="post-info__meta-item" title="Рейтинг">
                  <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg>
                      <span class="post-info__meta-counter">29</span>
                </span>
                <span class="post-info__meta-item" title="Количество просмотров">
                  <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">3,3k</span>
                </span>
                <span class="post-info__meta-item" title="Закладки">
                  <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">15</span>
                </span>
                <a href="https://habr.com/ru/post/715144#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                  <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">5
                    
                  </span>
                </a>
              </div>
            </li>
            <li class="content-list__item content-list__item_devided post-info">
              <span class="post-info__date">3 февраля 2023 в 16:49</span>
                <h3 class="post-info__title post-info__title_large">
                  <a href="https://habr.com/ru/post/714716/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block', 'similar_posts', 'common', '2'); }">
                    Приглашаем на Ozon Tech Community Mobile Meetup
                  </a>
                </h3>

              <div class="post-info__meta">
                <span class="post-info__meta-item" title="Рейтинг">
                  <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg>
                      <span class="post-info__meta-counter">15</span>
                </span>
                <span class="post-info__meta-item" title="Количество просмотров">
                  <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">790</span>
                </span>
                <span class="post-info__meta-item" title="Закладки">
                  <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">3</span>
                </span>
                <a href="https://habr.com/ru/post/714716#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                  <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">0
                    
                  </span>
                </a>
              </div>
            </li>
            <li class="content-list__item content-list__item_devided post-info">
              <span class="post-info__date">20 января 2023 в 18:30</span>
                <h3 class="post-info__title post-info__title_large">
                  <a href="https://habr.com/ru/post/711838/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block', 'similar_posts', 'common', '3'); }">
                    Приглашаем на Ozon Tech Community A/B-testing Meetup
                  </a>
                </h3>

              <div class="post-info__meta">
                <span class="post-info__meta-item" title="Рейтинг">
                  <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg>
                      <span class="post-info__meta-counter">16</span>
                </span>
                <span class="post-info__meta-item" title="Количество просмотров">
                  <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">1k</span>
                </span>
                <span class="post-info__meta-item" title="Закладки">
                  <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">8</span>
                </span>
                <a href="https://habr.com/ru/post/711838#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                  <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">4
                    
                  </span>
                </a>
              </div>
            </li>
        </ul>

      </div>
    </div>

        
        



            <div class="comments-section" id="comments">
    <header class="comments-section__head">
      <h2 class="comments-section__head-title">
        Комментарии
        <span class="comments-section__head-counter" id="comments_count">
          1
        </span>
      </h2>
      
    </header>
    
    

    <ul class="content-list content-list_comments" id="comments-list">
        <li class="content-list__item content-list__item_comment js-comment " rel="25329152">
    
    <span class="parent_id" data-parent_id="0"></span>
    <div class="comment" id="comment_25329152">
      <span class="comment__collapse" title="Свернуть/развернуть ветку комментариев" data-id="25329152"></span>
        <span class="comment__folding-dotholder"></span>
        <div class="comment__head   " rel="25329152">
          <a href="https://habr.com/ru/users/TerAnYu/" class="user-info user-info_inline"  data-user-login="TerAnYu">
  <div class="user-comment__container user-info__image-pic user-info__image-pic_small">
      <img src="//habrastorage.org/getpro/habr/avatars/19f/1f2/9bc/19f1f29bc16c0e32f4a07e05a0d22e61.jpg" class="user-info__image-pic user-info__image-pic_small" width="24" height="24" />
  </div>
  <span class="user-info__nickname user-info__nickname_small user-info__nickname_comment">TerAnYu</span>
</a>

          
          <time class="comment__date-time comment__date-time_published">сегодня в 16:16</time>
          <ul class="inline-list inline-list_comment-nav">
  <li class="inline-list__item inline-list__item_comment-nav">
    <a href="#comment_25329152" class="icon_comment-anchor" title="Ссылка на комментарий"><svg width="12" height="12"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#anchor" /></svg></a>
  </li>

    <li class="inline-list__item inline-list__item_comment-nav">
      <button class="icon_comment-bookmark " onclick="return comments_add_to_favorite(this)" data-type="3" data-id="25329152" data-action="add" title="Только зарегистрированные пользователи могут добавлять комментарии в избранное" disabled><svg width="12" height="12"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg></button>
    </li>


  <li class="inline-list__item inline-list__item_comment-nav hidden js-comment_children">
    <a href="#comment_25329152" class="icon_comment-arrow-down js-comment_parent back_to_children" data-id="25329152" data-parent_id="0" title="Вернуться к ответу"><svg width="12" height="12"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#rounded-arrow" /></svg></a>
  </li>
</ul>

           <div class="voting-wjt voting-wjt_comments js-comment-vote" data-id="25329152" data-post-target="722042" data-type="3">
   <button type="button" class="btn voting-wjt__button voting-wjt__button_small " data-action="plus" onclick="comment_vote(this);" title="Голосовать могут только зарегистрированные пользователи" disabled><svg class="icon-svg_arrow-up" width="10" height="16"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#vote-arrow" /></svg></button>

    <span class="voting-wjt__counter voting-wjt__counter_positive  js-score" title="Всего голосов +1: &uarr;1 и &darr;0">+1</span>

    <button type="button" class="btn voting-wjt__button voting-wjt__button_small " data-action="minus" onclick="comment_vote(this);" title="Голосовать могут только зарегистрированные пользователи" disabled><svg class="icon-svg_arrow-down" width="10" height="16"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#vote-arrow" /></svg></button>
  </div>

        </div>

        <div class="comment__message  comment__message_v2  "><p>Любопытно, а можно подробнее про PowerDNS-Admin, почему он чо-то удаляет?</p></div>

        <div class="comment__footer">
</div>

        <div class="comment__reply-form js-form_placeholder"></div>
    </div>

    <ul class="content-list content-list_nested-comments content-list_nested-comments-0" id="reply_comments_25329152"></ul>
  </li>

      
    </ul>
      <div class="js-form_placeholder">
                <p class="for_users_only_msg">Только&nbsp;<a href="/info/help/registration/">полноправные пользователи</a> могут оставлять комментарии. <a href="https://habr.com/ru/auth/login/">Войдите</a>, пожалуйста.</p>

      </div>
  </div>


      </div>
    </div>

    <div class="sidebar">
      <div class="sidebar_right_ad">
        
      </div>
      <div class="sidebar_right sidebar_content-area">
          
  <div class="default-block default-block_sidebar" id="profile-company">
  <div class="default-block__header">
    <h2 class="default-block__header-title">Информация</h2>
  </div>
  <div class="default-block__content default-block__content_profile-summary">
      <ul class="defination-list">
          <li class="defination-list__item defination-list__item_profile-summary">
            <h3 class="defination-list__label defination-list__label_profile-summary">Дата основания</h3>
            <span class="defination-list__value">9 февраля 1998 г.</span>
          </li>

          <li class="defination-list__item defination-list__item_profile-summary">
            <h3 class="defination-list__label defination-list__label_profile-summary">Локация</h3>
            <span class="defination-list__value">
              Москва<br/>Россия
            </span>
          </li>

          <li class="defination-list__item defination-list__item_profile-summary">
            <h3 class="defination-list__label defination-list__label_profile-summary">Сайт</h3>
            <span class="defination-list__value"><a href="https://tech.ozon.ru/" target="_blank" class="defination-list__link" title="https://tech.ozon.ru/">tech.ozon.ru</a></span>
          </li>

          <li class="defination-list__item defination-list__item_profile-summary">
            <h3 class="defination-list__label defination-list__label_profile-summary">Численность</h3>
            <span class="defination-list__value">1 001&#8211;5 000 человек</span>
          </li>

          <li class="defination-list__item defination-list__item_profile-summary">
            <h3 class="defination-list__label defination-list__label_profile-summary">Дата регистрации</h3>
            <span class="defination-list__value">3 декабря 2018 г.</span>
          </li>

      </ul>
  </div>
</div>

  


      <div class="default-block default-block_sidebar" id="widget">
  <div class="default-block__header">
    <h2 class="default-block__header-title">Виджет</h2>
  </div>
  <div class="default-block__content  sidebar-block">
    <div class="sidebar-block__banner">
      <a href="https://app.bugbounty.bi.zone/companies/9/main" class="sidebar-block__banner-link">
        <img src="//habrastorage.org/getpro/habr/widget/ec5/ddf/9d3/ec5ddf9d36e015b5a4e71e9ab593431d.png" class="sidebar-block__banner-image" />
        
      </a>
    </div>

    <div class="sidebar-block__paragraph">
      
    </div>
  </div>
</div>









      <div class="default-block default-block_sidebar" id="widget">
  <div class="default-block__header">
    <h2 class="default-block__header-title">Виджет</h2>
  </div>
  <div class="default-block__content  sidebar-block">
    <div class="sidebar-block__banner">
      <a href="https://bit.ly/3QMNn9a" class="sidebar-block__banner-link">
        <img src="//habrastorage.org/getpro/habr/widget/f4e/ee7/f90/f4eee7f90149270ac978b8e44edb1641.png" class="sidebar-block__banner-image" />
        
      </a>
    </div>

    <div class="sidebar-block__paragraph">
      
    </div>
  </div>
</div>









      <div class="default-block default-block_sidebar" id="widget">
  <div class="default-block__header">
    <h2 class="default-block__header-title">Виджет</h2>
  </div>
  <div class="default-block__content  sidebar-block">
    <div class="sidebar-block__banner">
      <a href="https://route256.ozon.ru/?utm_source=habr&utm_medium=banner&utm_campaign=ozontech" class="sidebar-block__banner-link">
        <img src="//habrastorage.org/getpro/habr/widget/c18/22c/bc3/c1822cbc388c90d27baff28b1a6d7dad.png" class="sidebar-block__banner-image" />
        
      </a>
    </div>

    <div class="sidebar-block__paragraph">
      
    </div>
  </div>
</div>









      <div class="default-block default-block_sidebar" id="widget">
  <div class="default-block__header">
    <h2 class="default-block__header-title">Виджет</h2>
  </div>
  <div class="default-block__content  sidebar-block">
    <div class="sidebar-block__banner">
      <a href="https://bit.ly/3OXSaVe" class="sidebar-block__banner-link">
        <img src="//habrastorage.org/getpro/habr/widget/fce/ad6/52f/fcead652ff3c5688231c2767e1819e5c.png" class="sidebar-block__banner-image" />
        
      </a>
    </div>

    <div class="sidebar-block__paragraph">
      
    </div>
  </div>
</div>













        <div class="default-block default-block_sidebar" id="vk-group">
    <div class="default-block__header">
      <span class="default-block__header-title">ВКонтакте</span>
    </div>
    <div class="default-block__content sidebar-block">
      <script type="text/javascript">
        $(document).ready(function () {
          var el = document.createElement("script");
          el.type = "text/javascript";
          el.src = "https://vk.com/js/api/openapi.js?63";
          el.async = true;
          el.addEventListener("load", checkVKAndInit);
          document.getElementById("vk_api_transport").appendChild(el);

          function checkVKAndInit() {
            if (window.VK && window.VK.Widgets && window.VK.Widgets.Group) {
              VK.Widgets.Group("vk_groups", {mode: 0, width: '260', height: '300'}, 209665992);
            }
          }
        });
      </script>
      <div id="vk_api_transport"></div>
      <div id="vk_groups"></div>
    </div>
  </div>






    <div class="default-block">
    <div class="default-block__header">
      <h2 class="default-block__header-title">Блог на Хабре</h2>
    </div>
    <div class="default-block__content">
      <ul class="content-list">
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/722042/" class="post-info__title">Через реки, через лес прямо к PowerDNS</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">1,2k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/722042/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">1
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/719764/" class="post-info__title">Вспомнить всё: проводим ретроспективы для удалённых команд</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">2,9k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/719764/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">32
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/717856/" class="post-info__title">Делаем отказоустойчивый Asterisk realtime</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">3,8k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/717856/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">11
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/715144/" class="post-info__title">Приглашаем на Ozon Tech Community Design Meetup. Дизайн продукта: путь до прода</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">3,3k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/715144/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">5
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/714716/" class="post-info__title">Приглашаем на Ozon Tech Community Mobile Meetup</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">790</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/714716/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">0
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/712928/" class="post-info__title">Краткий гайд по эргономике для трудяг IT-индустрии</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">10,7k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/712928/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">18
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/712306/" class="post-info__title">Шесть причин, почему ваши A/B-тесты не работают</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">10,3k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/712306/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">19
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/711838/" class="post-info__title">Приглашаем на Ozon Tech Community A/B-testing Meetup</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">1k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/711838/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">4
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/711428/" class="post-info__title">Что такое фаззинг и зачем он нужен?</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">6k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/711428/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">7
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/710418/" class="post-info__title">Приглашаем на Ozon Tech Community QA (Python) Meetup</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">1,9k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/710418/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">0
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/708274/" class="post-info__title">Одна платформа, чтобы править всеми</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">16,8k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/708274/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">41
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/708162/" class="post-info__title">Дизайн-долг платежом красен: улучшаем таблицы в большом продукте</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">6,9k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/708162/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">13
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/707092/" class="post-info__title">Как починить QA-отдел, или Ещё один переезд в Go</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">5,1k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/707092/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">6
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/705912/" class="post-info__title">База по шардированию базы</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">11,5k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/705912/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">19
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/703768/" class="post-info__title">Приглашаем на Ozon Tech Community Go Meetup</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">1,9k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/703768/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">1
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/703094/" class="post-info__title">Приглашаем на Ozon Tech Community Platform Meetup</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">1,1k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/703094/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">4
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/702308/" class="post-info__title">Чем программисту заняться в 1990 году: осваиваем чёрную магию ассемблера</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">23,9k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/702308/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">161
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/701198/" class="post-info__title">Рассматриваем под лупой отладчик Delve для Go-разработчиков</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">5k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/701198/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">0
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/699984/" class="post-info__title">Смешать, но не взбалтывать: добавляем видеообложки в ленту товаров</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">3k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/699984/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">7
                  
                </span>
              </a>
            </div>
          </li>
          <li class="content-list__item content-list__item_devided post-info">
              <h3 class="post-info__title">
                <a href="https://habr.com/ru/company/ozontech/blog/695868/" class="post-info__title">Делаем документацию здорового человека в Git на примере Docs Ozon</a>
              </h3>
            <div class="post-info__meta">
              <span class="post-info__meta-item" title="Количество просмотров">
                <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">27,6k</span>
              </span>

              <a href="https://habr.com/ru/company/ozontech/blog/695868/#comments" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter post-info__meta-counter_small">39
                  
                </span>
              </a>
            </div>
          </li>
      </ul>
    </div>
  </div>

  

      </div>
    </div>
  </div>


  <script type="text/javascript">
    var userLabel = 'reader';
  </script>

        </div>
      </div>

        <div class="layout__row layout__row_promo-blocks">
          <div class="layout__cell">
              <div class="column-wrapper column-wrapper_bottom column-wrapper_bordered">
    <div class="content_left">
      


  <div class="default-block default-block_content">
    <div class="default-block__header default-block__header_large">
      <h2 class="default-block__header-title default-block__header-title_large">Самое читаемое</h2>
    </div>
    <div class="default-block__content default-block__content_most-read" id="broadcast_tabs_posts">
      <ul class="toggle-menu toggle-menu__most-read">
        <li class="toggle-menu__item">
          <a href="#broadcast_posts_today" class="toggle-menu__item-link active" rel="nofollow">Сутки</a>
        </li>
        <li class="toggle-menu__item">
          <a href="#broadcast_posts_week" class="toggle-menu__item-link" rel="nofollow">Неделя</a>
        </li>
        <li class="toggle-menu__item">
          <a href="#broadcast_posts_month" class="toggle-menu__item-link" rel="nofollow">Месяц</a>
        </li>
      </ul>

        <div class="tabs__content tabs__content_reading" id="broadcast_posts_today">
            <ul class="content-list content-list_most-read">
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/news/t/722390/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">OpenAI выпустила GPT-4</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;38</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">32,8k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">18</span>
                    </span>
                    <a href="https://habr.com/ru/news/t/722390/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        117
                        
                      </span>
                    </a>
                  </div>
                </li>
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/post/722330/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">Почему мужикам нужно качать орех?</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;33</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">24,3k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">116</span>
                    </span>
                    <a href="https://habr.com/ru/post/722330/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        119
                        
                      </span>
                    </a>
                  </div>
                </li>
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/company/getmatch/blog/722246/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">Сколько получают российские разработчики: наше исследование</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;96</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">26,2k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">105</span>
                    </span>
                    <a href="https://habr.com/ru/company/getmatch/blog/722246/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        98
                        
                      </span>
                    </a>
                  </div>
                </li>
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/company/bastion/blog/721986/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">Вас похекали! Как мы приносим клиентам дурные вести из Даркнета</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;49</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">19,5k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">96</span>
                    </span>
                    <a href="https://habr.com/ru/company/bastion/blog/721986/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        45
                        
                      </span>
                    </a>
                  </div>
                </li>
            </ul>
        </div>
        <div class="tabs__content tabs__content_reading" id="broadcast_posts_week">
            <ul class="content-list content-list_most-read">
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/post/721646/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">Мнение: DevOps — это раковая опухоль</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;174</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">62,4k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">112</span>
                    </span>
                    <a href="https://habr.com/ru/post/721646/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        405
                        
                      </span>
                    </a>
                  </div>
                </li>
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/post/721742/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">Крах Silicon Valley Bank: как и почему лопнул главный банк техно-стартаперов Кремниевой долины</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;116</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">51,4k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">52</span>
                    </span>
                    <a href="https://habr.com/ru/post/721742/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        81
                        
                      </span>
                    </a>
                  </div>
                </li>
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/post/721644/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">GPT-3. Есть проблема побольше, чем потеря рабочих мест</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;109</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">50,6k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">117</span>
                    </span>
                    <a href="https://habr.com/ru/post/721644/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        529
                        
                      </span>
                    </a>
                  </div>
                </li>
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/post/721512/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">Странная функция Telegram</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;103</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">44,1k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">87</span>
                    </span>
                    <a href="https://habr.com/ru/post/721512/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        112
                        
                      </span>
                    </a>
                  </div>
                </li>
            </ul>
        </div>
        <div class="tabs__content tabs__content_reading" id="broadcast_posts_month">
            <ul class="content-list content-list_most-read">
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/post/497464/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">Всё, что вы НЕ хотели бы знать о сервисах онлайн знакомств… [много букОв и иллюстраций + регулярно дополняется]</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;269</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">112k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">373</span>
                    </span>
                    <a href="https://habr.com/ru/post/497464/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        760
                        
                      </span>
                    </a>
                  </div>
                </li>
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/company/productivity_inside/blog/717108/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">20 уроков, которые я вынес из 20 лет работы программистом</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;150</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">98,6k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">446</span>
                    </span>
                    <a href="https://habr.com/ru/company/productivity_inside/blog/717108/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        115
                        
                      </span>
                    </a>
                  </div>
                </li>
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/post/718996/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">О «раздутом пузыре» нейросетей</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;131</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">84,6k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">237</span>
                    </span>
                    <a href="https://habr.com/ru/post/718996/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        171
                        
                      </span>
                    </a>
                  </div>
                </li>
                <li class="content-list__item content-list__item_devided post-info">
                  <a href="https://habr.com/ru/post/718308/" class="post-info__title post-info__title_large" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'post'); }">Судя по новым данным, фундаментальная модель Вселенной неверна</a>
                  <div class="post-info__meta">
                    <span class="post-info__meta-item" title="Рейтинг">
                      <svg class="post-info__meta-icon icon-svg_rating" width="11" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#arrow-bold" /></svg><span class="post-info__meta-counter">&plus;74</span>
                    </span>
                    <span class="post-info__meta-item" title="Количество просмотров">
                      <svg class="post-info__meta-icon icon-svg_views" width="16" height="9"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#eye" /></svg><span class="post-info__meta-counter">79,6k</span>
                    </span>
                    <span class="post-info__meta-item" title="Закладки">
                      <svg class="post-info__meta-icon icon-svg_bookmark-mini" width="8" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#book" /></svg><span class="post-info__meta-counter">70</span>
                    </span>
                    <a href="https://habr.com/ru/post/718308/#comments" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block',  'most_read,post' , 'comment'); }" class="post-info__meta-item" rel="nofollow" title="Комментарии">
                      <svg class="post-info__meta-icon icon-svg_comments" width="14" height="13"><use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#comment" /></svg><span class="post-info__meta-counter">
                        303
                        
                      </span>
                    </a>
                  </div>
                </li>
            </ul>
        </div>
    </div>
  </div>

    </div>

    <div class="sidebar">
      <div class="sidebar_right">
      </div>
    </div>
  </div>

          </div>
        </div>

      <div class="layout__row layout__row_footer-links">
        <div class="layout__cell">
          <div class="footer-grid footer-grid_menu">
  <div class="footer-grid__item footer-block">
    <h3 class="footer-block__title">
      Ваш аккаунт
    </h3>
    <div class="footer-block__content">
      <ul class="footer-menu">
          <li class="footer-menu__item">
            <a href="https://habr.com/ru/auth/login/" class="footer-menu__item-link">Войти</a>
          </li>
          <li class="footer-menu__item">
            <a href="https://habr.com/ru/auth/register/" class="footer-menu__item-link">Регистрация</a>
          </li>
      </ul>
    </div>
  </div>

  <div class="footer-grid__item footer-block">
    <h3 class="footer-block__title">Разделы</h3>
    <div class="footer-block__content">
      <ul class="footer-menu">
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/posts/top/" class="footer-menu__item-link">Публикации</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/news/" class="footer-menu__item-link">Новости</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/hubs/" class="footer-menu__item-link">Хабы</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/companies/" class="footer-menu__item-link">Компании</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/users/" class="footer-menu__item-link">Пользователи</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/sandbox/" class="footer-menu__item-link">Песочница</a>
        </li>
      </ul>
    </div>
  </div>

  <div class="footer-grid__item footer-block">
    <h3 class="footer-block__title">Информация</h3>
    <div class="footer-block__content">
      <ul class="footer-menu">
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/docs/help/" class="footer-menu__item-link">Устройство сайта</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/docs/authors/" class="footer-menu__item-link">Для авторов</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/docs/companies/" class="footer-menu__item-link">Для компаний</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/docs/docs/" class="footer-menu__item-link">Документы</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://account.habr.com/info/agreement/?hl=ru_RU" class="footer-menu__item-link">Соглашение</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://account.habr.com/info/confidential/?hl=ru_RU" class="footer-menu__item-link">Конфиденциальность</a>
        </li>
      </ul>
    </div>
  </div>

  <div class="footer-grid__item footer-block">
    <h3 class="footer-block__title">Услуги</h3>
    <div class="footer-block__content">
      <ul class="footer-menu">
        <li class="footer-menu__item">
          <a
            href="https://company.habr.com/corporate-blogs/"
            target="_blank"
            class="footer-menu__item-link"
          >Корпоративный блог</a>
        </li>
        <li class="footer-menu__item">
          <a
            href="https://company.habr.com/advertising/"
            target="_blank"
            class="footer-menu__item-link"
          >Медийная реклама</a>
        </li>
        <li class="footer-menu__item">
          <a
            href="https://company.habr.com/native-special/"
            target="_blank"
            class="footer-menu__item-link"
          >Нативные проекты</a>
        </li>
        <li class="footer-menu__item">
          <a
            href="https://company.habr.com/education-programs/"
            target="_blank"
            class="footer-menu__item-link"
          >Образовательные программы</a>
        </li>
        <li class="footer-menu__item">
          <a
            href="https://company.habr.com/hello-startup/"
            target="_blank"
            class="footer-menu__item-link"
          >Стартапам</a>
        </li>
        <li class="footer-menu__item">
          <a href="https://habr.com/ru/megaprojects/" target="_blank" class="footer-menu__item-link">Спецпроекты</a>
        </li>
      </ul>
    </div>
  </div>
</div>


        </div>
      </div>

      <div class="layout__row layout__row_footer">
        <div class="layout__cell">
          <script>
  $(document).ready(function () {
    window.voteReasonsList = JSON.parse('{"1":{"id":"1","title":"Низкий технический уровень материала","order":1},"2":{"id":"2","title":"Больше рекламы, чем пользы","order":2},"3":{"id":"3","title":"Не соответствует тематике Хабра","order":3},"4":{"id":"4","title":"В тексте много ошибок и опечаток","order":4},"5":{"id":"5","title":"Пост небрежно оформлен","order":5},"6":{"id":"6","title":"Личная неприязнь к автору или компании","order":6},"7":{"id":"7","title":"В статье нет новой для меня информации","order":7},"8":{"id":"8","title":"Ничего не понял после прочтения","order":8},"22":{"id":"22","title":"Не согласен с изложенным","order":9},"42":{"id":"42","title":"Кликбейтный заголовок","order":10},"9":{"id":"9","title":"Другое","order":11}}');
    window.userVoteReasonsList = JSON.parse('{"24":{"id":"24","title":"Грубое общение","order":1},"26":{"id":"26","title":"Неконструктивное общение","order":2},"28":{"id":"28","title":"Политика или пропаганда","order":3},"30":{"id":"30","title":"Статья\/тема не для Хабра","order":4},"32":{"id":"32","title":"Распространение рекламы","order":5},"34":{"id":"34","title":"Плохое оформление, ошибки","order":6},"36":{"id":"36","title":"Придерживаюсь другой позиции","order":7},"38":{"id":"38","title":"Подозрительная активность","order":8},"40":{"id":"40","title":"Личная неприязнь","order":9}}');
  });
</script>
<script>

$(document).on('hljsUpdate', function () {
  if (typeof hljs === 'undefined') {
    initHighlightJS();
  } else {
    $('pre code').each(function (i, e) {
      hljs.highlightBlock(e, '    ');
    });
  }
})

function createScript(url) {
  var hljsScript = document.createElement("script");
  hljsScript.src = url;
  hljsScript.type = 'text/javascript';
  document.body.appendChild(hljsScript)

  return hljsScript;
}

function initHighlightJS() {
  if (typeof hljs !== 'undefined') {
    $('pre code').each(function (i, e) {
      hljs.highlightBlock(e, '    ');
    });
    return;
  };

  var hljsScript = createScript('https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/highlight.pack.js');

  hljsScript.onload = function() {
    var hljsLangs = createScript('https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/highlight.langs.js');
    hljsLangs.onload = function () {
      hljs.initHighlighting();
    }
  }
}


var codeElements = document.querySelectorAll('pre code');

if (codeElements.length) {
  initHighlightJS();
}

</script>

<script>
function createScript(url) {
  var swiperScript = document.createElement("script");
  swiperScript.src = url;
  swiperScript.type = 'text/javascript';
  document.body.appendChild(swiperScript)

  return swiperScript;
}

function initGallerySliders() {

  const allGalleries = document.getElementsByClassName('gallery-wrapper');
  const allGalleriesList = [].slice.call(allGalleries);

  var sliders = [];
  var slidersThumbs = [];

  allGalleriesList.forEach((galleryWrapper) => {
    const newThumbsSwiper = new Swiper(galleryWrapper.querySelector('.thumb-gallery'), {
      spaceBetween: 12,
      slidesPerView: 'auto',
      freeMode: true,
      threshold: 10,
      multipleActiveThumbs: false,
      watchSlidesProgress: true,
      observer: true,
      navigation: {
        nextEl: '.swiper-next',
        prevEl: '.swiper-prev',
      },
    });
    slidersThumbs.push(newThumbsSwiper);

    const newSwiper = new Swiper(galleryWrapper.querySelector('.gallery'), {
      // loop: true,
      slidesPerView: 1,
      spaceBetween: 0,
      observer: true,
      observeParents: true,
      watchSlidesProgress: true,
      navigation: {
        nextEl: '.swiper-next',
        prevEl: '.swiper-prev',
      },

      thumbs: {
        swiper: newThumbsSwiper,
      },
    });
    sliders.push(newSwiper);
  });
};


const arrowIcon = '<svg viewbox="0 0 24 24" width="24" height="24"><path fill-rule="evenodd" clip-rule="evenodd" d="M15.7071 4.29289C16.0976 4.68342 16.0976 5.31658 15.7071 5.70711L9.41421 12L15.7071 18.2929C16.0976 18.6834 16.0976 19.3166 15.7071 19.7071C15.3166 20.0976 14.6834 20.0976 14.2929 19.7071L7.29289 12.7071C6.90237 12.3166 6.90237 11.6834 7.29289 11.2929L14.2929 4.29289C14.6834 3.90237 15.3166 3.90237 15.7071 4.29289Z" /></svg>';

function changeGalleriesLayout(allGalleriesList, doc) {
  allGalleriesList.forEach((gallery) => {
    const galleryWrapper = doc.createElement('div');
    galleryWrapper.setAttribute('class', 'gallery-wrapper');

    const mainGallery = gallery.cloneNode(true);

    // main gallery
    const leftArrow = doc.createElement('div');
    leftArrow.innerHTML = arrowIcon;
    leftArrow.setAttribute('class', 'swiper-prev');

    const rightArrow = doc.createElement('div');
    rightArrow.setAttribute('class', 'swiper-next');
    rightArrow.innerHTML = arrowIcon;

    mainGallery.appendChild(leftArrow);
    mainGallery.appendChild(rightArrow);

    const galleryContent = mainGallery.firstChild;
    galleryContent.setAttribute('class', 'swiper-wrapper');
    const allSlides = mainGallery.getElementsByTagName('figure');
    const allSlidesList = [].slice.call(allSlides);
    allSlidesList.forEach((slide) => {
      slide.setAttribute('class', 'swiper-slide');
      slide.firstChild.setAttribute('class', 'swiper-image');
    });

    // thumbnails gallery
    const thumbGallery = mainGallery.cloneNode(true);
    thumbGallery.setAttribute('class', 'thumb-gallery');
    const allThumbsSlides = thumbGallery.getElementsByTagName('figure');
    const allThumbsSlidesList = [].slice.call(allThumbsSlides);
    allThumbsSlidesList.forEach((slide) => {
      slide.firstChild.setAttribute('class', 'swiper-thumb-image swiper-image');
      slide.removeChild(slide.lastChild);
    });
    // doc.insertBefore(thumbGallery, mainGallery);

    galleryWrapper.appendChild(thumbGallery);
    galleryWrapper.appendChild(mainGallery);

    gallery.parentNode.replaceChild(galleryWrapper, gallery);
  });
}

function initSwiper() {
  const allGalleriesList = [].slice.call(galleryElements);
  changeGalleriesLayout(allGalleriesList, document);
  initGallerySliders();
};

function initGalleries() {
  var swiperScr = createScript('https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/swiper.js');

  swiperScr.onload = function() {
    initSwiper();
  }
}


var galleryElements = document.querySelectorAll('.post__text .gallery');

if (galleryElements.length) {
  initGalleries();
}

</script>

<script>

var mathElements = document.getElementsByTagName('math');

function mathJaxConfig() {
  MathJax.Hub.Config({
    showProcessingMessages: false,
    showMathMenu: true,
    tex2jax: {
      inlineMath: [['$inline$','$inline$']],
      displayMath: [['$$display$$','$$display$$']],
      processEscapes: true
    },
    MathMenu: {
      showRenderer: true,
      showContext:  true
    }
  });

  MathJax.Extension.Img2jax = {
    PreProcess: function (element) {
      var hasMath = false;
      var images = element.querySelectorAll('[data-tex]');
      for (var i = images.length - 1; i >= 0; i--) {
        var img = images[i];
        var tex = img.alt.replace(/(\r\n|\n|\r)/gm, " ");
        if (tex && tex[0] === '$'){
          var script = document.createElement("script"); script.type = "math/tex";
          hasMath = true;
          if (img.getAttribute('data-tex') == "display"){script.type += ";mode=display"}
          MathJax.HTML.setScript(script, tex.substring(1,tex.length-1));
          img.parentNode.replaceChild(script,img);
        }
      }
    }
  };

  MathJax.Hub.Register.PreProcessor(["PreProcess", MathJax.Extension.Img2jax]);
}

function mathjaxInit() {
 if (typeof MathJax === 'undefined') {
    var url = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_SVG-full&locale=ru';
    var mathScript = document.createElement("script");
    mathScript.src = url;
    mathScript.type = 'text/javascript';
    document.body.appendChild(mathScript)

    mathScript.onload = function() {
      mathJaxConfig();
    }
  } else {
    mathJaxConfig();
  }
}

if (mathElements.length) {
  mathjaxInit();
}

</script>
<div class="footer-grid footer">
  <div class="footer-grid__item footer-grid__item_copyright">
    <span class="footer__copyright">&copy; 2006 &ndash; 2023 «<a href="https://company.habr.com/" class="footer__link">Habr</a>»</span>
  </div>
  <div class="footer-grid__item footer-grid__item_link footer-grid__item_lang">
    <svg class="icon-svg icon-svg_lang-footer" width="16" height="16">
      <use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#globus-v2" />
    </svg>
    <a href="#" class="footer__link js-show_lang_settings">Настройка языка</a>
  </div>
  <div class="footer-grid__item footer-grid__item_link">
    <a href="https://habr.com/ru/feedback/" class="footer__link">Служба поддержки</a>
  </div>
  <div class="footer-grid__item footer-grid__item_link">
    <a href="/berserk-mode-yarr" class="footer__link">Перейти на новую версию</a>
  </div>

  <div class="footer-grid__item footer-grid__item_social">
    <ul class="social-icons">
      <li class="social-icons__item">
        <a href="https://twitter.com/habr_com"
          class="social-icons__item-link social-icons__item-link_normal social-icons__item-link_twitter"
          target="_blank"
          rel="nofollow noopener noreferrer"
          onclick="if (typeof ga === 'function') { ga('send', 'event', 'footer', 'Social_icons', 'twitter'); }"
        >
          <svg class="icon-svg" aria-hidden="true" aria-labelledby="title" version="1.1" role="img" width="24" height="24" viewBox="0 0 24 24"><path d="M17.414 8.642c-.398.177-.826.296-1.276.35.459-.275.811-.71.977-1.229-.43.254-.905.439-1.41.539-.405-.432-.982-.702-1.621-.702-1.227 0-2.222.994-2.222 2.222 0 .174.019.344.058.506-1.846-.093-3.484-.978-4.579-2.322-.191.328-.301.71-.301 1.117 0 .77.392 1.45.988 1.849-.363-.011-.706-.111-1.006-.278v.028c0 1.077.766 1.974 1.782 2.178-.187.051-.383.078-.586.078-.143 0-.282-.014-.418-.04.282.882 1.103 1.525 2.075 1.542-.76.596-1.718.951-2.759.951-.179 0-.356-.01-.53-.031.983.63 2.15.998 3.406.998 4.086 0 6.321-3.386 6.321-6.321l-.006-.287c.433-.314.81-.705 1.107-1.15z"/></svg>
        </a>
      </li>
      <li class="social-icons__item">
        <a href="https://www.facebook.com/habrahabr.ru"
          class="social-icons__item-link social-icons__item-link_normal social-icons__item-link_facebook"
          target="_blank"
          rel="nofollow noopener noreferrer"
          onclick="if (typeof ga === 'function') { ga('send', 'event', 'footer', 'Social_icons', 'facebook'); }"
        >
          <svg class="icon-svg" aria-hidden="true" aria-labelledby="title" version="1.1" role="img" width="24" height="24" viewBox="0 0 24 24"><path d="M14.889 8.608h-1.65c-.195 0-.413.257-.413.6v1.192h2.063v1.698h-2.063v5.102h-1.948v-5.102h-1.766v-1.698h1.766v-1c0-1.434.995-2.6 2.361-2.6h1.65v1.808z"/></svg>
        </a>
      </li>
        <li class="social-icons__item">
          <a href="https://vk.com/habr"
            class="social-icons__item-link social-icons__item-link_normal social-icons__item-link_vkontakte"
            target="_blank"
            rel="nofollow noopener noreferrer"
            onclick="if (typeof ga === 'function') { ga('send', 'event', 'footer', 'Social_icons', 'vkontakte'); }"
          >
            <svg class="icon-svg" aria-hidden="true" aria-labelledby="title" version="1.1" role="img" width="24" height="24" viewBox="0 0 24 24"><path d="M16.066 11.93s1.62-2.286 1.782-3.037c.054-.268-.064-.418-.343-.418h-1.406c-.322 0-.44.139-.537.343 0 0-.76 1.619-1.685 2.64-.297.33-.448.429-.612.429-.132 0-.193-.11-.193-.408v-2.607c0-.365-.043-.472-.343-.472h-2.254c-.172 0-.279.1-.279.236 0 .343.526.421.526 1.352v1.921c0 .386-.022.537-.204.537-.483 0-1.631-1.663-2.274-3.552-.129-.386-.268-.494-.633-.494h-1.406c-.204 0-.354.139-.354.343 0 .375.44 2.114 2.167 4.442 1.159 1.566 2.683 2.414 4.056 2.414.838 0 1.041-.139 1.041-.494v-1.202c0-.301.118-.429.29-.429.193 0 .534.062 1.33.848.945.901 1.01 1.276 1.525 1.276h1.578c.161 0 .311-.075.311-.343 0-.354-.462-.987-1.17-1.738-.29-.386-.762-.805-.912-.998-.215-.226-.151-.354-.001-.59z"/></svg>
          </a>
        </li>
      <li class="social-icons__item">
        <a href="https://telegram.me/habr_com"
          class="social-icons__item-link social-icons__item-link_normal social-icons__item-link_telegram"
          target="_blank"
          rel="nofollow noopener noreferrer"
          onclick="if (typeof ga === 'function') { ga('send', 'event', 'footer', 'Social_icons', 'telegram'); }"
        >
          <svg class="icon-svg" aria-hidden="true" aria-labelledby="title" version="1.1" role="img" width="24" height="24" viewBox="0 0 24 24"><path d="M17.17 7.621l-10.498 3.699c-.169.059-.206.205-.006.286l2.257.904 1.338.536 6.531-4.796s.189.057.125.126l-4.68 5.062-.27.299.356.192 2.962 1.594c.173.093.397.016.447-.199.058-.254 1.691-7.29 1.728-7.447.047-.204-.087-.328-.291-.256zm-6.922 8.637c0 .147.082.188.197.084l1.694-1.522-1.891-.978v2.416z"/></svg>
        </a>
      </li>
        <li class="social-icons__item">
          <a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w"
            class="social-icons__item-link social-icons__item-link_normal social-icons__item-link_youtube"
            target="_blank"
            rel="nofollow noopener noreferrer"
            onclick="if (typeof ga === 'function') { ga('send', 'event', 'footer', 'Social_icons', 'youtube'); }"
          >
            <svg class="icon-svg" aria-hidden="true" aria-labelledby="title" version="1.1" role="img" width="32" height="32" viewBox="0 0 32 32"><path d="M3.2 0h25.6c1.767 0 3.2 1.433 3.2 3.2v25.6c0 1.767-1.433 3.2-3.2 3.2h-25.6c-1.767 0-3.2-1.433-3.2-3.2v-25.6c0-1.767 1.433-3.2 3.2-3.2zm18.133 16l-10.667-5.333v10.667l10.667-5.333z"/></svg>

          </a>
        </li>
        <li class="social-icons__item">
          <a href="https://zen.yandex.ru/habr"
            class="social-icons__item-link social-icons__item-link_normal social-icons__item-link_zen"
            target="_blank"
            rel="nofollow noopener noreferrer"
            onclick="if (typeof ga === 'function') { ga('send', 'event', 'footer', 'Social_icons', 'zen'); }"
          >
            <svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="30" height="30" rx="3" fill="#2C3036"/>
    <path fill-rule="evenodd" clip-rule="evenodd" d="M26.25 15.1241V14.9998V14.8759C21.2684 14.7252 18.9904 14.6009 17.1735 12.8263C15.3994 11.0098 15.2747 8.73179 15.1243 3.75H15H14.8757C14.7253 8.73179 14.6006 11.0098 12.8264 12.8263C11.0095 14.6009 8.73151 14.7252 3.75 14.8759V14.9998V15.1241C8.73151 15.2748 11.0095 15.3991 12.8264 17.1733C14.6006 18.9903 14.7253 21.2682 14.8757 26.25H15H15.1243C15.2747 21.2682 15.3994 18.9903 17.1735 17.1733C18.9904 15.3991 21.2684 15.2748 26.25 15.1241Z" fill="white"/>
</svg>

          </a>
        </li>
    </ul>
  </div>
</div>

        </div>
      </div>

      <a href="#" class="layout__elevator hidden" id="scroll_to_top" title="Наверх"  onclick="if (typeof ga === 'function') { ga('send', 'event', 'navigation_button', 'down'); }">
        <svg class="icon-svg icon-svg_scroll-up" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" version="1.1" role="img"><path d="M16 0C7.164 0 0 7.164 0 16s7.164 16 16 16 16-7.164 16-16S24.836 0 16 0zm8.412 19.523c-.517.512-1.355.512-1.872 0L16 13.516l-6.54 6.01c-.518.51-1.356.51-1.873 0-.516-.513-.517-1.343 0-1.855l7.476-7.326c.517-.512 1.356-.512 1.873 0l7.476 7.327c.516.513.516 1.342 0 1.854z"/></svg>
      </a>
    </div>

    <div class="overlay hidden" id="js-lang_settings">
  <div class="popup">
    <div class="popup__head popup__head_lang-settings">
      <span class="popup__head-title js-popup_title" data-section="1">Настройка языка</span>
      <button type="button" class="btn btn_small btn_popup-close js-hide_lang_settings">
        <svg class="icon-svg" width="12" height="12">
          <use xlink:href="https://habr.com/oldassets/6411ba2a/images/common-svg-sprite.svg#close" />
        </svg>
      </button>
    </div>
    <div class="popup__body">
      <form action="/json/settings/i18n/" method="post" class="form form_lang-settings" id="lang-settings-form">
        <fieldset class="form__fieldset form__fieldset_thin" data-section="2">
          <legend class="form__legend form__legend_lang-settings js-popup_hl_legend">Интерфейс</legend>
            <div class="form-field form-field_lang-settings">
              <span class="radio radio_custom ">
                <input type="radio" name="hl" id="hl_langs_ru" class="radio__input js-hl_langs" value="ru" checked>
                <label for="hl_langs_ru" class="radio__label radio__label_another">Русский</label>
              </span>
            </div>
            <div class="form-field form-field_lang-settings">
              <span class="radio radio_custom ">
                <input type="radio" name="hl" id="hl_langs_en" class="radio__input js-hl_langs" value="en" >
                <label for="hl_langs_en" class="radio__label radio__label_another">English</label>
              </span>
            </div>
        </fieldset>

        <fieldset class="form__fieldset form__fieldset_thin">
          <legend class="form__legend form__legend_lang-settings js-popup_fl_legend" data-section="3">Язык публикаций</legend>
            <div class="form-field form-field_lang-settings">
              <span class="checkbox checkbox_custom">
                <input type="checkbox" name="fl[]" id="fl_langs_ru" class="checkbox__input js-fl_langs" value="ru" checked>
                <label for="fl_langs_ru" class="checkbox__label checkbox__label_another js-popup_feed_ru">Русский</label>
              </span>
            </div>
            <div class="form-field form-field_lang-settings">
              <span class="checkbox checkbox_custom">
                <input type="checkbox" name="fl[]" id="fl_langs_en" class="checkbox__input js-fl_langs" value="en" >
                <label for="fl_langs_en" class="checkbox__label checkbox__label_another js-popup_feed_en">Английский</label>
              </span>
            </div>
        </fieldset>

        <div class="form__footer form__footer_lang-settings">
          <button type="submit" class="btn btn_blue btn_huge btn_full-width js-popup_save_btn">Сохранить настройки</button>
        </div>
      </form>
    </div>
  </div>
</div>



    <script>
  function composeTeaser(t, blockType) {
    const listener = " onclick=\"if (typeof ga === 'function') { ga('send', 'event', 'tm_block', 'promo,"
      + blockType + "', '"+ t.linkUrl +"'); }\"";
    let teaser = '<li class="megapost-teasers__item teaser">'
    + '<a href="' + t.linkUrl + '" target="_blank" class="teaser__image" rel="nofollow';

    if (t.external) teaser += ' sponsored';

    teaser += '"';

    teaser += listener;

    teaser += '>'
    + '<img src="' + t.imageUrl + '" class="teaser__image-pic"/>'
    + '<div class="megapost-teasers__label">'
    + t.label;

    if (t.external) teaser += `<svg width="11" height="11" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M7.5 0C7.22386 0 7 0.223858 7 0.5C7 0.776142 7.22386 1 7.5 1H9.29289L5.14645 5.14645C4.95118 5.34171 4.95118 5.65829 5.14645 5.85355C5.34171 6.04882 5.65829 6.04882 5.85355 5.85355L10 1.70711V3.5C10 3.77614 10.2239 4 10.5 4C10.7761 4 11 3.77614 11 3.5V0.5C11 0.223858 10.7761 0 10.5 0H7.5ZM0.5 1C0.223858 1 0 1.22386 0 1.5V10.5C0 10.7761 0.223858 11 0.5 11H9.5C9.77614 11 10 10.7761 10 10.5V6C10 5.72386 9.77614 5.5 9.5 5.5C9.22386 5.5 9 5.72386 9 6V10H1V2H5C5.27614 2 5.5 1.77614 5.5 1.5C5.5 1.22386 5.27614 1 5 1H0.5Z" fill="#6667A2"/>
</svg>
`;

    teaser += '</div></a>'
    + '<a href="' + t.linkUrl + '" target="_blank" class="teaser__body" rel="nofollow';

    if (t.external) teaser += ' sponsored';

    teaser += '"';

    teaser += listener;

    teaser += '>'
    + '<h3 class="teaser__body-title">'
    + t.title
    + '</h3></a></li>';

    return teaser;
  }
</script>
    <script type="text/javascript">
  // global vars
  var g_base_url = 'habr.com/ru';
  var g_base_fullurl = 'https://habr.com/ru/';
  var g_tmid_fullurl = 'https://account.habr.com/';
  var g_is_guest = false;
  var g_show_xpanel = false;
  var g_is_enableShortcuts = '1';
  var g_is_ugc_post = '';
  var g_is_company_post = '1';
  var g_current_hl = 'ru';
  var g_current_fl = 'ru';

</script>

    <script src="https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/vendors.bundle.js"></script>
    <script src="https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/main.bundle.js"></script>
        <script src="https://hsto.org/getpro/neuro-habr/2.1.1/neuro-habr.js"></script>

  <script>
  if (window.fetch) {
    var nh = window.neuroHabr;
    var host = 'https://b2b.ainews.kz/api';

    var projectId = '';
    var widgetId = '';

    nh.init(host, projectId, widgetId);

    var articleId = "722042";
    var articleLang = "ru";
    var articleCanonical = document.querySelector("link[rel='canonical']").getAttribute("href");

    if (articleId) {
      nh.send('p_view', articleId, articleCanonical, articleLang);
    }

    var nhState = {
      viewTime: 0,
      interval: null,
      scrolledDown: false,
      likeSent: false,
    };

    var hidden;
    var visibilityChange;

    if (typeof document.hidden !== 'undefined') { // Opera 12.10 and Firefox 18 and later support
      hidden = 'hidden';
      visibilityChange = 'visibilitychange';
    } else if (typeof document.msHidden !== 'undefined') {
      hidden = 'msHidden';
      visibilityChange = 'msvisibilitychange';
    } else if (typeof document.webkitHidden !== 'undefined') {
      hidden = 'webkitHidden';
      visibilityChange = 'webkitvisibilitychange';
    }


    var articleBody = document.querySelector('.post__body') || document.querySelector('.article__body');

    if (articleBody) {
      var MINIMUM_ARTICLE_READ_SECONDS = 10;

      var isInViewport = function(e) {
        if (!e) return false;
        var b = e.getBoundingClientRect();
        return b.top <= window.innerHeight && b.top + b.height >= 0;
      };

      var isAtTheEnd = function(e) {
        if (!e) return false;
        return e.getBoundingClientRect().bottom - window.innerHeight <= 0;
      };

      var hasReadArticle = function() {
        return nhState.scrolledDown && nhState.viewTime >= MINIMUM_ARTICLE_READ_SECONDS;
      };

      function incrementViewTime(e) {
        if (!nhState.likeSent && !nhState.interval) {
          nhState.interval = setInterval(() => {
            if (hasReadArticle()) {
              if (!nhState.likeSent) {
                nhState.likeSent = true;
                nh.send('p_like', articleId, articleCanonical, articleLang);
              }
              clearInterval(nhState.interval);
              nhState.interval = null;
            } else if (isInViewport(e)) {
              nhState.viewTime += 2;
            }
          }, 2000);
        }
      };

      incrementViewTime(articleBody);

      if (typeof document.addEventListener !== 'undefined' && hidden !== undefined) {
        document.addEventListener(visibilityChange, () => {
          if (!hasReadArticle() && !nhState.likeSent) {
            if (document[hidden]) {
              clearInterval(nhState.interval);
              nhState.interval = null;
            } else {
              incrementViewTime(articleBody);
            }
          }
        });

        document.addEventListener('scroll', () => {
          if (!nhState.scrolledDown) {
            if (isAtTheEnd(articleBody)) {
              nhState.scrolledDown = true;
            }
          }
        });
      } else {
        nhState.scrolledDown = true;
      }
    }
  }
  </script>



      <script src="https://dr.habracdn.net/habr/oldassets/6411ba2a/javascripts/check-login.js"></script>
      <script type="text/javascript" src="https://habr.com/ru/viewcount/post/722042/"></script>

    
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
(function(m,e,t,r,i,k,a){
  m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
  m[i].l=1*new Date();
  k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      clickmap:true
      , trackLinks:true
      , accurateTrackBounce:true
    });
</script>
<noscript>
  <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
  </div>
</noscript>
<!-- /Yandex.Metrika counter -->

    <script type="text/javascript">
  function stripUrl(currentUrl, queryParam) {
   return currentUrl.replace(/\?([^#]*)/, function(_, search) {
      var result = search.split('&').map(function(param) {
        var regexp = new RegExp(`^${queryParam}`);
        if (regexp.test(param)) {
          return '';
        }
        return param;
      }).filter(Boolean).join('&');
      return result ? '?' + result : '';
    });
  }

  (function() {
    if (location.search.indexOf('cv') != -1 && history.replaceState) {
      var currentUrl = location.toString();
      var strippedUrl = stripUrl(currentUrl, 'cv');
      history.replaceState({}, '', strippedUrl);
    }
  })();

  function callGA(usesABP) {
    if (typeof window.adb1 === 'undefined') { window.adb1 = 'yes';}
    if (usesABP) { window.adb1 = 'aa'; }

    var user_type = 'guest';

    var page_type = "publish_corp_ru,c_ozontech,h_221,h_6398,h_17708,h_21482";

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-726094-1',  'auto');
        ga('create', 'UA-726094-24', 'auto', {'name': 'HGM', 'allowLinker': true});

    ga('HGM.require', 'linker');
    ga('HGM.linker:autoLink', ['toster.ru', 'habr.com', 'account.habr.com', 'm.habr.com']);

    ga('require', 'displayfeatures');
    ga('set', 'dimension1', user_type); // user type - guest/readonly/habrauser
    ga('set', 'dimension2', page_type);
    ga('set', 'dimension3', 'na');
    ga('set', 'dimension4', window.adb1);
    ga('set', 'dimension6', 'ru');
    ga('set', 'dimension7', 'oldtop');


    (function() {
      var removeUtms = function(){
        var location = window.location;
        if (location.search.indexOf('utm_') != -1 && history.replaceState) {
          var currentUrl = location.toString();
          var strippedUrl = stripUrl(currentUrl, 'utm_');
          history.replaceState({}, '', strippedUrl);
        }
      };
      ga('require', 'GTM-559GVC8');
      ga('send', 'pageview', { 'hitCallback': removeUtms });
    })();

    ga('HGM.set', 'dimension1', user_type);
    ga('HGM.set', 'dimension2', "habrahabr");
    ga('HGM.set', 'dimension4', window.adb1);

    ga('HGM.send', 'pageview');
  }


  if (window.habr_blockers_checker) {
    window.habr_blockers_checker.detectWrapper(callGA);
  } else {
    callGA(false)
  }

</script>

    <!-- Facebook Pixel Code -->
<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=317458588730613&ev=PageView&noscript=1"/>
<!-- End Facebook Pixel Code -->

    <img src="https://vk.com/rtrg?p=VK-RTRG-421343-57vKE" style="position:fixed; left:-999px;" alt=""/>
    
  </body>
</html>
